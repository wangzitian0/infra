# Atlantis Configuration
# Manages Terraform plan/apply through GitHub PR comments

version: 3

# Automerge is disabled for safety
automerge: false

# Parallel plan and apply
parallel_plan: true
parallel_apply: false

# Allowed overrides
allowed_overrides: [workflow, apply_requirements]

# Apply requirements
apply_requirements: [mergeable, approved]

# Projects configuration
projects:
  - name: dev
    dir: terraform/envs/dev
    workspace: dev
    terraform_version: v1.6.0
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: []  # Dev can be applied without approval
    
  - name: test
    dir: terraform/envs/test
    workspace: test
    terraform_version: v1.6.0
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: [approved]
    
  - name: staging
    dir: terraform/envs/staging
    workspace: staging
    terraform_version: v1.6.0
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: [approved, mergeable]
    workflow: staging
    
  - name: prod
    dir: terraform/envs/prod
    workspace: prod
    terraform_version: v1.6.0
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
    apply_requirements: [approved, mergeable]
    workflow: prod

# Workflows
workflows:
  default:
    plan:
      steps:
        - init
        - plan
    apply:
      steps:
        - apply
  
  staging:
    plan:
      steps:
        - init
        - plan:
            extra_args: ["-lock=true"]
    apply:
      steps:
        - run: echo "Applying to staging environment"
        - apply
  
  prod:
    plan:
      steps:
        - init
        - plan:
            extra_args: ["-lock=true"]
    apply:
      steps:
        - run: echo "⚠️  Applying to PRODUCTION environment"
        - run: sleep 5
        - apply

# Repo-level settings
repos:
  - id: /.*/
    allowed_overrides: [workflow]
    allow_custom_workflows: false
    delete_source_branch_on_merge: false
