# Atlantis Repo Configuration
# See: https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html

version: 3

projects:
  # 1. Staging - L3/L4 App Layer Only (enable_infra=false)
  - name: staging
    dir: terraform
    terraform_version: 1.6.6
    workspace: staging
    workflow: staging
    autoplan:
      enabled: false

  # 2. Production - L3/L4 App Layer Only (enable_infra=false)
  - name: prod
    dir: terraform
    terraform_version: 1.6.6
    workspace: prod
    workflow: prod
    autoplan:
      enabled: false

  # 3. Test - L3/L4 App Layer Only (enable_infra=false)
  - name: test
    dir: terraform
    terraform_version: 1.6.6
    workspace: test
    workflow: test
    autoplan:
      enabled: false

  # 4. Shared Infrastructure (L1/L2) - enable_infra=true
  - name: infra
    dir: terraform
    terraform_version: 1.6.6
    workspace: default
    workflow: infra
    autoplan:
      enabled: false

workflows:
  # Create backend config file dynamically to avoid shell quoting issues with endpoints={}
  staging:
    plan:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/staging.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select staging || terraform workspace new staging
        - plan:
            extra_args: ["-var-file=envs/staging.tfvars"]
    apply:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/staging.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select staging || terraform workspace new staging
        - apply:
            extra_args: ["-var-file=envs/staging.tfvars"]

  prod:
    plan:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/prod.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select prod || terraform workspace new prod
        - plan:
            extra_args: ["-var-file=envs/prod.tfvars"]
    apply:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/prod.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select prod || terraform workspace new prod
        - apply:
            extra_args: ["-var-file=envs/prod.tfvars"]

  test:
    plan:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/test.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select test || terraform workspace new test
        - plan:
            extra_args: ["-var-file=envs/test.tfvars"]
    apply:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/test.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select test || terraform workspace new test
        - apply:
            extra_args: ["-var-file=envs/test.tfvars"]

  infra:
    plan:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/terraform.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - plan:
            extra_args: ["-var=enable_infra=true"]
    apply:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/terraform.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - apply:
            extra_args: ["-var=enable_infra=true"]
