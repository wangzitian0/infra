# Atlantis Repo Configuration
# Layer Structure: 1.bootstrap (L1), 2.platform (L2), 3.data (L3), 4.apps (L4)
#
# TF VERSION: Atlantis uses required_version constraint from each layer's versions.tf
# This ensures consistency with .terraform-version (SSOT) used by CI and local dev.

version: 3

# Allow parallel plan execution, apply remains serial
# Prevents plan failure from blocking other PRs
parallel_plan: true
parallel_apply: false

projects:
  # L1: Bootstrap (GitHub Actions only, NOT managed by Atlantis)
  # - name: bootstrap
  #   dir: 1.bootstrap
  #   ... (Disabled - L1 should only be managed by GitHub Actions)

  # L2: Platform (Singleton)
  - name: platform
    dir: 2.platform
    terraform_version: "1.11.0"  # Must match .terraform-version
    workspace: default
    workflow: platform
    autoplan:
      enabled: true

  # L3: Data (per-env)
  - name: data-staging
    dir: 3.data
    terraform_version: "1.11.0"  # Must match .terraform-version
    workspace: staging
    workflow: data
    autoplan:
      enabled: true

  - name: data-prod
    dir: 3.data
    terraform_version: "1.11.0"  # Must match .terraform-version
    workspace: prod
    workflow: data
    autoplan:
      enabled: true

  # L4: Apps (Singleton - control plane only)
  # Multi-env workloads are managed by Kubero Pipeline/Phase, not Terraform workspace
  - name: apps
    dir: 4.apps
    terraform_version: "1.11.0"  # Must match .terraform-version
    workspace: default
    workflow: apps
    autoplan:
      enabled: true

workflows:
  # L2: Platform (Terragrunt-managed)
  # NOTE: Platform is a singleton (no per-env tfvars). Config is read from L1 state.
  # Backend configuration is generated by Terragrunt from root terragrunt.hcl
  platform:
    plan:
      steps:
        - run: echo "infra-flash-commit:$(git rev-parse --short ${HEAD_COMMIT:-HEAD}) "
        # Install terragrunt if not present (install to /atlantis-data/bin like terraform)
        - run: |
            if ! command -v terragrunt &> /dev/null; then
              echo "Installing terragrunt..."
              wget -q -O /atlantis-data/bin/terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.96.1/terragrunt_linux_amd64
              chmod +x /atlantis-data/bin/terragrunt
              terragrunt --version
            else
              echo "Terragrunt already installed: $(terragrunt --version)"
            fi
        # Remove stale resources from L2 state (idempotent)
        - run: |
            terraform state rm kubernetes_namespace.platform 2>/dev/null || true
        # Use terragrunt instead of terraform - it will auto-generate backend.tf
        # Set TERRAGRUNT_TFPATH to use terraform instead of tofu (default)
        - run: TERRAGRUNT_TFPATH=/atlantis-data/bin/terraform1.11.0 terragrunt plan -input=false -out=$PLANFILE
    apply:
      steps:
        - run: echo "infra-flash-commit:$(git rev-parse --short ${HEAD_COMMIT:-HEAD}) "
        # Install terragrunt if not present (apply might run in different container)
        - run: |
            if ! command -v terragrunt &> /dev/null; then
              echo "Installing terragrunt..."
              wget -q -O /atlantis-data/bin/terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v0.96.1/terragrunt_linux_amd64
              chmod +x /atlantis-data/bin/terragrunt
            fi
        - run: TERRAGRUNT_TFPATH=/atlantis-data/bin/terraform1.11.0 terragrunt apply -input=false $PLANFILE

  # L3: Data
  data:
    plan:
      steps:
        - run: echo "infra-flash-commit:$(git rev-parse --short ${HEAD_COMMIT:-HEAD}) "
        - run: |
            printf 'bucket    = "%s"\n' "${R2_BUCKET}" > backend.tfvars.new
            printf 'key       = "k3s/data-%s.tfstate"\n' "${WORKSPACE}" >> backend.tfvars.new
            printf 'endpoints = { s3 = "https://%s.r2.cloudflarestorage.com" }\n' "${R2_ACCOUNT_ID}" >> backend.tfvars.new
            if [ ! -f backend.tfvars ] || ! cmp -s backend.tfvars backend.tfvars.new; then
              echo "Backend config changed or missing. Reinitializing..."
              rm -rf .terraform
              mv backend.tfvars.new backend.tfvars
            else
              echo "Backend config unchanged. Keeping cache."
              rm backend.tfvars.new
            fi
        - init:
            extra_args: ["-backend-config=backend.tfvars"]
        - run: terraform workspace select ${WORKSPACE} || terraform workspace new ${WORKSPACE}
        - plan
    apply:
      steps:
        # Reuse .terraform from plan step to avoid state lineage mismatch
        - run: echo "infra-flash-commit:$(git rev-parse --short ${HEAD_COMMIT:-HEAD}) "
        - apply

  # L4: Apps (Singleton like L2)
  apps:
    plan:
      steps:
        - run: echo "infra-flash-commit:$(git rev-parse --short ${HEAD_COMMIT:-HEAD}) "
        - run: |
            printf 'bucket    = "%s"\n' "${R2_BUCKET}" > backend.tfvars.new
            printf 'key       = "k3s/apps.tfstate"\n' >> backend.tfvars.new
            printf 'endpoints = { s3 = "https://%s.r2.cloudflarestorage.com" }\n' "${R2_ACCOUNT_ID}" >> backend.tfvars.new
            if [ ! -f backend.tfvars ] || ! cmp -s backend.tfvars backend.tfvars.new; then
              echo "Backend config changed or missing. Reinitializing..."
              rm -rf .terraform
              mv backend.tfvars.new backend.tfvars
            else
              echo "Backend config unchanged. Keeping cache."
              rm backend.tfvars.new
            fi
        - init:
            extra_args: ["-backend-config=backend.tfvars"]
        - run: terraform workspace select ${WORKSPACE} || terraform workspace new ${WORKSPACE}
        - plan
    apply:
      steps:
        - run: echo "infra-flash-commit:$(git rev-parse --short ${HEAD_COMMIT:-HEAD}) "
        - apply
