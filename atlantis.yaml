# Atlantis Repo Configuration
# See: https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html

version: 3

projects:
  # 1. Staging - L3/L4 App Layer Only (enable_infra=false)
  - name: staging
    dir: terraform
    terraform_version: 1.6.6
    workspace: staging
    workflow: staging
    autoplan:
      enabled: false

  # 2. Production - L3/L4 App Layer Only (enable_infra=false)
  - name: prod
    dir: terraform
    terraform_version: 1.6.6
    workspace: prod
    workflow: prod
    autoplan:
      enabled: false

  # 3. Test - L3/L4 App Layer Only (enable_infra=false)
  - name: test
    dir: terraform
    terraform_version: 1.6.6
    workspace: test
    workflow: test
    autoplan:
      enabled: false

  # 4. Shared Infrastructure (L1/L2) - enable_infra=true
  - name: infra
    dir: terraform
    terraform_version: 1.6.6
    workspace: default
    workflow: infra
    autoplan:
      enabled: false

workflows:
  # Use pure 'run' steps to avoid Atlantis auto-init in plan/apply steps
  staging:
    plan:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/staging.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select staging || terraform workspace new staging
        - run: terraform plan -input=false -refresh -var-file=envs/staging.tfvars -out=$PLANFILE
    apply:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/staging.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select staging
        - run: terraform apply -input=false $PLANFILE

  prod:
    plan:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/prod.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select prod || terraform workspace new prod
        - run: terraform plan -input=false -refresh -var-file=envs/prod.tfvars -out=$PLANFILE
    apply:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/prod.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select prod
        - run: terraform apply -input=false $PLANFILE

  test:
    plan:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/test.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select test || terraform workspace new test
        - run: terraform plan -input=false -refresh -var-file=envs/test.tfvars -out=$PLANFILE
    apply:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/test.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform workspace select test
        - run: terraform apply -input=false $PLANFILE

  infra:
    plan:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/terraform.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform plan -input=false -refresh -var=enable_infra=true -out=$PLANFILE
    apply:
      steps:
        - run: |
            cat > backend.hcl <<EOF
            bucket = "${R2_BUCKET}"
            key = "k3s/terraform.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - run: terraform init -input=false -reconfigure -backend-config=backend.hcl
        - run: terraform apply -input=false $PLANFILE
