# Atlantis Repo Configuration
# See: https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html

version: 3

projects:
  # 1. Staging (Default) - App Layer Only
  - name: staging
    dir: terraform
    workspace: staging
    workflow: staging
    autoplan:
      enabled: false

  # 2. Production - App Layer Only
  - name: prod
    dir: terraform
    workspace: prod
    workflow: prod
    autoplan:
      enabled: false

  # 3. Test - App Layer Only
  - name: test
    dir: terraform
    workspace: test
    workflow: test
    autoplan:
      enabled: false

  # 4. Shared Infrastructure (L1/L2)
  - name: infra
    dir: terraform
    workspace: default
    workflow: infra
    autoplan:
      enabled: false

workflows:
  # Base workflow template for App Layers (Staging/Prod/Test)
  # Injects specific backend key and disables shared infra modules
  staging:
    plan:
      steps:
        - init:
            extra_args: ["-backend-config=bucket=$R2_BUCKET", "-backend-config=key=k3s/staging.tfstate", "-backend-config=endpoints={s3=\"https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com\"}"]
        - plan:
            extra_args: ["-var-file=envs/staging.tfvars"]
    apply:
      steps:
        - init:
            extra_args: ["-backend-config=bucket=$R2_BUCKET", "-backend-config=key=k3s/staging.tfstate", "-backend-config=endpoints={s3=\"https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com\"}"]
        - apply:
            extra_args: ["-var-file=envs/staging.tfvars"]

  prod:
    plan:
      steps:
        - init:
            extra_args: ["-backend-config=bucket=$R2_BUCKET", "-backend-config=key=k3s/prod.tfstate", "-backend-config=endpoints={s3=\"https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com\"}"]
        - plan:
            extra_args: ["-var-file=envs/prod.tfvars"]
    apply:
      steps:
        - init:
            extra_args: ["-backend-config=bucket=$R2_BUCKET", "-backend-config=key=k3s/prod.tfstate", "-backend-config=endpoints={s3=\"https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com\"}"]
        - apply:
            extra_args: ["-var-file=envs/prod.tfvars"]

  test:
    plan:
      steps:
        - init:
            extra_args: ["-backend-config=bucket=$R2_BUCKET", "-backend-config=key=k3s/test.tfstate", "-backend-config=endpoints={s3=\"https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com\"}"]
        - plan:
            extra_args: ["-var-file=envs/test.tfvars"]
    apply:
      steps:
        - init:
            extra_args: ["-backend-config=bucket=$R2_BUCKET", "-backend-config=key=k3s/test.tfstate", "-backend-config=endpoints={s3=\"https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com\"}"]
        - apply:
            extra_args: ["-var-file=envs/test.tfvars"]

  infra:
    plan:
      steps:
        # Infra workflow needs SSH setup for Kubeconfig (handled by custom script in repo or standard action if running in GHA)
        # Assuming Atlantis environment has SSH keys or capabilities.
        - init:
            extra_args: ["-backend-config=bucket=$R2_BUCKET", "-backend-config=key=k3s/terraform.tfstate", "-backend-config=endpoints={s3=\"https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com\"}"]
        - plan:
            extra_args: ["-var=enable_infra=true"]
    apply:
      steps:
        - init:
            extra_args: ["-backend-config=bucket=$R2_BUCKET", "-backend-config=key=k3s/terraform.tfstate", "-backend-config=endpoints={s3=\"https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com\"}"]
        - apply:
            extra_args: ["-var=enable_infra=true"]
