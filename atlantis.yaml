# Atlantis Repo Configuration
# Based on official docs: https://www.runatlantis.io/docs/custom-workflows.html#custom-backend-config
#
# Key points from docs:
# 1. Use `rm -rf .terraform` to clear state between different backend configs
# 2. Use `init: extra_args: [-backend-config=xxx.tfvars]` for backend config
# 3. Use `$WORKSPACE` environment variable for workspace
# 4. Use `$PLANFILE` for plan output

version: 3

projects:
  # Staging - L3/L4 App Layer Only (enable_infra=false in tfvars)
  - name: staging
    dir: terraform
    terraform_version: 1.6.6
    workspace: staging
    workflow: staging
    autoplan:
      enabled: false

  # Production - L3/L4 App Layer Only
  - name: prod
    dir: terraform
    terraform_version: 1.6.6
    workspace: prod
    workflow: prod
    autoplan:
      enabled: false

  # Test - L3/L4 App Layer Only
  - name: test
    dir: terraform
    terraform_version: 1.6.6
    workspace: test
    workflow: test
    autoplan:
      enabled: false

  # Shared Infrastructure (L1) - Bootstrap
  - name: infra
    dir: terraform
    terraform_version: 1.6.6
    workspace: default
    workflow: infra
    autoplan:
      enabled: false

  # Platform (L2) - Managed by Atlantis
  - name: platform
    dir: terraform/layer2-platform
    terraform_version: 1.6.6
    workspace: default
    workflow: platform
    autoplan:
      enabled: false

workflows:
  # Following official Atlantis pattern:
  # https://www.runatlantis.io/docs/custom-workflows.html#custom-backend-config
  
  staging:
    plan:
      steps:
        # Step 1: Clear .terraform to allow backend config change (per official docs)
        - run: rm -rf .terraform
        # Step 2: Generate backend config with actual values from env vars
        - run: |
            cat > envs/staging.backend.tfvars <<EOF
            bucket    = "${R2_BUCKET}"
            key       = "k3s/staging.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        # Step 3: Init with backend config file (official pattern)
        - init:
            extra_args: ["-backend-config=envs/staging.backend.tfvars"]
        # Step 4: Plan with tfvars
        - plan:
            extra_args: ["-var-file=envs/staging.tfvars"]
    apply:
      steps:
        - run: rm -rf .terraform
        - run: |
            cat > envs/staging.backend.tfvars <<EOF
            bucket    = "${R2_BUCKET}"
            key       = "k3s/staging.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - init:
            extra_args: ["-backend-config=envs/staging.backend.tfvars"]
        - apply

  prod:
    plan:
      steps:
        - run: rm -rf .terraform
        - run: |
            cat > envs/prod.backend.tfvars <<EOF
            bucket    = "${R2_BUCKET}"
            key       = "k3s/prod.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - init:
            extra_args: ["-backend-config=envs/prod.backend.tfvars"]
        - plan:
            extra_args: ["-var-file=envs/prod.tfvars"]
    apply:
      steps:
        - run: rm -rf .terraform
        - run: |
            cat > envs/prod.backend.tfvars <<EOF
            bucket    = "${R2_BUCKET}"
            key       = "k3s/prod.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - init:
            extra_args: ["-backend-config=envs/prod.backend.tfvars"]
        - apply

  test:
    plan:
      steps:
        - run: rm -rf .terraform
        - run: |
            cat > envs/test.backend.tfvars <<EOF
            bucket    = "${R2_BUCKET}"
            key       = "k3s/test.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - init:
            extra_args: ["-backend-config=envs/test.backend.tfvars"]
        - plan:
            extra_args: ["-var-file=envs/test.tfvars"]
    apply:
      steps:
        - run: rm -rf .terraform
        - run: |
            cat > envs/test.backend.tfvars <<EOF
            bucket    = "${R2_BUCKET}"
            key       = "k3s/test.tfstate"
            endpoints = { s3 = "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" }
            EOF
        - init:
            extra_args: ["-backend-config=envs/test.backend.tfvars"]
        - apply

  infra:
    plan:
      steps:
        - run: rm -rf .terraform
        - run: ../scripts/atlantis-setup.sh
        - init:
            extra_args: ["-backend-config=backend.tfvars"]
        - plan:
            extra_args: ["-var=enable_infra=true"]
    apply:
      steps:
        - run: rm -rf .terraform
        - run: ../scripts/atlantis-setup.sh
        - init:
            extra_args: ["-backend-config=backend.tfvars"]
        - apply:
            extra_args: ["-var=enable_infra=true"]

  platform:
    plan:
      steps:
        - run: rm -rf .terraform
        - run: ../../scripts/atlantis-setup.sh ../../envs/platform.backend.tfvars.template
        - init:
            extra_args: ["-backend-config=backend.tfvars"]
        - plan:
            # Pass L1/L2 logic if needed, or module defaults handle it
            extra_args: []
    apply:
      steps:
        - run: rm -rf .terraform
        - run: ../../scripts/atlantis-setup.sh ../../envs/platform.backend.tfvars.template
        - init:
            extra_args: ["-backend-config=backend.tfvars"]
        - apply:
            extra_args: []
