#!/usr/bin/env bash
set -euo pipefail

echo "[k3s] Installing with channel=${k3s_channel} version=${effective_version}"

curl -sfL https://get.k3s.io \
  | INSTALL_K3S_CHANNEL="${k3s_channel}" \
    INSTALL_K3S_VERSION="${k3s_version}" \
    INSTALL_K3S_EXEC="server --write-kubeconfig-mode 644 --node-name ${cluster_name} --tls-san ${api_endpoint} ${disable_flags}" \
    sh -

# Make the kubeconfig usable from outside the VPS.
sudo sed -i "s/127.0.0.1/${api_endpoint}/g" /etc/rancher/k3s/k3s.yaml
sudo systemctl enable k3s
sudo systemctl restart k3s
sudo kubectl --kubeconfig /etc/rancher/k3s/k3s.yaml get nodes
