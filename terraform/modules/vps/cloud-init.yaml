#cloud-config
# Cloud-init configuration for VPS bootstrapping

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - docker.io
  - docker-compose
  - ufw
  - fail2ban
  - htop
  - vim

# Enable Docker service
runcmd:
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ubuntu
  
  # Install Dokploy
  - curl -sSL https://dokploy.com/install.sh | sh
  
  # Configure firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 3000/tcp  # Dokploy UI
  - ufw --force enable
  
  # Configure fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

# Set timezone
timezone: UTC

# Create swap file (2GB)
swap:
  filename: /swapfile
  size: 2147483648
  maxsize: 2147483648

write_files:
  - path: /etc/environment
    content: |
      PEG_ENV=${environment}
      PROJECT_NAME=${project_name}
    append: true

final_message: "VPS setup completed for ${project_name} ${environment} environment"
