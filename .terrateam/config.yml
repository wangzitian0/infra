# Terrateam Configuration
version: "1"

when_modified:
  file_patterns:
    - "terraform/**/*.tf"
    - "terraform/**/*.tfvars"
    - ".terrateam/config.yml"
  autoplan: true

# Pre-hooks for SSH and Kubeconfig setup
hooks:
  plan:
    pre:
      - type: run
        cmd:
          - /bin/bash
          - -c
          - |
            set -euo pipefail
            # Setup SSH
            mkdir -p ~/.ssh
            echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -p "${VPS_SSH_PORT:-22}" "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
            
            # Fetch Kubeconfig
            KUBECONFIG_PATH="terraform/output/${CLUSTER_NAME:-truealpha-k3s}-kubeconfig.yaml"
            mkdir -p "$(dirname "$KUBECONFIG_PATH")"
            if ssh -i ~/.ssh/id_rsa -p "${VPS_SSH_PORT:-22}" -o StrictHostKeyChecking=no "root@$VPS_HOST" "sudo cat /etc/rancher/k3s/k3s.yaml" > "$KUBECONFIG_PATH" 2>/dev/null; then
              sed -i "s/127.0.0.1/$VPS_HOST/g" "$KUBECONFIG_PATH"
              chmod 600 "$KUBECONFIG_PATH"
              echo "Kubeconfig fetched successfully."
            else
              echo "Warning: Could not fetch kubeconfig (normal for first-time bootstrap)."
              rm -f "$KUBECONFIG_PATH" || true
            fi
        env:
          - name: VPS_HOST
            cmd: ['echo', '${{ secrets.VPS_HOST }}']
          - name: VPS_SSH_KEY
            cmd: ['echo', '${{ secrets.VPS_SSH_KEY }}']
          - name: VPS_SSH_PORT
            cmd: ['echo', '${{ secrets.VPS_SSH_PORT }}']
          - name: CLUSTER_NAME
            cmd: ['echo', '${{ secrets.K3S_CLUSTER_NAME }}']
  apply:
    pre:
      - type: run
        cmd:
          - /bin/bash
          - -c
          - |
            set -euo pipefail
            mkdir -p ~/.ssh
            echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -p "${VPS_SSH_PORT:-22}" "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
            
            KUBECONFIG_PATH="terraform/output/${CLUSTER_NAME:-truealpha-k3s}-kubeconfig.yaml"
            mkdir -p "$(dirname "$KUBECONFIG_PATH")"
            if ssh -i ~/.ssh/id_rsa -p "${VPS_SSH_PORT:-22}" -o StrictHostKeyChecking=no "root@$VPS_HOST" "sudo cat /etc/rancher/k3s/k3s.yaml" > "$KUBECONFIG_PATH" 2>/dev/null; then
              sed -i "s/127.0.0.1/$VPS_HOST/g" "$KUBECONFIG_PATH"
              chmod 600 "$KUBECONFIG_PATH"
            fi
        env:
          - name: VPS_HOST
            cmd: ['echo', '${{ secrets.VPS_HOST }}']
          - name: VPS_SSH_KEY
            cmd: ['echo', '${{ secrets.VPS_SSH_KEY }}']
          - name: VPS_SSH_PORT
            cmd: ['echo', '${{ secrets.VPS_SSH_PORT }}']
          - name: CLUSTER_NAME
            cmd: ['echo', '${{ secrets.K3S_CLUSTER_NAME }}']

workflows:
  - tag_query: "tag:infra"
    plan:
      - type: init
        extra_args:
          - "-backend-config=bucket=${{ env.R2_BUCKET }}"
          - "-backend-config=endpoints={s3=\"https://${{ env.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com\"}"
      - type: plan
    apply:
      - type: init
        extra_args:
          - "-backend-config=bucket=${{ env.R2_BUCKET }}"
          - "-backend-config=endpoints={s3=\"https://${{ env.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com\"}"
      - type: apply
    env:
      - name: R2_BUCKET
        cmd: ['echo', '${{ secrets.R2_BUCKET }}']
      - name: R2_ACCOUNT_ID
        cmd: ['echo', '${{ secrets.R2_ACCOUNT_ID }}']
      - name: TF_VAR_vps_host
        cmd: ['echo', '${{ secrets.VPS_HOST }}']
      - name: TF_VAR_ssh_private_key
        cmd: ['echo', '${{ secrets.VPS_SSH_KEY }}']
      - name: TF_VAR_ssh_port
        cmd: ['echo', '${{ secrets.VPS_SSH_PORT }}']
      - name: TF_VAR_cluster_name
        cmd: ['echo', '${{ secrets.K3S_CLUSTER_NAME }}']
      - name: TF_VAR_api_endpoint
        cmd: ['echo', '${{ secrets.K3S_API_ENDPOINT }}']
      - name: TF_VAR_k3s_channel
        cmd: ['echo', '${{ secrets.K3S_CHANNEL }}']
      - name: TF_VAR_k3s_version
        cmd: ['echo', '${{ secrets.K3S_VERSION }}']
      - name: TF_VAR_infisical_postgres_password
        cmd: ['echo', '${{ secrets.INFISICAL_POSTGRES_PASSWORD }}']

dirs:
  terraform:
    tags:
      - infra
