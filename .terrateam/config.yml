# Terrateam Configuration
# Replaces manual GitHub Actions for Terraform Plan/Apply
# Provides: PR-based workflow, locking, plan consistency

version: 1

# Default settings for all directories
default_tag_query: ""

# Workflows define how Terrateam runs Plan and Apply
workflows:
  - name: default
    plan:
      - type: init
        extra_args:
          - "-backend-config=bucket=${{ env.R2_BUCKET }}"
          - "-backend-config=endpoints={s3=\"https://${{ env.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com\"}"
      - type: plan
    apply:
      - type: init
        extra_args:
          - "-backend-config=bucket=${{ env.R2_BUCKET }}"
          - "-backend-config=endpoints={s3=\"https://${{ env.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com\"}"
      - type: apply

# Environment variables (secrets from GitHub)
env:
  AWS_ACCESS_KEY_ID:
    secret: AWS_ACCESS_KEY_ID
  AWS_SECRET_ACCESS_KEY:
    secret: AWS_SECRET_ACCESS_KEY
  R2_BUCKET:
    secret: R2_BUCKET
  R2_ACCOUNT_ID:
    secret: R2_ACCOUNT_ID
  TF_VAR_vps_host:
    secret: VPS_HOST
  TF_VAR_ssh_private_key:
    secret: VPS_SSH_KEY
  TF_VAR_ssh_port:
    secret: VPS_SSH_PORT
  TF_VAR_cluster_name:
    secret: K3S_CLUSTER_NAME
  TF_VAR_api_endpoint:
    secret: K3S_API_ENDPOINT
  TF_VAR_k3s_channel:
    secret: K3S_CHANNEL
  TF_VAR_k3s_version:
    secret: K3S_VERSION
  TF_VAR_infisical_postgres_password:
    secret: INFISICAL_POSTGRES_PASSWORD

# Directory configuration - tell Terrateam where Terraform code is
dirs:
  terraform:
    tags:
      - infra
    workflow: default

# Auto-plan on PR
autoplan:
  enabled: true
  file_patterns:
    - "terraform/**/*.tf"
    - "terraform/**/*.tfvars"
    - ".terrateam/config.yml"

# Require approval before apply (safety)
apply_requirements:
  # Uncomment to require PR approval before apply
  # approved: true
  # Uncomment to require all checks to pass
  # mergeable: true
  create_pending_apply_check: true

# Locking - prevent concurrent applies
locks:
  enabled: true
