# platform (Platform Layer)

> **å®šä½**ï¼šæ¨¡å—ç»´æŠ¤æ–‡æ¡£ï¼ˆé¢å‘åŸºç¡€è®¾æ–½è¿ç»´è€…ï¼‰
> **å¼€å‘è€…ï¼Ÿ** â†’ è¯·å…ˆçœ‹ [å¼€å‘è€…æ¥å…¥æŒ‡å—](../docs/onboarding/README.md)
> **éƒ¨ç½²éªŒè¯ï¼Ÿ** â†’ è§ [E2E å›å½’æµ‹è¯•](../docs/ssot/ops.e2e-regressions.md)

**Scope**:
- **Consolidated Control Plane**: Merged Infrastructure and Apps/Observability.
- **Secrets**: Vault (PostgreSQL storage backend, Agent Injector).
- **SSO**: Casdoor (OIDC provider for all platform and app services).
- **PaaS Controller**: Kubero (GitOps PaaS for deploying applications).
- **Observability**: SigNoz (Metrics, Traces, and Logs).
- **Portal**: Homer (unified landing page).
- **Namespaces**: `platform`, `kubero`, `kubero-operator-system`, `observability`.

## Architecture

This layer provides platform-level components that support application deployment.
Depends on Bootstrap for K8s cluster availability.

### Components

| File | Component | Purpose |
|------|-----------|---------
| `2.secret.tf` | Vault | Secrets management (PostgreSQL backend + injector) |
| `3.dashboard.tf` | K8s Dashboard | Cluster management web UI via Ingress |
| `5.casdoor.tf` | Casdoor SSO | Helm release + bootstrap init_data (org, admin, builtin-app only) |
| `6.vault-database.tf` | Vault Mounts | Vault KV and Database secrets engine mounts (credentials managed by Data layer) |
| `7.vault-secrets-operator.tf` | VSO | Vault Secrets Operator for automatic Vault â†’ K8s Secret sync (Issue #351) |
| `90.provider_restapi.tf` | RestAPI Provider | Casdoor REST API provider (M2M credentials via casdoor-builtin-app) |
| `90.casdoor-apps.tf` | Casdoor Apps | OIDC applications & Providers (GitHub) via `restapi_object` resources |
| `4.portal.tf` | Homer Portal | SSO-protected unified dashboard with categorized service links. Emergency section contains only Vault Root Token for break-glass access. |
| `91.casdoor-roles.tf` | Casdoor Roles | Defines `vault-admin`, `vault-developer`, `vault-viewer` roles in Casdoor. Uses `TF_VAR_gh_account` to auto-assign admin user. |
| `91.vault-auth.tf` | Vault OIDC Auth | Vault OIDC backend connected to Casdoor |
| `91.vault-auth-kubernetes.tf` | Vault K8s Auth | Kubernetes authentication backend for pod identity + VSO role |
| `92.vault-kubero.tf` | Kubero Vault | Vault KV secrets (session/webhook/OIDC), policies, and roles for Kubero |
| `92.portal-auth.tf` | Portal SSO Gate | Optional Casdoor-backed OAuth2-Proxy + Traefik middleware |
| `99.checks.tf` | SSO Validation | Whitebox checks for OIDC discovery, Casdoor health, and Portal auth readiness |

### Secrets Strategy

- **Bootstrap**: GitHub Secrets -> Terraform vars (VPS access, R2, Cloudflare)
- **Runtime (Platform/Data)**: Vault Agent Injector (planned: map secrets to workloads)

### Deployment & Configuration

This layer supports both **Atlantis (CI)** and **Standalone/Local** execution via **Terragrunt**.

- **Backend state**: Auto-generated by Terragrunt (`backend.tf`, gitignored)
- **Providers**: Auto-generated by Terragrunt:
  - Common providers (kubernetes, helm, vault) from root `terragrunt.hcl`
  - Layer-specific providers (cloudflare, kubectl, restapi, time, null) from `platform/terragrunt.hcl`
  - Auto-configured for both local kubeconfig and in-cluster ServiceAccount
- **Database Providers**: Both `clickhousedbops` and `postgresql` providers connect to Data databases (DISABLED in Terragrunt migration)
  - **Atlantis Mode**: Uses in-cluster DNS (e.g., `postgresql.data-staging.svc.cluster.local`)
  - **Local Mode**: Requires port-forward or direct connection to database hosts
- **Pipeline Feedback**: All Plan/Apply actions are synchronized to the **`infra-flash` Dashboard** in the PR.
- **Variables**: Defaults provided in `variables.tf`; Atlantis/Terragrunt inject environment values via `TF_VAR_*` / `inputs{}`

```bash
# Standalone usage (requires local kubeconfig + Terragrunt)
cd platform
export R2_BUCKET=<bucket> R2_ACCOUNT_ID=<account-id>
terragrunt init  # Generates backend.tf + providers.tf automatically
terragrunt apply
```

### Access

- **Portal**: `https://home.<internal_domain>` (e.g., `home.zitian.party`) - **â­ Start here!**
  - ğŸ”’ **Protected by SSO**: Login with GitHub to access
  - Unified landing page with categorized service links (Platform Services includes Casdoor Admin)
  - Emergency section: Vault Root Token only (break-glass when OIDC fails)
- **Vault**: `https://secrets.<internal_domain>` (e.g., `secrets.zitian.party`) - HTTPS via cert-manager; manual init/unseal required
- **Dashboard**: `https://kdashboard.<internal_domain>` (e.g., `kdashboard.zitian.party`) - HTTPS via cert-manager
- **Casdoor**: `https://sso.<internal_domain>` (e.g., `sso.zitian.party`) - Unified SSO

### Authentication Model

Platform services use **app-level authentication** (no unified ingress gate):

| Service | Auth Method | Notes |
|---------|-------------|-------|
| **Vault** | Token / OIDC | Manual init/unseal required; OIDC login uses **Identity Groups** (no manual role input). Auto-maps Casdoor roles to Admin/Developer policies. |
| **Dashboard** | Token | Get token: `kubectl get secret dashboard-admin-token -n platform -o jsonpath='{.data.token}' \| base64 -d` |
| **Casdoor** | Admin password | SSO provider itself; admin password from `terraform output -raw casdoor_admin_password` |
| **Portal SSO Gate** | Casdoor OIDC via OAuth2-Proxy | Optionalï¼š`enable_portal_sso_gate=true` åä¸º **æ—  OIDC é—¨æˆ·**ï¼ˆå¦‚ Dashboardï¼‰æ‰“å¼€å…¥å£ |

Casdoor OIDC apps are configured to show a unified login page with **Password + GitHub** (see `platform/90.casdoor-apps.tf`).

### Vault RBAC (Identity Groups)

Vault permissions are managed via **Identity Groups**, offering a "Login and Forget" experience:

- **Mechanism**: Vault automatically reads the `roles` claim from the OIDC JWT token and maps it to internal Identity Groups.
- **Mapping**:
    - Casdoor `vault-admin` -> Vault Identity Group `admin` -> Policy `admin` (Full Access)
    - Casdoor `vault-developer` -> Vault Identity Group `developer` -> Policy `developer` (App Secrets RW)
    - Default (No role) -> Vault Identity Group `viewer` -> Policy `viewer` (Read Only)
- **Benefit**: Users don't need to manually select a role during login. Permissions are automatically stacked based on Casdoor roles.

**Admin User Assignment**:
- The `vault-admin` role automatically assigns the user specified by `TF_VAR_gh_account` (GitHub Secret: `GH_ACCOUNT`)
- Format: Your GitHub email (e.g., `wangzitian0@gmail.com`), automatically prefixed with `built-in/` in Casdoor
- Update via: `python3 0.tools/sync_secrets.py` after adding `GH_ACCOUNT` field to `Infra-OAuth` item in 1Password
- See `platform/91.casdoor-roles.tf` for implementation details

For detailed architecture and usage, see [platform.auth.md](../docs/ssot/platform.auth.md).

See- [platform.network.md](../docs/ssot/platform.network.md) - Domain rules and routing
- [ops.pipeline.md](../docs/ssot/ops.pipeline.md) - PR -> Plan/Apply workflow (Atlantis + infra-flash)
- [platform.auth.md](../docs/ssot/platform.auth.md) - Authentication strategy (Casdoor + Vault)

## Troubleshooting

### Atlantis Lock Failure
If Atlantis fails to delete PR locks, it might be due to a workspace lock. Use `atlantis unlock` command in the PR.
Portal SSO Gate Rolloutï¼ˆå‰ç½®å˜é‡ â†’ è‡ªåŠ¨åŒ– â†’ äº‹åéªŒè¯/åˆ‡æµï¼‰
1. **å‰ç½®å‡†å¤‡**ï¼šå…ˆéƒ¨ç½² Casdoorï¼ˆ`enable_casdoor_oidc=false` / `enable_portal_sso_gate=false`ï¼‰ï¼Œç¡®è®¤ `sso.<internal_domain>` å¯ç”¨ã€‚Portal Gate å®¢æˆ·ç«¯å¯é€‰æ‰‹åŠ¨åˆ›å»ºå¹¶å¡«å…¥ `casdoor_portal_client_id/secret`ï¼›è‹¥ç•™ç©ºï¼Œå¼€å…³å¼€å¯æ—¶ Terraform ä¼šè‡ªåŠ¨ç”Ÿæˆ secretã€‚
2. **åŸç”Ÿ OIDC**ï¼šè®¾ç½® `enable_casdoor_oidc=true` å¹¶ applyï¼ŒTerraform è‡ªåŠ¨ç”Ÿæˆ/å†™å…¥ Casdoor OIDC åº”ç”¨ï¼ˆVault/Kubero/é¢„ç•™ Dashboardï¼‰ï¼ŒVault OIDC å¼€å¯ä½† **ä¸æŒ‚ forwardAuth**ã€‚
3. **Portal Gate**ï¼šä»…å¯¹æ—  OIDC é—¨æˆ·ï¼ˆå¦‚ Dashboardï¼‰è®¾ç½® `enable_portal_sso_gate=true` å¹¶ applyï¼ŒIngress æŒ‚ Traefik ForwardAuthï¼ˆOAuth2-Proxyâ†’Casdoorï¼‰ã€‚
4. **äº‹åéªŒè¯/åˆ‡æµ**ï¼šéªŒè¯ `kdashboard` 302 â†’ Casdoor ç™»å½•é“¾è·¯ï¼›Vault/Kubero åº”ä¿æŒ **åŸç”Ÿ OIDC ç›´è¿**ã€‚è‹¥å¼‚å¸¸å¯ç«‹å³å°†å¼€å…³å…³å› `false` å¹¶é‡è·‘ applyï¼Œé¿å…é”æ­»ã€‚

### Domain Configuration

The `internal_domain` variable controls all platform service hostnames:
- Default: `zitian.party`
- Override via `TF_VAR_internal_domain` in Atlantis environment

Note: `base_domain` (`truealpha.club`) is for business/production apps, `internal_domain` is for platform infrastructure.

### Known Issues

- **Vault init/unseal**: Manual init/unseal required after deploy; store keys outside Terraform.
- **PostgreSQL storage**: Uses `local-path-retain` StorageClass (reclaimPolicy=Retain) to keep PV data after PVC deletion. See [ops.storage.md](../docs/ssot/ops.storage.md).
- **PostgreSQL upgrades**: `helm_release.postgresql` uses `force_update=true` to allow spec changes (e.g., auth tweaks). Expect pod recreation/downtime during upgrades.
- **Namespace ownership**: `platform` namespace is created in Bootstrap, not Platform layer. The Atlantis workflow removes stale namespace refs from Platform state automatically.
- **Casdoor login bug**: Requires `copyrequestbody = true` in `app.conf` to fix "unexpected end of JSON input" error. See [#3224](https://github.com/casdoor/casdoor/issues/3224).
- **Casdoor init_data**: Only loads on first startup. If `casdoor_admin_password` changes, manually update `casdoor-builtin-app` clientSecret via Casdoor UI or API. For disaster recovery (fresh install), init_data re-creates all bootstrap entities.
- **Casdoor login white screen**: If app `signupItems` is `null`, the login page crashes in `AgreementModal`. Keep `signupItems=[]` in `2.platform/90.casdoor-apps.tf`.
- **Casdoor token format**: v1.570.0 requires explicit `tokenFormat`; empty causes `unknown application TokenFormat` during login. Set `tokenFormat="JWT"` in `platform/90.casdoor-apps.tf`.
- **Casdoor token TTL**: If `expireInHours/refreshExpireInHours` are `0`, OAuth2-Proxy will reject with `id_token is expired`. Set both to `168` in `platform/90.casdoor-apps.tf`.
- **Casdoor REST API updates**: `restapi_object` updates default to PUT, but `update-application`/`update-provider` require POST and `?id=admin/{id}`. Set `update_method = "POST"` and include the id query to avoid 404/500s.


### Disaster Recovery

- **Lost Vault Pods**: Re-apply helm chart; PostgreSQL data persists in PVC (`/data/local-path-provisioner`). Re-unseal using stored keys.
- **Lost Admin Access**: Recover using stored root token/unseal keys.

---

### Portal SSO Gate Deployment

**Status**: Controlled by `enable_portal_sso_gate`

To deploy Portal SSO Gate for non-OIDC portals (e.g., Dashboard):
1. This PR triggers Atlantis to run `terraform plan -d platform`
2. Review the plan (should show portal-auth resources and Ingress middleware annotations)
3. Comment `atlantis apply -d platform` to deploy
4. Verify SSO login at:
   - https://kdashboard.zitian.party (Dashboard)

---
*Last updated: 2025-12-23 (VSO for Vaultâ†’K8s sync; Portal reorganization)*

---

