# Check Now

Status: **Storage Retain + Domain Naming**
Last Updated: 2025-12-10
Change Log: [2025-12-10.domain_dns_alignment.md](docs/change_log/2025-12-10.domain_dns_alignment.md) / [2025-12-09.storage_retain.md](docs/change_log/2025-12-09.storage_retain.md)

## 1. Context: What are we doing?
1. Implementing standardized domain naming convention with i-/x- patterns.
2. Hardening storage so PVCs use a Retain storage class on `/data`.

## 2. Why?
**Domain naming**:
- Need clear domain naming for internal infra (admin-only) vs external services (CDN protected)

**Storage hardening**:
- Recent data loss showed local-path PVC deletions wipe data
- Need StorageClass with `ReclaimPolicy=Retain` and `/data` path

## 3. Solution

### Domain Architecture
| Pattern | Cloudflare | Purpose | Example |
|---------|------------|---------|---------|
| Infra (internal domain) | Orange cloud for 443 services; grey/DNS-only for `k3s` | Internal infra | `atlantis.internal.org`, `secrets.internal.org`, `k3s.internal.org` (connect on :6443 direct) |
| `x-*` | Orange cloud (proxied) | Test environments | `x-staging-api`, `x-testpr-123-app` |
| Direct | Orange cloud (proxied) | Production | `api.truealpha.club` |

### Storage Hardening
- Patch local-path config to use `/data/local-path-provisioner`
- Add StorageClass `local-path-retain` with `ReclaimPolicy=Retain`
- Point platform Postgres PVC to `local-path-retain`

## 4. Changes Made

| File | Change |
|------|--------|
| `1.bootstrap/locals.tf` | Infra domain map uses prefix-less hosts on internal domain (env domains unchanged) |
| `1.bootstrap/2.atlantis.tf` | Atlantis URL/ingress hosts use `atlantis` |
| `1.bootstrap/3.dns_and_cert.tf` | Explicit infra A records (443 proxied, k3s grey); optional internal wildcard when zones differ |
| `1.bootstrap/network.md` | DNS architecture rewritten for prefix-less internal scheme |
| `1.bootstrap/README.md` | Domain scheme updated (prefix-less internal) |
| `1.bootstrap/variables.tf` | Clarify `internal_domain` / `env_prefix` descriptions |
| `1.bootstrap/4.storage.tf` | Patch local-path path + add `local-path-retain` StorageClass |
| `2.platform/2.secret.tf` | Vault ingress uses `secrets` |
| `2.platform/3.dashboard.tf` | Dashboard ingress uses `kdashboard` |
| `2.platform/4.kubero.tf` | Kubero UI ingress uses `kcloud` |
| `2.platform/1.postgres.tf` | Use `local-path-retain` for Postgres PVC |
| `2.platform/README.md` | Access URLs updated to `i-*` + storage workaround |

## 5. Validation Checklist
- [x] `terraform fmt -check` passes
- [x] All active services curl tested
- [x] `/data` directory created on VPS
- [x] ConfigMap includes all required fields (config.json, helperPod.yaml, setup, teardown)
- [ ] Documentation Guard CI passes
- [ ] Atlantis plan completes
- [ ] Atlantis apply succeeds
- [ ] StorageClass `local-path-retain` exists in cluster

---

## 6. ~~TODO: Atlantis TF_VAR 环境变量问题~~ ✅ 已解决

**Status**: 已修复（2025-12-08）

通过 PR #77 和 #78 修复：
- 添加 `TF_VAR_xxx` 环境变量到 Atlantis Helm chart
- 清理阻塞 Ingress 更新的残留 Webhook 配置

### 问题
Atlantis Plan 失败：`Error: No value for required variable "vps_host"`

### 根因
Atlantis Pod 环境变量配置不正确：
- 当前：`VPS_HOST`, `AWS_ACCESS_KEY_ID` 等（普通格式）
- Terraform 需要：`TF_VAR_vps_host`, `TF_VAR_aws_access_key_id`（TF_VAR_ 前缀）

**验证命令**:
```bash
KUBECONFIG=1.bootstrap/output/truealpha-k3s-kubeconfig.yaml \
kubectl -n nodep exec atlantis-0 -- env | grep TF_VAR
# 当前输出为空 → 问题确认
```

### 已完成修复（待部署）
- `1.bootstrap/2.atlantis.tf`: 添加 `TF_VAR_xxx` 环境变量
- `1.bootstrap/variables.tf`: 添加 `vault_postgres_password`

### 解决方案
```bash
cd 1.bootstrap
terraform apply
# 等待 Atlantis Pod 重启
# 验证: kubectl -n nodep exec atlantis-0 -- env | grep TF_VAR
```

### 为什么不能自动化
这是**鸡生蛋问题**：要让 Atlantis CI 工作，需要先手动部署 Atlantis。L1 层（nodep）必须手动 apply。

---

## 7. Claude Code Review 流程优化

**Status**: 进行中（2025-12-09）- 触发链路与 bot 过滤已收敛

### 改动
- 删除 `claude-code-review.yml`（每次 PR sync 自动审查）
- 改为 Atlantis plan 成功后触发 Claude review（由 infra-flash[bot] 成功评论驱动）
- 添加 `pull-requests: write` 权限让 Claude 能发评论；用 `user.type != 'Bot'` 收紧人工触发；为 review 评论事件增加 bot 过滤

### 新流程
```
PR opened/updated
    ↓
terraform-plan.yml (CI: fmt, tflint, plan)
    ↓ (on CI success)
github-actions comments "atlantis plan"
    ↓
Atlantis runs terraform plan
    ↓ (on plan success)
infra-flash[bot] comments "Ran Plan for..."
    ↓
claude.yml detects bot's success comment
    ↓
Claude review runs
```

Auto-review runs on every successful Atlantis plan comment from `infra-flash[bot]` (CI 触发或手动重跑均会触发复审)。

### 修改的文件
| File | Change |
|------|--------|
| `.github/workflows/claude-code-review.yml` | 删除 |
| `.github/workflows/claude.yml` | 添加 Atlantis 成功评论触发 + write 权限 + bot 类型过滤 |
| `.github/workflows/terraform-plan.yml` | 只触发 atlantis plan，不触发 PTAL |
| `.github/workflows/README.md` | 更新流程图、表格描述、自动触发说明 |

---

## 8. Terraform 测试机制

**Status**: 已实施（2025-12-08）

### 已实现的检查

| 阶段 | 检查项 | 文件 |
|------|--------|------|
| PR CI | `terraform fmt -check` | `terraform-plan.yml` |
| PR CI | `tflint` (静态分析) | `terraform-plan.yml` |
| PR CI | Helm URL 可达性 | `scripts/preflight-check.sh` |
| Deploy CI | Helm URL 可达性 | `scripts/preflight-check.sh` |

### 覆盖范围

✅ **能挡住**：
- Terraform 语法错误
- 代码格式不规范
- Helm Chart URL 不可达（如 `charts.kubero.dev` DNS 失败）
- TFLint 检测的常见问题

⚠️ **无法挡住**（需人工审查）：
- `moved.tf` 遗漏资源（逻辑问题）
- 生产状态冲突
- 运行时依赖问题

### 本地测试命令

```bash
# 在提交前运行
scripts/preflight-check.sh
terraform fmt -recursive
tflint --recursive
```

---

## 8. ~~TODO: Atlantis 安全性整改~~ ✅ 已解决

**Status**: 已实施（2025-12-09）

### 问题
Atlantis Web UI 和 GitHub PR 评论暴露敏感信息：
- Plan 输出包含 IP 地址、域名、资源配置
- Repo 是 PUBLIC，任何人都可以看到 PR 评论

### 解决方案
在 `1.bootstrap/2.atlantis.tf` 添加了 Basic Auth：
```hcl
basicAuth = {
  username = var.atlantis_web_username
  password = var.atlantis_web_password
}
```

### 部署步骤
1. 在 GitHub Secrets 中添加 `ATLANTIS_WEB_PASSWORD`
2. 运行 `terraform apply` 更新 Atlantis Pod
3. 访问 `https://i-atlantis.truealpha.club` 时需要输入用户名/密码

---

## 9. Vault 替换 Infisical（Secrets 平台切换）

**Status**: 进行中（2025-12-09）

### 改动
- 删除 Infisical 部署与相关随机密钥，改用 Vault（Helm 官方 Chart 0.31.0）
  - Vault 使用 PostgreSQL 作为 storage backend（用户名/库改为 `vault`，StorageClass `local-path-retain` 保留数据）
- 启用 Vault Agent Injector，Ingress 仍用 `i-secrets.<base_domain>`（TLS 由 cert-manager）
- CI inputs/变量重命名为 `vault_*`；tfvars 示例、平台/目录文档同步到 Vault

### 配置要点
```
storage "postgresql" {
  connection_url = "postgresql://vault:${vault_postgres_password}@postgresql.platform.svc.cluster.local:5432/vault?sslmode=disable"
  ha_enabled = "true"
}
listener "tcp" { address = "0.0.0.0:8200"; tls_disable = "true" }
```
- Vault 需手动 init/unseal，root token/钥匙需线下保管。

### 修改的文件
| File | Change |
|------|--------|
| `2.platform/1.postgres.tf` | PG 用户/库改为 vault，StorageClass 使用 `local-path-retain`，启用 `force_update` 便于替换 StatefulSet |
| `2.platform/2.secret.tf` | Vault Helm（PostgreSQL backend + injector + ingress） |
| `2.platform/variables.tf`, `1.bootstrap/variables.tf` | 变量重命名为 `vault_*` |
| `.github/actions/terraform-setup/action.yml` | 输入改为 `vault_postgres_password`，写入 tfvars |
| `.github/workflows/terraform-plan.yml`, `deploy-k3s.yml` | 使用 `VAULT_POSTGRES_PASSWORD`，移除 Infisical 变量引用 |
| `2.platform/README.md`, `docs/dir.md`, `1.bootstrap/network.md`, `.github/actions/terraform-setup/README.md`, `3.data/README.md` | 文档更新为 Vault |

### 验证清单
- [x] `terraform fmt -check` 通过
- [ ] Vault Helm Release 部署（Pods Running/Sealed）在 `platform` 命名空间
- [ ] Ingress `i-secrets.<base_domain>` 正常解析/路由到 Vault service:8200
- [ ] Agent Injector Pods Ready
- [ ] PostgreSQL PVC 位于 `local-path-retain`（数据未被删除）
- [ ] 手动完成 Vault init/unseal，记录 root token/keys（离线）
