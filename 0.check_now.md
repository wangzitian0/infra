# 0.check_now.md

## 1. What (Target)
L3 Data Services: PostgreSQL, Redis, ClickHouse, ArangoDB + Vault integration (with PR #170 hardening)

## 2. Why (Value)
Enable L4 applications to access multiple data stores (OLTP, cache, OLAP, multi-model) with credentials managed by Vault, ensuring **Plan = Apply = Actual State** consistency through systematic validation and health checks.

## 3. Where (Location)
- L2 Platform: `2.platform/6.vault-database.tf` (vault_mount, password generation for all data services)
- L3 Data: `3.data/*.tf` (PostgreSQL, Redis, ClickHouse, ArangoDB - all read passwords from Vault)
- L1 Bootstrap: `1.bootstrap/2.atlantis.tf`, `1.bootstrap/variables.tf` (vault_root_token passthrough + validation)
- Docs: `docs/ssot/secrets.md`, `docs/ssot/env.md`, `docs/ssot/vars.md`, `docs/ssot/pipeline.md`

## 4. Who (Owner)
Infra Team / AI Assistant

## 5. When (Timeline)
Current Phase: Adding Redis, ClickHouse, ArangoDB to L3 Data Layer (building on PR #170 hardening)

## 6. How (Action Plan)

### Infrastructure Hardening (PR #170 - Completed)
- [x] **Variable Validation**: `vps_host`, `ssh_private_key`, `aws_*`, `vault_postgres_password`, `cloudflare_api_token`
- [x] **Preconditions**: Atlantis (GitHub auth), Platform PG, Vault, Casdoor, L3 Postgres
- [x] **Helm Timeout**: All releases standardized to `timeout=300 + wait=true`
- [x] **initContainer Timeout**: All have 120s max (prevents infinite hang)
- [x] **Lock Files**: Committed `.terraform.lock.hcl` with linux_amd64 checksums
- [x] **Per-env Namespace**: L3 creates `data-{workspace}` (data-staging, data-prod)

### Data Services Deployment (Current PR)
- [x] L2: Generate passwords for Redis, ClickHouse, ArangoDB
- [x] L2: Store passwords in Vault KV (secret/data/redis, secret/data/clickhouse, secret/data/arangodb)
- [x] L3: Deploy Redis (Bitnami Helm, master-only for MVP)
- [x] L3: Deploy ClickHouse (Bitnami Helm, single-node for MVP)
- [x] L3: Deploy ArangoDB (Official Operator, Single mode for MVP)
- [x] Docs: Update README with new services, credentials, scalability notes
- [ ] Verify: All deployments follow PR #170 hardening standards (preconditions, timeouts, validation)

### Health Check Matrix (Updated)
| Layer | Component | initContainer | Probes | validation | precondition | timeout |
|-------|-----------|---------------|--------|------------|--------------|---------|
| L1 | Atlantis | N/A | ✅ | ✅ | ✅ | 300s |
| L1 | Platform PG | N/A | ✅ | ✅ | ✅ | 300s |
| L2 | Vault | ✅ 120s | ✅ | ✅ | ✅ | 300s |
| L2 | Casdoor | ✅ 120s | ✅ | ✅ | ✅ | 300s |
| L2 | Portal-Auth | ✅ 120s | ✅ | ✅ | ✅ | 300s |
| L3 | PostgreSQL | ✅ 120s | ✅ | ✅ | ✅ | 300s |
| L3 | Redis | **?** | **?** | **?** | **?** | **?** |
| L3 | ClickHouse | **?** | **?** | **?** | **?** | **?** |
| L3 | ArangoDB | **?** | **?** | **?** | **?** | **?** |

**Note**: New data services need hardening review to match L3 PostgreSQL standards.

### Future TODOs
- [ ] **Harden L3 Data Services**: Add initContainer, preconditions, validation to Redis/ClickHouse/ArangoDB
- [ ] **Atlantis UI Auth**: Add Casdoor SSO or IP allowlist
- [ ] **postcondition**: Add to Helm releases for post-apply validation

---
*Last updated: 2025-12-15*
