# 0.check_now.md

## 1. What (Target)
PR #170: Infrastructure Hardening - Health Checks, Timeouts, Validation

## 2. Why (Value)
Ensure **Plan = Apply = Actual State** consistency. Reduce deployment failures through systematic validation and health checks.

## 3. Where (Location)
- L1 Bootstrap: `variables.tf` (validation), `2.atlantis.tf` (precondition + timeout), `5.platform_pg.tf` (precondition)
- L2 Platform: `2.secret.tf`, `5.casdoor.tf`, `6.vault-database.tf` (initContainer timeout + precondition)
- L3 Data: `1.postgres.tf` (per-env namespace `data-{workspace}`, initContainer timeout)
- Docs: `docs/ssot/pipeline.md` (consistency guarantees), `docs/ssot/dir.md` (health check matrix)

## 4. Who (Owner)
Infra Team / AI Assistant

## 5. When (Timeline)
Current Phase: PR #170 - Hardening & Consistency

## 6. How (Action Plan)

### Completed (PR #170)
- [x] **Variable Validation**: `vps_host`, `ssh_private_key`, `aws_*`, `vault_postgres_password`, `cloudflare_api_token`
- [x] **Preconditions**: Atlantis (GitHub auth), Platform PG, Vault, Casdoor, L3 Postgres
- [x] **Helm Timeout**: All releases standardized to `timeout=300 + wait=true`
- [x] **initContainer Timeout**: All have 120s max (prevents infinite hang)
- [x] **Lock Files**: Committed `.terraform.lock.hcl` with linux_amd64 checksums
- [x] **Per-env Namespace**: L3 creates `data-{workspace}` (data-staging, data-prod)

### Health Check Matrix
| Layer | Component | initContainer | Probes | validation | precondition |
|-------|-----------|---------------|--------|------------|--------------|
| L1 | Atlantis | N/A | ✅ | ✅ | ✅ |
| L1 | Platform PG | N/A | ✅ | ✅ | ✅ |
| L2 | Vault | ✅ 120s | ✅ | ✅ | ✅ |
| L2 | Casdoor | ✅ 120s | ✅ | ✅ | ✅ |
| L3 | Postgres | ✅ 120s | ✅ | ✅ | ✅ |

### Future TODOs
- [ ] **Atlantis UI Auth**: Add Casdoor SSO or IP allowlist
- [ ] **postcondition**: Add to Helm releases for post-apply validation

---
*Last updated: 2025-12-14*
