# 0.check_now.md

## 1. What (Target)
Per-commit comment system with full traceability, using Atlantis autoplan: CI creates skeleton comment; Atlantis runs autoplan; `infra-flash-update.yml` appends status to comment.

## 2. Why (Value)
- **Robustness**: CI creates skeleton comment immediately (locks commit SHA)
- **Traceability**: All actions (Autoplan/Human Plan/Apply) have clickable links to source
- **Simplicity**: Rely on Atlantis robust autoplan mechanism instead of custom triggers

## 3. Where (Location)
- Workflows: `.github/workflows/terraform-plan.yml`, `.github/workflows/infra-flash-update.yml`
- Docs: `.github/workflows/README.md`

## 4. Who (Owner)
Infra Platform / AI Assistant

## 5. When (Timeline)
Dec 17 - Implementing and verifying new flow (Scheme B -> Scheme C: Autoplan).

## 6. How (Action Plan)

### Implementation Steps
- [x] Restore `autoplan.enabled: true` in `atlantis.yaml`
- [x] Remove manual Atlantis trigger from `terraform-plan.yml`
- [x] Update `infra-flash-update.yml` to handle autoplan trigger linking to Atlantis comment itself
- [x] Update `.github/workflows/README.md` to reflect new flow

### Verification Checklist
- [ ] PR push → CI skeleton comment created
- [ ] Atlantis starts autoplan (parallel)
- [ ] `infra-flash-update` detects Atlantis comment
- [ ] `infra-flash-update` finds skeleton comment (or retries/fails if skeleton slow - **Note**: Skeleton is fast, usually <10s)
- [ ] Plan status appended: `[@autoplan #id](atlantis-link)`
- [ ] Human apply: `[@user #id](comment-link)`

### Follow-ups / Notes
- Merge to main for `infra-flash-update.yml` logic to take effect
- Dogfood on an internal PR; if Atlantis output truncation hides the marker, move the marker to an even earlier plan/apply step.

## 7. Findings (Severity sorted)

- [ ] **关键** – `1.bootstrap/2.atlantis.tf:42-68` 使用 `TF_VAR_ssh_private_key` 将 SSH 私钥注入所有 Atlantis 任务，导致每次 Plan 都泄露私钥。
- [ ] **关键** – `2.platform/2.secret.tf:32-64` 把 Vault 启动为不加密（`tlsDisable = true`），内部通信明文，Root Token 与密钥极易被窃取。
- [ ] **关键** – `3.data/providers.tf:26-34` 将 Vault Provider 设为 HTTP 且 `skip_tls_verify = true`，Atlantis/CI 内部可轻松 MITM。
- [ ] **关键** – `2.platform/6.vault-database.tf:145-156` Vault 绑定的 PostgreSQL 连接写死为 `postgresql.data-staging.svc`，prod workspace 无法建立数据库后端。
- [ ] **关键** – `.github/workflows/deploy-k3s.yml:168-200` 状态一致性检查用 `helm status atlantis -n platform`，但 Atlantis 部署在 `bootstrap`，导致每次都误判 Helm 丢失并触发清理。
- [ ] **严重** – `.github/workflows/deploy-k3s.yml:185-200` 在误判时删除 `platform` 命名空间的 secret/deployment，实际部署将面临数据损毁风险。
- [ ] **严重** – `1.bootstrap/5.platform_pg.tf:80-125` 在创建 Vault schema 的 `kubectl exec` 末尾加了 `|| true`，即使 SQL 执行失败 Terraform 也报成功。
- [ ] **严重** – `1.bootstrap/5.platform_pg.tf:24-68` 把 Bitnami PostgreSQL chart 强制设为 `image.tag = "latest"`，阻止了可复现部署。
- [ ] **中等** – `3.data/1.postgres.tf:54-112` 同样部署 `bitnamilegacy/postgresql:latest`，每次 `apply` 可能拉取不同版本。
- [ ] **中等** – `3.data/2.redis.tf:30-88` 也使用 `bitnamilegacy/redis:latest`，让 Redis 镜像不稳定，排查困难。
- [ ] **中等** – `4.apps/variables.tf:31-40` 默认 `kubero_ui_image_tag=latest`，除非手动覆盖，否则 L4 总是跑浮动镜像。
- [ ] **中等** – `4.apps/99.checks.tf:5-14` 注释掉禁止 production 使用 `latest` 的校验，导致 prod 镜像永远未被强制固定。
- [ ] **中等** – `4.apps/manifests/kubero/kubero-ui-sample.yaml:10-230` 样例包含 `latest` 标签且说明 flag 无效，表明代码会拉浮动镜像。
- [ ] **中等** – `2.platform/5.casdoor.tf:56-120` 把 `casdoor_admin_password` 和衍生 client secret 写入 ConfigMap，集群中存在明文高权限密码。
- [ ] **中等** – `.github/workflows/deploy-k3s.yml:260-304` 仅在 `push` 时运行 L3 数据层 apply 与健康检查，触发在 PR 的 Terraform 修改不会被验证。
- [ ] **中等** – `.github/workflows/deploy-k3s.yml:320-396` 同样在 PR 时跳过 L4 Apps 层部署/校验，造成 `4.apps` 回归直到 `push` 才显现。
- [ ] **中等** – `docs/ssot/ops.alerting.md:36-37` 仍标注 “配置 SigNoz Alert Rules” TODO，告警策略未落地。
- [ ] **中等** – 同一文件在 `docs/ssot/ops.alerting.md:36-37` 也写 “配置通知通道 (Email/Webhook)” TODO，说明并没有通知管道。
- [ ] **中等** – `docs/ssot/ops.observability.md:53-54` 标记 SigNoz Helm/TF 模块“未落地”，可观测堆栈还在设计阶段。
- [ ] **中等** – 同一文件 `docs/ssot/ops.observability.md:53-54` 也说明应用端 OTel SDK “未落地”，Tracing/Metric 撰写未完成。
- [ ] **中等** – `docs/ssot/db.platform_pg.md:63` 提到备份 CronJob TODO，表明 Platform PG 没有自动备份机制。
- [ ] **中等** – `docs/ssot/db.business_pg.md:31` 说明 Vault 的 PostgreSQL 数据库引擎还未配置，L3 数据库凭据无人管理。
- [x] **中等** – `docs/ssot/platform.auth.md:103` 已修复：GitHub OAuth Provider 现通过 `98.casdoor-apps.tf` 中的 REST API 自动配置。
- [ ] **中等** – `docs/ssot/ops.pipeline.md:293` 还留着“TODO（理想态）”区块，说明 CI/Atlantis 流程文档不完整。
- [ ] **中等** – `docs/ssot/ops.storage.md:53` 把数据库备份列为“未落地”，所以 RDB dump 没有自动化。
- [ ] **中等** – `docs/ssot/ops.storage.md:54` 说明 R2 备份同步“未落地”，`/data/backups` 还没推送到对象存储。
- [ ] **中等** – `docs/ssot/ops.storage.md:36-38` 承诺会在 `0.tools/` 增加 `ssot-sync.sh`，但实际上并不存在该脚本。
- [ ] **中等** – `docs/ssot/platform.ai.md:46` 将应用端的 AI SDK 接入标为“未落地”，AI 合约仍只是设计。
- [ ] **中等** – `docs/project/BRN-008.md:816` 明确指出 L3/L4 IaC 仍缺失，说明 repo 目前没有这些层的自动化。
- [ ] **中等** – `docs/ssot/core.env.md:56` 提醒 `3.data/` 与 `4.apps/` 目录目前仅有 README，说明命名空间/状态逻辑尚未实现。
- [ ] **低** – `0.tools/migrate-state.sh:13-68` 假定存在 `terraform` 和 `layer2-platform` 目录，但 repo 里找不到，这脚本无法运行。
- [ ] **低** – `apps/tools/README.md` 仍教人配置不存在的 Dokploy cms/backend 服务，误导读者。
- [ ] **低** – `apps/tools/envs/env.ci` 将 `NEO4J_PASSWORD`/`DATABASE_URL` 密码、JWT 密钥留空，开发者容易在无凭据的状态下启动。
- [ ] **低** – `apps/docs/project/BRN-001/prompt.md:122-174` 要求在 `docs/phrase_0.infra/` 创建 `deploy.md`，但该路径根本不存在，指令不可执行。
- [ ] **低** – `apps/docs/project/BRN-001/_archive_phase_content.md:33-170` 仍列出大量未处理的 Todo，历史 backlog 也未整理。
- [ ] **低** – `.github/workflows/terraform-plan.yml:6-12` 把 `4.apps/**` 写了两次，路径过滤多余且可能导致维护混乱。
- [x] **低** – 已将 `docs/ssot/db.redis.md` 的连接说明内联到文档中，避免额外的“连接汇总页”带来重复维护与 404 风险。
- [x] **低** – 已将 `docs/ssot/db.clickhouse.md` 的连接说明内联到文档中，避免额外的“连接汇总页”。
- [x] **低** – 已将 `docs/ssot/db.arangodb.md` 的连接说明内联到文档中，避免额外的“连接汇总页”。
- [x] **低** – 已将认证 SSOT 统一为 `docs/ssot/platform.auth.md`，并移除旧跳转入口，避免跨链漂移。
- [ ] **低** – `docs/ssot/db.redis.md` 描述的 Vault Agent 注入流程在 `3.data/2.redis.tf` 中没有体现，文档与代码对不上。
- [ ] **低** – `docs/ssot/db.clickhouse.md` 承诺的 Vault Agent 注入也没有在 `3.data/3.clickhouse.tf` 中实现。
- [ ] **低** – `docs/ssot/db.arangodb.md` 也预期 Agent 注释，但 `3.data/4.arangodb.tf` 里未设置。
- [ ] **低** – `docs/ssot/platform.network.md:12-40` 介绍 NGINX 注释用于 Atlantis IP 白名单，但实际用的是 Traefik，注释无效。
- [ ] **低** – `2.platform/3.dashboard.tf:187-236` 仍然将 Dashboard API 的 service account 绑定到 `cluster-admin`，权责过大。
- [ ] **低** – `1.bootstrap/1.k3s.tf:22-45` 将 SSH 私钥写到 `/tmp/infra-k3s.id_rsa` 后不清理，敏感文件长期留在 VPS。
- [ ] **低** – `.github/workflows/deploy-k3s.yml:382-396` 的 `if [ ! -f "4.apps/*.tf" ]` 把通配符当字面串，永远不会跳过 `kubectl` 查询。
- [ ] **低** – `docs/ssot/platform.network.md:12-25` 提及 `signoz.<internal_domain>`，但 `/2.platform` 或 `/3.data` 没有任何 SigNoz Helm/TF 模块。
- [ ] **低** – `1.bootstrap/2.atlantis.tf:80-99` 写着“要加 IP 白名单”的 TODO，Atlantis 仍全靠 Basic Auth。
- [ ] **低** – `.github/workflows/deploy-k3s.yml:261-351` 将数据/应用工作区和状态 key 硬编码为 `prod`，`data-staging`/`apps-staging` 没有 CI 机制覆盖。
