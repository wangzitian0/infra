# 0.check_now.md

## 1. What (Target)
PR #174: Fix Atlantis concurrency (workspace/.terraform collisions)

## 2. Why (Value)
Ensure **Plan = Apply = Actual State** consistency. Eliminate Atlantis parallel plan collisions (e.g. `text file busy`, `Workspace already exists`) for multi-workspace projects.

## 3. Where (Location)
- Repo: `atlantis.yaml` (execution order groups + safe platform workflow)
- L2 Platform: `moved.tf` (namespace state migration notes)
- Docs: `docs/ssot/pipeline.md` (Atlantis 并发问题与约束)

## 4. Who (Owner)
Infra Team / AI Assistant

## 5. When (Timeline)
Current Phase: PR #174 - Atlantis Concurrency Fix

## 6. How (Action Plan)

### Completed (PR #174)
- [x] **Execution Order Groups**: Prevent parallel plan/apply for projects sharing the same directory (per-env workspaces)
- [x] **Platform State Migration**: Remove stale L2 namespace state in platform plan stage (`terraform state rm kubernetes_namespace.platform`) to avoid destroying `platform` namespace and avoid saved-plan staleness
- [x] **Docs Sync**: Update `docs/ssot/pipeline.md` to reflect the actual concurrency root cause and fix

### Verification Checklist
- [ ] **Atlantis Global Plan**: `atlantis plan` runs `data-staging/apps-staging` then `data-prod/apps-prod` (no overlap on same dir)
- [ ] **No Collision Errors**: No `Error: text file busy` / `Error: Workspace \"prod\" already exists`
- [ ] **Platform Plan Safety**: `2.platform` plan does not propose destroying the `platform` namespace (stale state is removed)

### Future TODOs
- [ ] **Atlantis UI Auth**: Add Casdoor SSO or IP allowlist
- [ ] **postcondition**: Add to Helm releases for post-apply validation

---
*Last updated: 2025-12-14*
