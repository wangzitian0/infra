# 0.check_now — 5W1H + 验证（BRN-004）

日期：2025-12-06  
范围：Staging MVP 基线（Phase 0.x → 1.x；phase 内可并行）

## 5W1H（单任务：拿到可用 kubeconfig）
- **What**：配置 R2 + VPS + Repository Secrets，触发 CI 安装 k3s，拿到可用 kubeconfig。
- **Why**：后续 Kubero/数据服务/观测都依赖可用集群与 kubeconfig。
- **Who**：Zitian 提供 VPS、SSH 权限、DNS、R2 凭据、GitHub Secrets。
- **When**：首次 kubeconfig 成功前补齐；VPS/域名/密钥变更时立即更新 Secrets。
- **Where**：`terraform/backend.tf`（后端定义）、GitHub Secrets（R2/VPS/k3s）、DNS（如走域名）、`terraform/output/<cluster>-kubeconfig.yaml`。
- **How**：
  1. 准备 R2 bucket + API Token，设置 `AWS_*`、`R2_*`
  2. VPS 开放 22/6443，Ubuntu 22.04+/Debian 11+，具 sudo
  3. 配置 Secrets：`VPS_HOST`、`VPS_SSH_KEY`（可选 `VPS_USER`/`VPS_SSH_PORT`、`K3S_*`）
  4. 触发 `Deploy k3s to VPS` 工作流（push main 或手动），下载 kubeconfig artifact
  5. 本地可选：`cp terraform/terraform.tfvars.example terraform/terraform.tfvars` → 填 VPS/SSH → `terraform init ...` → `terraform plan && terraform apply` → `export KUBECONFIG=./output/<cluster>-kubeconfig.yaml && kubectl get nodes`

## Phase 提示（phase 内无依赖）
- Phase 0.x：k3s + Infisical（后续密码集中到 Infisical）
- Phase 1.x：Kubernetes Dashboard、Kubero、Kubero UI、平台 PostgreSQL（Infisical/Kubero 专用）
- Phase 2.x：数据服务（业务 PostgreSQL 与平台库分离，Neo4j、Redis、ClickHouse）
- Phase 3.x：可观测/产品分析（SigNoz、PostHog）

## 待准备
- [ ] VPS：公网 IP，22/6443 开放，具 sudo
- [ ] Cloudflare：域名解析到 VPS（如使用域名访问 API）
- [ ] R2：bucket + API Token，就绪 `AWS_*`、`R2_*`
- [ ] GitHub Secrets：R2 凭据 + VPS SSH key（可选 k3s 参数）
- [ ] SSL：如需，通配 `*.truealpha.club`

## 文件快速检查
- Terraform phases 存在：`terraform/phases/0_0_k3s.tf`、`0_1_infisical.tf`、`1_1_postgresql.tf`、`1_3_dashboard.tf`
- 变量定义：`terraform/variables.tf` 包含 k3s/Infisical/数据库相关参数
- 目录导航：`docs/README.md`，规范：`AGENTS.md`

## 验证步骤
1) **CI 输出**：工作流成功，artifact 内有 `<cluster>-kubeconfig.yaml`  
2) **本地验证**（使用 artifact 或本地 apply 生成的 kubeconfig）：
```bash
export KUBECONFIG=./output/<cluster>-kubeconfig.yaml
kubectl get nodes
```
返回单节点 Ready 即为通过。

## 后续
- Phase 0.x 完成后，推进 Phase 1.x（Dashboard/Kubero/平台 PG）；后续密码通过 Infisical 管理。
- 需要多环境或评论驱动时，参考 `docs/ci-workflow-todo.md`。
