# 0.check_now.md

## 1. What (Target)
BRN-008 P2: Casdoor SSO Login Fix and One-Auth Gate Implementation.

## 2. Why (Value)
Complete SSO integration with Casdoor login bugfix (`copyrequestbody=true`) and implement One-Auth gate for L2 services.

## 3. Where (Location)
- L2 Platform: `2.platform/5.casdoor.tf` (copyrequestbody fix, initDataFile config)
- L2 Platform: `2.platform/99.one-auth.tf` (SSO gate switch)
- L1 Bootstrap: `1.bootstrap/5.platform_pg.tf` (timeout reduction)
- Docs: `2.platform/README.md` (One-Auth documentation)

## 4. Who (Owner)
Infra Team / AI Assistant (Antigravity)

## 5. When (Timeline)
Current Phase: Casdoor Deployment Verification

## 6. How (Action Plan)

### Blocking Actions
- [ ] **Deploy Casdoor with copyrequestbody fix**: Apply latest main to cluster
- [ ] **Verify Casdoor Login**: Login with admin/123 at sso.zitian.party

### Completed (PRs #125-147)
- [x] PR #125: Vault PostgreSQL migration (Raft → PostgreSQL storage)
- [x] PR #130: Bitnami OCI registry fix
- [x] PR #132: PostgreSQL image tag pinning
- [x] PR #133: Atlantis probe interval reduction (60s → 10s)
- [x] PR #134: Vault PostgreSQL schema provisioning
- [x] PR #144: Casdoor init_data.json via extraVolumes + initDataFile config
- [x] PR #144: Helm timeout reduction (300s → 120s)
- [x] Casdoor login bug root cause identified: missing `copyrequestbody=true` in app.conf
- [x] One-Auth gate implementation (`enable_one_auth` variable)
- [x] Updated docs/ssot/secrets.md with 1Password→GitHub mappings
- [x] Updated docs/ssot/auth.md with layered auth model

### Known Issues
- Casdoor v1.702.0 and v1.570.0 both have init_data.json loading issues
- `init_data.json` password is NOT loaded if DB already has default admin/123 user
- Manual DB recreation required after Casdoor deployment changes

## Verification Checklist
- [ ] Casdoor pod running (1/1)
- [ ] Admin login works at https://sso.zitian.party (admin/123)
- [ ] OAuth2-Proxy running (prerequisite for One-Auth gate)
- [ ] One-Auth gate can be enabled after SSO verification

---
*Last updated: 2025-12-13*
