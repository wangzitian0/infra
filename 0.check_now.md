# 0.check_now.md

## 1. What (Target)
Per-commit comment system with full traceability: CI creates comment → runs checks → triggers Atlantis plan → comment updated with Plan/Apply status.

## 2. Why (Value)
- **No race condition**: Comment exists before Atlantis runs
- **CI failure blocks Atlantis**: Saves compute, prevents deploying bad code
- **Full audit trail**: Every action (CI/Plan/Apply) has clickable link to source

## 3. Where (Location)
- Workflows: `.github/workflows/terraform-plan.yml`, `.github/workflows/infra-flash-update.yml`
- Docs: `.github/workflows/README.md`

## 4. Who (Owner)
Infra Platform / AI Assistant

## 5. When (Timeline)
Dec 17 - Implementing and verifying new flow.

## 6. How (Action Plan)

### Implementation Steps
- [x] CI creates skeleton comment at start (locks commit)
- [x] CI updates comment with results (pass=simple, fail=details)
- [x] CI triggers `atlantis plan` via comment if passed
- [x] `infra-flash-update.yml` appends Plan/Apply to commit comment
- [x] Trigger links: `[CI #run-id](link)`, `[@user #comment-id](link)`
- [x] Update `.github/workflows/README.md` to reflect new flow

### Verification Checklist
- [ ] PR push → skeleton comment created with ⏳
- [ ] CI completes → comment updated with ✅ or ❌
- [ ] CI triggers `atlantis plan` comment
- [ ] Atlantis Plan → appended to comment with `[CI #run-id](ci-link)`
- [ ] Human `atlantis apply` → appended with `[@user #id](comment-link)`
- [ ] Final state: `✅ Ready to merge!`

### Follow-ups
- After merge, test with real terraform change PR to verify full E2E flow
- `infra-flash-update.yml` changes only take effect after merge (issue_comment reads from main)
