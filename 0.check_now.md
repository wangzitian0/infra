# 0.check_now.md

## 1. What (Target)
L3 PostgreSQL + Vault Database Engine (fully reproducible infrastructure)

## 2. Why (Value)
Enable L4 applications to access PostgreSQL with dynamic credentials from Vault, while maintaining full IaC reproducibility.

## 3. Where (Location)
- L2 Platform: `2.platform/6.vault-database.tf` (vault_mount, password generation, database engine)
- L3 Data: `3.data/1.postgres.tf` (PostgreSQL Bitnami Helm, reads password from Vault)
- L1 Bootstrap: `1.bootstrap/2.atlantis.tf`, `1.bootstrap/variables.tf` (vault_root_token passthrough)
- Docs: `docs/ssot/secrets.md`, `docs/ssot/env.md`, `docs/ssot/vars.md`

## 4. Who (Owner)
Infra Team / AI Assistant (Antigravity)

## 5. When (Timeline)
Current Phase: PR #152 Review Fixes

## 6. How (Action Plan)

### SSOT Compliance Fixes (Completed)
- [x] Create vault_mount resources for secret/ and database/ (no manual steps)
- [x] Move password generation from L3 to L2 (eliminate circular dependency)
- [x] L3 reads password from Vault via data source
- [x] Namespace follows SSOT: `data-${var.environment}` (data-staging, data-prod)
- [x] Added `enable_postgres_backend` for two-phase L2→L3 deploy
- [x] L3 uses Bitnami Helm v16.4.2 with `tag=latest + pullPolicy=IfNotPresent` (matches L1)

### Architecture (Fully Reproducible)
```
L1 (k3s) → L2 (Vault + vault_mount + 密码生成) → L3 (PostgreSQL Helm) → L4 (动态凭证)
```

### Two-Phase Deploy
1. Apply L2 (enable_postgres_backend=false): creates vault_mount, stores password
2. Apply L3: PostgreSQL deployed  
3. Apply L2 (enable_postgres_backend=true): creates database connection

### Vault Roles
- `database/creds/app-readonly` - SELECT (TTL: 1h)
- `database/creds/app-readwrite` - CRUD (TTL: 1h)

### Future TODOs (Non-blocking)
- [ ] **Atlantis UI Auth**: Add Casdoor SSO or IP allowlist for Atlantis UI (currently Basic Auth only)

---
*Last updated: 2025-12-13*
