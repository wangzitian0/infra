# Check Now

Status: **CI 静态测试实施完成**
Last Updated: 2025-12-08
Change Log: [2025-12-08.static_testing.md](docs/change_log/2025-12-08.static_testing.md)

## 1. Context: What are we doing?
Simplifying infrastructure from 5-layer to 4-layer architecture.

## 2. Why?
Original 5-layer design was over-engineered:
- L2 (env_and_networking) + L3 (computing) had overlapping responsibilities
- Too many layers for single-VPS MVP

## 3. New Architecture (L1-L4)

| Layer | Name | Responsibility |
|-------|------|----------------|
| **L1** | Bootstrap | K3s, Atlantis, DNS/Cert (零依赖) |
| **L2** | Platform | Secrets (Infisical), Dashboard, Kubero, Platform DB |
| **L3** | Data | Business DBs (Postgres, Redis, Neo4j, ClickHouse) |
| **L4** | Insight | Observability (SigNoz), Analytics (PostHog), Alerting |

## 4. Changes Made

| Before | After |
|--------|-------|
| `2.env_and_networking/` | `2.platform/` |
| `3.computing/` | merged into `2.platform/` |
| `4.storage/` | `3.data/` |
| `5.insight/` | `4.insight/` |

## 5. Validation Checklist
- [x] `terraform fmt -check` passes
- [ ] `terraform validate` passes (requires init)
- [ ] `terraform plan` shows only moves, no destroy/create
- [ ] Documentation Guard CI passes

---

## 6. ~~TODO: Atlantis TF_VAR 环境变量问题~~ ✅ 已解决

**Status**: 已修复（2025-12-08）

通过 PR #77 和 #78 修复：
- 添加 `TF_VAR_xxx` 环境变量到 Atlantis Helm chart
- 清理阻塞 Ingress 更新的残留 Webhook 配置

### 问题
Atlantis Plan 失败：`Error: No value for required variable "vps_host"`

### 根因
Atlantis Pod 环境变量配置不正确：
- 当前：`VPS_HOST`, `AWS_ACCESS_KEY_ID` 等（普通格式）
- Terraform 需要：`TF_VAR_vps_host`, `TF_VAR_aws_access_key_id`（TF_VAR_ 前缀）

**验证命令**:
```bash
KUBECONFIG=terraform/output/truealpha-k3s-kubeconfig.yaml \
kubectl -n nodep exec atlantis-0 -- env | grep TF_VAR
# 当前输出为空 → 问题确认
```

### 已完成修复（待部署）
- `terraform/1.nodep/2.atlantis.tf`: 添加 `TF_VAR_xxx` 环境变量
- `terraform/1.nodep/variables.tf`: 添加 `infisical_postgres_password`
- `terraform/main.tf`: 传递变量到 nodep 模块

### 解决方案
```bash
cd terraform
terraform apply -target=module.nodep
# 等待 Atlantis Pod 重启
# 验证: kubectl -n nodep exec atlantis-0 -- env | grep TF_VAR
```

### 为什么不能自动化
这是**鸡生蛋问题**：要让 Atlantis CI 工作，需要先手动部署 Atlantis。L1 层（nodep）必须手动 apply。

---

## 7. Terraform 测试机制

**Status**: 已实施（2025-12-08）

### 已实现的检查

| 阶段 | 检查项 | 文件 |
|------|--------|------|
| PR CI | `terraform fmt -check` | `terraform-plan.yml` |
| PR CI | `tflint` (静态分析) | `terraform-plan.yml` |
| PR CI | Helm URL 可达性 | `scripts/preflight-check.sh` |
| Deploy CI | Helm URL 可达性 | `scripts/preflight-check.sh` |

### 覆盖范围

✅ **能挡住**：
- Terraform 语法错误
- 代码格式不规范
- Helm Chart URL 不可达（如 `charts.kubero.dev` DNS 失败）
- TFLint 检测的常见问题

⚠️ **无法挡住**（需人工审查）：
- `moved.tf` 遗漏资源（逻辑问题）
- 生产状态冲突
- 运行时依赖问题

### 本地测试命令

```bash
# 在提交前运行
scripts/preflight-check.sh
terraform fmt -recursive
tflint --recursive
```

