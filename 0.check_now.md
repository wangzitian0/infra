# Check Now

Status: **Fixing CI Variable Chain**
Last Updated: 2025-12-07
PR: #71 fix/ci-variable-chain

## 1. Context: What are we doing?
Fixing broken variable chain that caused Atlantis to receive empty AWS credentials.

## 2. Root Cause Analysis
Variable chain was broken at multiple points:

| Location | Issue | Fix |
|----------|-------|-----|
| `terraform/variables.tf` | Missing `aws_access_key_id`, `aws_secret_access_key` | Added declarations |
| `terraform/variables.tf` | `r2_bucket` had wrong default `"root"` | Removed default |
| `terraform/main.tf` | Hardcoded `aws_*` as empty strings | Changed to `var.aws_*` |
| `terraform-setup/action.yml` | tfvars missing R2 credentials | Added to generation |
| `atlantis.yaml` | `extra_args` doesn't expand `$ENV_VAR` | Changed to `run` steps |

## 3. Variable Flow (Fixed)
```
GitHub Secrets → terraform-setup action → tfvars → variables.tf → main.tf → module.nodep → Atlantis env
```

## 4. Changes in This PR
- Complete L1 bootstrap variable chain
- Fix atlantis.yaml to use `run` steps for env var expansion
- Also fixed deprecated `endpoint` → `endpoints.s3` syntax

## 5. Validation Checklist
- [ ] `Deploy k3s to VPS` workflow passes
- [ ] `Documentation Guard` workflow passes
- [ ] Atlantis plan succeeds (no "No valid credential sources" error)
