# 0.check_now.md

## 1. What (Target)
Completed CI/CD Refactoring: A fully automated, shift-left variable loading pipeline (1Password -> GitHub -> Python Loader -> Terraform).

## 2. Why (Value)
- **Extreme DRY**: YAML redundancy reduced by 80%.
- **High Integrity**: Automated OpenSSL checks and variable schema alignment.
- **SSOT**: 1Password is the authoritative source, GitHub is a clean cache.

## 3. Where (Location)
- Core: `0.tools/ci_load_secrets.py`, `0.tools/sync_secrets.py`, `0.tools/check_integrity.py`
- Workflows: `.github/workflows/deploy-k3s.yml`, `.github/workflows/terraform-plan.yml`
- Logs: `docs/change_log/2025-12-19.ci_secrets_refactor.md`

## 4. Who (Owner)
AI Assistant / Infra Ops

## 5. When (Timeline)
Dec 19 - Mission Accomplished.

## 6. How (Action Plan)

### Implementation Steps
- [x] **Core Refactor**: Created Python Loader and simplified YAML.
- [x] **1Password Organization**: Cleaned `my_cloud` vault, renamed old items, established `Infra-*` contract.
- [x] **Fixed Corrupted Secrets**: Repaired and re-synced Atlantis RSA Key.
- [x] **Full Shift-Left**: 
    - [x] Implemented `check_integrity.py` (Variable alignment guard).
    - [x] Implemented Fail-fast熔断器 in `action.yml`.
    - [x] Implemented `sync_secrets.py` with local OpenSSL validation.
- [x] **Archiving**: Created detailed change log and moved fixed findings.

### Final Verification
- [x] PR CI Validate passes.
- [x] Atlantis Plan success.
- [x] README Coverage passes.

## 7. Findings (Status Update)

- [ ] **中等** – `2.platform/90.casdoor-apps.tf:74-75` Casdoor 不可用时静默 `exit 0`，应改为 `exit 1` 或输出明确 warning。
- [ ] **中等** – `2.platform/92.portal-auth.tf:81` OAuth2-Proxy scope 硬编码为 `openid profile email`，需确认 Casdoor 支持。
- [ ] **中等** – `2.platform/92.portal-auth.tf:71` cookie-domain 设为 `.zitian.party`，允许所有子域共享 cookie，需确认安全边界。
- [ ] **低** – `2.platform/91.vault-auth.tf:54-55` reader policy 允许 `secret/*` read/list，权限过宽，中期需细化。
- [ ] **低** – `docs/ssot/db.redis.md` 描述的 Vault Agent 注入流程在 `3.data/2.redis.tf` 中没有体现，文档与代码对不上。
- [ ] **低** – `docs/ssot/db.clickhouse.md` 承诺的 Vault Agent 注入也没有在 `3.data/3.clickhouse.tf` 中实现。
- [ ] **低** – `docs/ssot/db.arangodb.md` 也预期 Agent 注释，但 `3.data/4.arangodb.tf` 里未设置。
- [ ] **低** – `docs/ssot/platform.network.md:12-40` 介绍 NGINX 注释用于 Atlantis IP 白名单，但实际用的是 Traefik，注释无效。
- [ ] **低** – `2.platform/3.dashboard.tf:187-236` 仍然将 Dashboard API 的 service account 绑定到 `cluster-admin`，权责过大。
- [ ] **低** – `1.bootstrap/1.k3s.tf:22-45` 将 SSH 私钥写到 `/tmp/infra-k3s.id_rsa` 后不清理，敏感文件长期留在 VPS。
- [ ] **低** – `.github/workflows/deploy-k3s.yml:382-396` 的 `if [ ! -f "4.apps/*.tf" ]` 把通配符当字面串，永远不会跳过 `kubectl` 查询。
- [ ] **低** – `docs/ssot/platform.network.md:12-25` 提及 `signoz.<internal_domain>`，但 `/2.platform` 或 `/3.data` 没有任何 SigNoz Helm/TF 模块。
- [ ] **低** – `1.bootstrap/2.atlantis.tf:80-99` 写着“要加 IP 白名单”的 TODO，Atlantis 仍全靠 Basic Auth。
- [ ] **低** – `.github/workflows/deploy-k3s.yml:261-351` 将数据/应用工作区和状态 key 硬编码为 `prod`，`data-staging`/`apps-staging` 没有 CI 机制覆盖。

---
*Next focus: Observability stack landing (L4).*