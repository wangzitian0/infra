# 0.check_now.md

## 1. What (Target)
Simplify CI ↔ Atlantis to Scheme A while keeping infra-flash per-commit audit: CI only does static checks; Atlantis autoplan does plan/apply; infra-flash appends plan/apply to the matching commit comment reliably.

## 2. Why (Value)
Reduce cognitive load and PR noise: one execution path for plan/apply (Atlantis), one execution path for syntax checks (CI), and a per-commit comment stream that stays correctly attributed for audits and rollback/debugging.

## 3. Where (Location)
- Automation: `atlantis.yaml`, `.github/workflows/terraform-plan.yml`, `.github/workflows/infra-flash-update.yml`, `.github/workflows/deploy-k3s.yml`
- Scripts: `0.tools/preflight-check.sh`
- Docs: `.github/workflows/README.md`, `.github/README.md`, `README.md`, `docs/ssot/ops.pipeline.md`, `docs/ssot/README.md`
- History: `docs/change_log/`

## 4. Who (Owner)
Infra Platform / AI Assistant (acting CTO view for review simplicity & architecture fitness).

## 5. When (Timeline)
Dec 15 window → implement Scheme A simplification + reduce redundant pipelines.

## 6. How (Action Plan)

### Implementation Steps
- [x] CI runs static checks only (fmt/tflint/validate), and posts per-commit infra-flash comments.
- [x] Atlantis autoplan runs on PR updates; plan/apply results append to the matching infra-flash comment.
- [x] Add `infra-flash-commit:xxxxxxx` marker into Atlantis output for robust comment mapping.
- [x] Trim `deploy-k3s.yml` to L1 Bootstrap only (L2+ handled via Atlantis).
- [x] Refresh SSOT docs and this 5W1H.

### Verification Checklist
- [ ] Create a smoke PR and push 2 commits ⇒ confirm two infra-flash comments exist (each scoped to its SHA).
- [ ] Wait for Atlantis autoplan ⇒ verify it appends `### Atlantis Plan ...` to the matching commit comment (commit match via `infra-flash-commit:` marker).
- [ ] Comment `atlantis apply` ⇒ verify it appends `### Atlantis Apply ...` and shows `✅ Ready to merge!`.
- [ ] Push a new commit after a Plan failure ⇒ verify new commit gets a new infra-flash comment and new autoplan result appends to the new one.

### Follow-ups / Notes
- Dogfood on an internal PR; if Atlantis output truncation hides the marker, move the marker to an even earlier plan/apply step.
