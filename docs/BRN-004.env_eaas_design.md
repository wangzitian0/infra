# BRN-004: 环境即服务 (EaaS) 设计（infra 版）

> **版本：** 1.0  
> **最后更新：** 2025-12-04  
> **范围：** 本仓库的 IaC/k8s 落地，取代 apps 子模块里的同名设计引用。

## 核心取舍
- 运行时：从 Dokploy 切换为 **k3s + Kubero + Kubero UI**，保持单 VPS 友好，同时获得原生 k8s 生态和 GitOps 体验。
- IaC：继续使用 **Terraform + GitHub Actions**，R2 做 state backend。
- 观测/产品分析：继续预留 **SigNoz**、**PostHog**，后续按 BRN 演进。
- 开发者入口：预留 **Backstage**，后续按需要接入。
- 网络：**Cloudflare** 作为 DNS/CDN/WAF，不变。

## 三层架构（现状与演进）
```
IaC: Terraform (+ GH Actions)
Runtime: k3s + Kubero + Kubero UI
Apps: PEG-scaner 业务镜像
```
- **当前 MVP：** Terraform 通过 SSH 在 VPS 安装 k3s，并生成 kubeconfig；Kubero 作为 k8s PaaS 层（待落地）。
- **后续：** 在 k3s 部署 Kubero/Kubero UI → 部署 SigNoz/PostHog → 引入 Backstage。

## 组件基线
| 类别 | 方案 | 说明 |
|---|---|---|
| IaC | Terraform | state 存 R2；plan/apply 走 GH Actions |
| Runtime | k3s + Kubero + Kubero UI | 替代 Dokploy，原生 k8s，带 PaaS/UI |
| Observability | SigNoz | OTel 原生，一体化 APM |
| Product Analytics | PostHog | 开源自托管 |
| Portal | Backstage | 预留，按需引入 |
| Network | Cloudflare | DNS/CDN/WAF |

## 五套环境

| 环境 | 用途 | 特点 |
|------|------|------|
| **dev** | 本地开发 | 与 CI 高度一致，启动快速，本地拉起依赖 |
| **ci** | CI 验证 | 与 dev 高度一致，自动化验证 |
| **test** | 手动测试 | 与 CI 一致，生命周期较长，可通过域名手动测试，直到 PR 合并 |
| **staging** | 预发布验证 | 定期从 prod 导出数据，除数据不全外与 prod 几乎 1:1；infra 变更先在此验证 |
| **prod** | 生产环境 | 真实用户数据和流量 |

### 环境一致性原则

```
dev ≈ ci          # 高度一致，保证本地开发结果可在 CI 复现
ci ≈ test         # 一致，区别仅在生命周期
staging ≈ prod    # 几乎 1:1，staging 数据从 prod 定期导出（非全量）
```

### infra 变更流程

```
本地 dev 验证 → PR 触发 ci plan → test 环境手动验证 → /apply staging → staging 验证通过 → /apply prod
```

## 工作流基线
- 本地/CI 使用同一 Terraform 命令行。
- GitHub Actions 负责 fmt/init/plan/apply、拉取 kubeconfig、smoke test。
- 所有敏感值留在 tfvars/Secrets，不入库。

## 兼容说明
- 本文件取代对 `apps/docs/origin/BRN-004.dev_test_prod_design.md` 的直接引用，后续请以此为准。
- 其它选型（SigNoz、PostHog、Backstage、Cloudflare）保持不变。
