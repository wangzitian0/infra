# BRN-004: ç¯å¢ƒå³æœåŠ¡ (EaaS) è®¾è®¡ï¼ˆinfra ç‰ˆï¼‰

> **ç‰ˆæœ¬ï¼š** 1.0  
> **æœ€åæ›´æ–°ï¼š** 2025-12-04  
> **èŒƒå›´ï¼š** æœ¬ä»“åº“çš„ IaC/k8s è½åœ°ï¼Œå–ä»£ apps å­æ¨¡å—é‡Œçš„åŒåè®¾è®¡å¼•ç”¨ã€‚

## æ ¸å¿ƒå–èˆ
- è¿è¡Œæ—¶ï¼šä» Dokploy åˆ‡æ¢ä¸º **k3s + Kubero + Kubero UI**ï¼Œä¿æŒå• VPS å‹å¥½ï¼ŒåŒæ—¶è·å¾—åŸç”Ÿ k8s ç”Ÿæ€å’Œ GitOps ä½“éªŒã€‚
- IaCï¼šç»§ç»­ä½¿ç”¨ **Terraform + GitHub Actions**ï¼ŒR2 åš state backendã€‚
- è§‚æµ‹/äº§å“åˆ†æï¼šç»§ç»­é¢„ç•™ **SigNoz**ã€**PostHog**ï¼Œåç»­æŒ‰ BRN æ¼”è¿›ã€‚
- å¼€å‘è€…å…¥å£ï¼šé¢„ç•™ **Backstage**ï¼Œåç»­æŒ‰éœ€è¦æ¥å…¥ã€‚
- ç½‘ç»œï¼š**Cloudflare** ä½œä¸º DNS/CDN/WAFï¼Œä¸å˜ã€‚

## ä¸‰å±‚æ¶æ„ï¼ˆç°çŠ¶ä¸æ¼”è¿›ï¼‰
```
IaC: Terraform (+ GH Actions)
Runtime: k3s + Kubero + Kubero UI
Apps: PEG-scaner ä¸šåŠ¡é•œåƒ
```
- **å½“å‰ MVPï¼š** Terraform é€šè¿‡ SSH åœ¨ VPS å®‰è£… k3sï¼Œå¹¶ç”Ÿæˆ kubeconfigï¼›Kubero ä½œä¸º k8s PaaS å±‚ï¼ˆå¾…è½åœ°ï¼‰ã€‚
- **åç»­ï¼š** åœ¨ k3s éƒ¨ç½² Kubero/Kubero UI â†’ éƒ¨ç½² SigNoz/PostHog â†’ å¼•å…¥ Backstageã€‚

## ç»„ä»¶åŸºçº¿
| ç±»åˆ« | æ–¹æ¡ˆ | è¯´æ˜ |
|---|---|---|
| IaC | Terraform + Helm Provider | state å­˜ R2ï¼›æ‰€æœ‰ k8s èµ„æºé€šè¿‡ Terraform éƒ¨ç½² |
| Runtime | k3s + Kubero + Kubero UI | æ›¿ä»£ Dokployï¼ŒåŸç”Ÿ k8sï¼Œå¸¦ PaaS/UI |
| å¯†é’¥ç®¡ç† | Infisical | è‡ªæ‰˜ç®¡ï¼Œç‰ˆæœ¬å†å²ï¼Œç¯å¢ƒéš”ç¦» |
| ä¸»æ•°æ®åº“ | PostgreSQL | åº”ç”¨æ•°æ®åº“ + Infisical æ•°æ®åº“ |
| ç¼“å­˜ | Redis | æ ‡å‡†ç¼“å­˜å±‚ |
| å›¾æ•°æ®åº“ | Neo4j | å¯é€‰ï¼Œåº”ç”¨ä¾èµ– |
| Observability | SigNoz | OTel åŸç”Ÿï¼Œä¸€ä½“åŒ– APMï¼ˆåæœŸï¼‰ |
| Product Analytics | PostHog | å¼€æºè‡ªæ‰˜ç®¡ï¼ˆåæœŸï¼‰ |
| Portal | Backstage | é¢„ç•™ï¼ŒæŒ‰éœ€å¼•å…¥ |
| Network | Cloudflare | DNS/CDN/WAF |

## å½“å‰èŒƒå›´ï¼ˆBRN-004ï¼‰

èšç„¦ **Staging å®Œæ•´éƒ¨ç½²**ï¼Œäº”ç¯å¢ƒè‡ªåŠ¨åŒ–ï¼ˆdev/ci/test/prodï¼‰ç•™å¾… BRN-007ã€‚

| ç¯å¢ƒ | çŠ¶æ€ | ç›®æ ‡ |
|------|------|------|
| **staging** | âš™ï¸ è¿›è¡Œä¸­ | k3s + Infisical + æ•°æ®åº“ + Kubero å®Œæ•´è¿è¡Œ |
| **prod** | â³ åæœŸ | åŒ staging ç»“æ„ |
| **dev/ci/test** | ğŸ“‹ BRN-007 | å¤šç¯å¢ƒè‡ªåŠ¨åŒ– |

### Staging éƒ¨ç½²é¡ºåºï¼ˆphase å†…å¯å¹¶è¡Œï¼‰

| é˜¶æ®µ | ç›®æ ‡ | ç»„ä»¶ï¼ˆåŒé˜¶æ®µå†…å¯å¹¶è¡Œï¼‰ | å‰ç½® |
|------|------|------------------------|------|
| **Phase 0.x** | å¼•å¯¼ + å¯†é’¥åŸºçº¿ | k3sã€å¹³å° PostgreSQLï¼ˆInfisical/Kubero ç”¨ï¼‰ã€Infisical | - |
| **Phase 1.x** | ç®¡ç†å…¥å£ + PaaS | Kubernetes Dashboardã€Kuberoã€Kubero UIã€ä¸šåŠ¡ PostgreSQL | Phase 0.x |
| **Phase 2.x** | æ•°æ®æœåŠ¡ | Neo4jã€Redisã€ClickHouse | Phase 0.xï¼ˆè‹¥ç”± Kubero ç®¡ç†åº”ç”¨ï¼Œå»ºè®® 1.x å®Œæˆï¼‰ |
| **Phase 3.x** | è§‚æµ‹/åˆ†æ | SigNozã€PostHog | Phase 0.xï¼ˆéœ€è¦ Ingress/DNS æ—¶ä¾èµ– 1.xï¼‰ |

### Staging å‘½åç©ºé—´ï¼ˆ4 ä¸ªï¼‰

| å‘½åç©ºé—´ | ç”¨é€” |
|---------|------|
| `iac` | Infisical + PostgreSQL (Infisical DB)ï¼Œå…¨å±€å”¯ä¸€ |
| `data` | Redis + Neo4j |
| `kubero` | Kubero Controller + UI |
| `apps` | ç”¨æˆ·åº”ç”¨ï¼ˆæœªæ¥ï¼‰ |

### Staging åŸŸåæ–¹æ¡ˆ

Cloudflare å…è´¹ç‰ˆä»…æ”¯æŒä¸€çº§åŸŸåé€šé…ç¬¦ï¼Œä½¿ç”¨å‰ç¼€æ‹¼æ¥ï¼š

| æœåŠ¡ | åŸŸå |
|------|------|
| Kubero UI | `api-x-staging.truealpha.club` |
| Infisical | `cloud-x-staging.truealpha.club` |
| åº”ç”¨å‰ç«¯ï¼ˆæœªæ¥ï¼‰ | `x-staging.truealpha.club` |
| åº”ç”¨åç«¯ï¼ˆæœªæ¥ï¼‰ | `api-x-staging.truealpha.club` |

**ç”Ÿäº§ç¯å¢ƒ**åˆ™ä¸º `truealpha.club` å’Œ `api.truealpha.club`ï¼ˆæ— å‰ç¼€ï¼‰ã€‚

## å·¥ä½œæµåŸºçº¿
- æœ¬åœ°/CI ä½¿ç”¨åŒä¸€ Terraform å‘½ä»¤è¡Œã€‚
- GitHub Actions è´Ÿè´£ fmt/init/plan/applyã€æ‹‰å– kubeconfigã€smoke testã€‚
- æ‰€æœ‰æ•æ„Ÿå€¼ç•™åœ¨ tfvars/Secretsï¼Œä¸å…¥åº“ã€‚

## å…¼å®¹è¯´æ˜
- æœ¬æ–‡ä»¶å–ä»£å¯¹ `apps/docs/origin/BRN-004.dev_test_prod_design.md` çš„ç›´æ¥å¼•ç”¨ï¼Œåç»­è¯·ä»¥æ­¤ä¸ºå‡†ã€‚
- å…¶å®ƒé€‰å‹ï¼ˆSigNozã€PostHogã€Backstageã€Cloudflareï¼‰ä¿æŒä¸å˜ã€‚
