# DD-002: Infrastructure Workflow & Tooling Decisions

**Goal**: Consistent multi-env topology, GitOps workflow, self-hosted tooling.

## 1. Environments & Lifecycle

| Env | Type | Purpose | Lifecycle |
|---|---|---|---|
| **Dev** | Local/VM | Development | Persistent |
| **CI** | Ephemeral | Unit Tests | Minutes (Pipeline) |
| **Test** | Ephemeral | PR Preview | PR Duration |
| **Staging** | Persistent | Pre-prod | Persistent (Prod Mirror) |
| **Prod** | Persistent | Production | Persistent |

## 2. Terraform Architecture

**Structure**: Split into **Components** (Modules) and **Environments** (Composition).
- **Modules** (`components/`): Reusable logic (Network, DB, Apps).
- **Environments** (`envs/`):
    - `dev/`, `staging/`, `prod/`: Static environments.
    - `ci/`, `test/`: Dynamic/Template environments.
- **State**: Strictly isolated per environment (`state/system/<env>`).

## 3. Workflows (GitOps)

### CI / Test (Ephemeral)
- **Trigger**: Pull Request.
- **Action**: CI pipeline runs `terraform plan` -> `apply` -> `test`.
- **Cleanup**: `terraform destroy` on PR close/merge.

### Staging / Prod (Persistent)
- **Tool**: **Atlantis** (Self-Hosted).
- **Flow**:
    1.  PR to `main` -> Auto-Plan.
    2.  Review -> Comment `atlantis apply`.
    3.  Merge.
- **Promotion**: Verify in Staging before applying to Prod.

## 4. Responsibility Boundaries

| Scope | Owner | Tool | Example |
|---|---|---|---|
| **Infrastructure** | Ops / Infra | Terraform | Creating RDS, Redis, K8s, IAM |
| **Schema/Data** | App Dev | Framework (Django) | `python manage.py migrate` |

*Strategy*: Terraform provisions the empty DB instance; App pipeline applies schema migrations on startup.

## 5. Tool Selection: Atlantis

**Decision**: Start with **Atlantis** (Self-Hosted).
- **Why**:
    - Full control over execution environment (local R2 backend).
    - PR Locking prevents concurrent modification conflicts.
    - Simple comment-driven workflow.
- **Alternative**: Terrateam OSS (Consider later if complex orchestration needed).

## 6. Secret Management (Two-Tier)

**Tier 1: Bootstrap Secrets (L1)**
- **Source**: GitHub Secrets / Atlantis Env.
- **Use**: Creating the cluster (VPS Keys, Cloud Creds).

**Tier 2: Runtime Secrets (L2+)**
- **Source**: **Vault**.
- **Use**: Application logic (DB Passwords, API Keys).
- **Flow**: Vault (KV/Policies) -> Vault Agent Injector -> Pod.
