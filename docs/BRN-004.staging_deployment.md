# 完整架构设计：BRN-004 × BRN-007 × 所有选型

> **这是最终的全景架构设计**，整合了 BRN-004（Staging MVP）、BRN-007（五环境）以及所有基础设施、平台、观测等选型。

---

## 一、核心决策（不再更改）

### 1.1 技术栈选型

| 层级 | 组件 | 选择 | 理由 |
|------|------|------|------|
| **IaC** | Terraform + Helm Provider | 一切皆代码，R2 state backend，无手动 |
| **Runtime** | k3s + Kubero + Kubero UI | 单 VPS 友好 + 原生 k8s + PaaS UI |
| **密钥管理** | Infisical（自托管） | 版本历史、权限隔离、环境分离 |
| **主数据库** | PostgreSQL | 通用，容器化部署 |
| **缓存** | Redis | 标准，高可用 |
| **图数据库** | Neo4j（可选） | 应用依赖 |
| **可观测性** | SigNoz | OTel 原生，一体化 APM |
| **产品分析** | PostHog | 开源自托管 |
| **开发者门户** | Backstage（后期） | 平台工程入口 |
| **网络** | Cloudflare | DNS/CDN/WAF，免费版限制 |
| **CI/CD** | GitHub Actions + Atlantis（后期） | 轻量，权限严格 |

### 1.2 部署位置与生命周期

| 环境 | VPS | 数据 | k3s | 生命周期 | 用途 |
|------|------|------|------|----------|------|
| **dev** | 本地/VM | 本地 DB | 本地或虚拟 | 持久 | 开发者本地 |
| **ci** | GH Actions | 临时 | 容器内 | 分钟级 | PR 自动验证 |
| **test** | 临时 VPS | 临时 | 临时 | PR 生命周期 | PR 预览 |
| **staging** | 专用 VPS | prod dump | 持久 | 持久 | 预发测试，1:1 prod |
| **prod** | 专用 VPS | 真实 | 持久 | 持久 | 线上服务 |

### 1.3 域名规范（Cloudflare 免费版约束）

**规则**：`{prefix}-{env}.truealpha.club` 或 `{prefix}.truealpha.club`

| 环境 | Ingress 域名 | Infisical 域名 | SigNoz 域名 |
|------|------------|--------------|-----------|
| **prod** | `truealpha.club` | `cloud.truealpha.club` | `signoz.truealpha.club` |
| **staging** | `x-staging.truealpha.club` | `cloud-x-staging.truealpha.club` | `signoz-x-staging.truealpha.club` |
| **test** | `x-test.truealpha.club` | `cloud-x-test.truealpha.club` | 不部署 |
| **ci** | 无（容器内通讯） | 无（容器内通讯） | 无 |
| **dev** | `localhost` | `localhost` | 无 |

---

## 二、Kubernetes 命名空间（4 + 系统）

**全局唯一（不随环境复制）**：
- `iac` — Infisical + PostgreSQL (Infisical DB)，只在 staging/prod 部署

**随环境复制**（每个环境一套）：
- `data` — Redis + Neo4j
- `kubero` — Kubero Controller + UI
- `apps` — 用户应用
- `observability` — SigNoz + OTel Collector（staging/prod）
- `ingestion` — PostHog（staging/prod）

**系统**：
- `kube-system` — k3s 自动创建

---

## 三、部署阶段（4 + 扩展）

> Phase 内尽量无依赖，可并行交付；跨 phase 按 0.x → 1.x → 2.x → 3.x 递进。

### Phase 0.x：Bootstrap + 密钥基线
- 通过 Terraform SSH provisioner 在 VPS 安装 k3s
- 部署 Infisical（后续密码统一写入 Infisical）

### Phase 1.x：管理入口 + PaaS
- Kubernetes Dashboard
- Kubero Controller + Kubero UI
- 平台 PostgreSQL（Kubero/控制面所需 DB）

### Phase 2.x：数据服务
- 应用 PostgreSQL（业务库）
- Neo4j
- Redis
- ClickHouse

### Phase 3.x：观测/产品分析
- SigNoz
- PostHog

### Phase 999：应用部署（后期）
- 业务应用通过 Kubero UI 部署到 `apps` ns

---

## 四、Terraform 项目结构

```
terraform/
├── main.tf                          # 入口，环境判断逻辑
├── providers.tf                     # aws + helm + kubernetes
├── variables.tf                     # 全局变量
├── locals.tf                        # 计算域名、命名空间等
├── outputs.tf
├── backend.tf
│
├── staging.tfvars                   # 仅 staging 配置（.gitignored）
├── staging.tfvars.example           # 模板
│
├── phases/
│   ├── 0_bootstrap.tf              # k3s + Infisical
│   ├── 1_platform.tf               # Kubernetes Dashboard + Kubero + Kubero UI + 平台 PostgreSQL
│   ├── 2_data_services.tf          # PostgreSQL/Neo4j/Redis/ClickHouse
│   ├── 3_observability.tf          # SigNoz + PostHog（conditional）
│   └── variables.tf                # phases 共享变量
│
├── modules/
│   ├── kubernetes_namespaces.tf     # 创建 4 个 ns
│   └── helm_releases/
│       ├── postgresql.tf
│       ├── infisical.tf
│       ├── redis.tf
│       ├── neo4j.tf
│       ├── kubero.tf
│       ├── kubero_ui.tf
│       ├── signoz.tf
│       └── posthog.tf
│
├── scripts/
│   ├── install-k3s.sh.tmpl         # 现有
│   ├── apply-phase.sh              # 分阶段 apply
│   └── validate.sh                 # 验证脚本
│
└── output/                          # kubeconfig（gitignored）
```

---

## 五、部署流程

### Staging（BRN-004 MVP）

```bash
# 1. Init
terraform init \
  -backend-config="bucket=xxx" \
  -backend-config="key=staging/terraform.tfstate"

# 2. Phase 0.x（Bootstrap）
terraform apply -var-file="staging.tfvars" -target="module.k3s"
terraform apply -var-file="staging.tfvars" -target="module.infisical"

# 3. Phase 1.x（管理入口 + PaaS）
terraform apply -var-file="staging.tfvars" -target="module.kubernetes_dashboard"
terraform apply -var-file="staging.tfvars" -target="module.kubero,module.kubero_ui"
terraform apply -var-file="staging.tfvars" -target="module.platform_postgresql"

# 4. Phase 2.x（数据服务，按需挑选 target）
terraform apply -var-file="staging.tfvars" -target="module.postgresql_app,module.neo4j,module.redis,module.clickhouse"

# 5. Phase 3.x（观测/分析，可选）
terraform apply -var-file="staging.tfvars" -target="module.signoz,module.posthog"
```

> target 名称需与实际 Terraform 模块保持一致，此处按 phase 分组便于并行/分批 apply。

### 五环境扩展（BRN-007 后期）

创建 `dev.tfvars`、`ci.tfvars`、`test.tfvars`、`prod.tfvars`，使用相同的 phases 代码，仅改 tfvars。

```bash
terraform apply -var-file="prod.tfvars" -target="module.k3s"  # prod VPS
terraform apply -var-file="prod.tfvars" -target="module.postgresql"
# ... 后续 phases 相同逻辑
```

---

## 六、配置管理

### staging.tfvars 模板

```hcl
# VPS 基础
vps_host            = "staging-vps.internal"
vps_user            = "root"
ssh_port            = 22
ssh_private_key     = file("~/.ssh/id_rsa")

# k3s
cluster_name        = "staging-k3s"
k3s_channel         = "stable"
api_endpoint        = "api-x-staging.truealpha.club"

# 环境
environment         = "staging"
base_domain         = "truealpha.club"
domain_prefix       = "x-staging"

# 密钥（从 Infisical 后续管理）
postgres_password   = "change-me"
redis_password      = "change-me"
neo4j_password      = "change-me"

# 存储
postgres_storage    = "50Gi"
redis_storage       = "20Gi"
neo4j_storage       = "100Gi"

# 特性开关
enable_observability = true
enable_backstage     = false
```

---

## 七、Ingress 与域名映射

Traefik/Nginx 自动生成 Ingress Route（通过 Helm values）：

**Staging 示例**：
```
cloud-x-staging.truealpha.club → Infisical
api-x-staging.truealpha.club   → Kubero UI + API
signoz-x-staging.truealpha.club → SigNoz
posthog-x-staging.truealpha.club → PostHog
x-staging.truealpha.club        → 应用前端（后期）
```

每个服务的 Helm values 自动计算：
```hcl
locals {
  ingress_hosts = {
    infisical = "${var.domain_prefix == "" ? "cloud" : "cloud-${var.domain_prefix}"}.${var.base_domain}"
    kubero    = "${var.domain_prefix == "" ? "api" : "api-${var.domain_prefix}"}.${var.base_domain}"
    signoz    = "${var.domain_prefix == "" ? "signoz" : "signoz-${var.domain_prefix}"}.${var.base_domain}"
  }
}
```

---

## 八、数据流与依赖链

```
Cloudflare (SaaS)
    ↓
Traefik/Ingress
    ↓
┌─────────────────────────────────────┐
│ k3s (single node)                   │
├─────────────────────────────────────┤
│ iac ns:                             │
│ ├─ Infisical → PostgreSQL (IaC DB) │
│                                     │
│ data ns:                            │
│ ├─ Redis                            │
│ ├─ Neo4j                            │
│                                     │
│ kubero ns:                          │
│ ├─ Kubero Controller ────→ Infisical
│ ├─ Kubero UI                        │
│                                     │
│ apps ns:                            │
│ ├─ PEG-Scanner ─→ PostgreSQL        │
│ ├─            ─→ Redis              │
│ ├─            ─→ SigNoz (trace)     │
│                                     │
│ observability ns:                   │
│ ├─ SigNoz + ClickHouse              │
│ └─ OTel Collector                   │
│                                     │
│ ingestion ns:                       │
│ └─ PostHog + PostgreSQL + Redis     │
└─────────────────────────────────────┘
```

---

## 九、初始化检查清单

### 基础准备
- [ ] Staging VPS：Ubuntu 22.04+，公网 IP，SSH
- [ ] Cloudflare：`*.truealpha.club` 通配符 DNS + SSL 证书
- [ ] R2：bucket 创建，state key 路径：`staging/terraform.tfstate`
- [ ] GitHub Secrets：R2 凭据、VPS SSH key

### Phase 执行
- [ ] Phase 0.x：k3s 运行，kubeconfig 可用，Infisical UI 可访问
- [ ] Phase 1.x：Kubernetes Dashboard、Kubero、Kubero UI、平台 PostgreSQL 就绪
- [ ] Phase 2.x：PostgreSQL/Neo4j/Redis/ClickHouse 就绪（按需选择）
- [ ] Phase 3.x：SigNoz + PostHog UI 可访问（可选）
- [ ] Phase 999：业务应用通过 Kubero 上线（可选）

---

## 十、后续演进（五环境、应用部署）

### BRN-007：多环境自动化
1. 创建 5 套 tfvars（dev/ci/test/staging/prod）
2. GitHub Actions 工作流支持多环境 plan/apply
3. 评论驱动 `/plan`、`/apply staging`、`/apply prod`

### 应用部署
1. 通过 Kubero UI 连接 GitHub 仓库（apps submodule）
2. 配置 Infisical 集成，读取密钥
3. GitOps 自动部署

### 可观测性成熟
1. 应用接入 OTel SDK，发送 trace 到 SigNoz
2. PostHog 事件采集配置
3. Backstage Service Catalog 管理

---

## 十一、成本与扩展

### 单 VPS 成本（当前）
- VPS（Hetzner/OCI）：$5-20/月
- Cloudflare 免费版：$0
- R2 存储（state + 备份）：<$1/月
- **总计**：<$25/月

### 长期扩展路径
1. **6 个月**：PostgreSQL 托管化（Neon）+ Redis 托管化（Upstash）
2. **12 个月**：SigNoz 独立 VPS，多应用 VPS
3. **24 个月**：多 AZ，完整 Kubernetes 集群

---

**完成日期**：2025-12-05
**下一步**：编写 Terraform phases 代码
