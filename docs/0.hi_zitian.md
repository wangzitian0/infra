# éœ€è¦ Zitian åšçš„äº‹æƒ…

## âœ… å·²æœ‰èµ„æº

- âœ… VPS: HostHatch (cloud.hosthatch.com)
- âœ… Cloudflare è´¦å·

## ğŸ¯ ç®€åŒ–åçš„é…ç½®æ­¥éª¤

ç”±äºæ‚¨å·²æœ‰ VPS å’Œ Cloudflareï¼Œé…ç½®ä¼šç®€å•å¾ˆå¤šï¼

### é…ç½®ç­–ç•¥è¯´æ˜

**å…³äº VPS ç®¡ç†:**
- HostHatch æ²¡æœ‰å®˜æ–¹ Terraform Provider
- å»ºè®®ï¼šVPS æ‰‹åŠ¨ç®¡ç†ï¼ŒTerraform ä¸»è¦ç®¡ç† Cloudflare DNS/CDN/WAF
- æ‚¨çš„ç°æœ‰ VPS å¯ä»¥ç›´æ¥ç”¨äºéƒ¨ç½²åº”ç”¨

**å…³äº Terraform State:**
- åˆæœŸå¯ä»¥ä½¿ç”¨ local backendï¼ˆå·²é…ç½®ï¼‰
- åæœŸå¯ä»¥è¿ç§»åˆ° Cloudflare R2ï¼ˆå…è´¹ 10GBï¼‰

---

## ğŸ“‹ å¿…é¡»å®Œæˆçš„é…ç½®

### 1. Cloudflare API Token âš¡

**æ­¥éª¤:**
1. ç™»å½• Cloudflare Dashboard
2. è¿›å…¥ **My Profile** â†’ **API Tokens** â†’ **Create Token**
3. ä½¿ç”¨ **Edit zone DNS** æ¨¡æ¿
4. é€‰æ‹©æ‚¨è¦ç®¡ç†çš„åŸŸå
5. åˆ›å»ºå¹¶**å¤åˆ¶ Token**ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼ï¼‰

**åŒæ—¶è·å– Zone ID:**
- åœ¨åŸŸåæ¦‚è§ˆé¡µé¢ï¼Œå³ä¾§æ å¯ä»¥çœ‹åˆ° **Zone ID**
- å¤åˆ¶ä¿å­˜

ğŸ“ **è®°å½•ä¸‹æ¥**:
```
CLOUDFLARE_API_TOKEN=your_token_here
CLOUDFLARE_ZONE_ID=your_zone_id_here
DOMAIN=your_domain.com
```


### 2. VPS SSH è®¿é—®é…ç½® ğŸ”‘

ç”±äºä½¿ç”¨ç°æœ‰ VPSï¼Œéœ€è¦é…ç½® SSH è®¿é—®ï¼š

1. **è·å– VPS IP åœ°å€**
   - ç™»å½• HostHatch æ§åˆ¶é¢æ¿
   - è®°å½•æ‚¨çš„ VPS IP åœ°å€

2. **é…ç½® SSH å¯†é’¥**ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
   ```bash
   # ç”Ÿæˆ SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
   ssh-keygen -t ed25519 -C "zitian@truealpha"
   
   # å¤åˆ¶å…¬é’¥åˆ° VPS
   ssh-copy-id root@<your-vps-ip>
   
   # æµ‹è¯•è¿æ¥
   ssh root@<your-vps-ip>
   ```

3. **å®‰è£… Docker å’Œ Dokploy**ï¼ˆåœ¨ VPS ä¸Šæ‰§è¡Œï¼‰
   ```bash
   # å®‰è£… Docker
   curl -fsSL https://get.docker.com | sh
   
   # å®‰è£… Dokploy
   curl -sSL https://dokploy.com/install.sh | sh
   ```

ğŸ“ **è®°å½•ä¸‹æ¥**:
```
VPS_IP=your_vps_ip_here
SSH_USER=root
```

---

### 3. Terraform é…ç½®æ–‡ä»¶å¡«å†™ ğŸ“

åˆ›å»º Terraform é…ç½®æ–‡ä»¶ï¼š

```bash
cd terraform/envs/dev
cp terraform.tfvars.example terraform.tfvars
vim terraform.tfvars
```

**å¡«å†™å†…å®¹**:
```hcl
environment = "dev"
project_name = "truealpha"
domain = "your_domain.com"  # æ‚¨çš„å®é™…åŸŸå

# Cloudflareï¼ˆä½¿ç”¨æ­¥éª¤ 1 è·å–çš„å€¼ï¼‰
cloudflare_api_token = "your_cloudflare_api_token"
cloudflare_zone_id = "your_cloudflare_zone_id"

# VPSï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼Œä»…ç”¨äºè®°å½•ï¼‰
vps_count = 0  # è®¾ä¸º 0ï¼Œå› ä¸ºæ‰‹åŠ¨ç®¡ç†
vps_size = "manual"
vps_region = "manual"
ssh_keys = []

# æ•°æ®åº“ï¼ˆä½¿ç”¨ Dockerï¼Œä¸éœ€è¦æ‰˜ç®¡æœåŠ¡ï¼‰
enable_managed_database = false
enable_monitoring = true

tags = {
  Environment = "dev"
  Project     = "truealpha"
  ManagedBy   = "terraform"
  Owner       = "zitian"
}
```

---

### 4. Infisical é…ç½® ğŸ”

**æ¨èï¼šä½¿ç”¨ Infisical Cloudï¼ˆæœ€å¿«ï¼‰**

```bash
# 1. å®‰è£… CLI
brew install infisical/tap/infisical

# 2. ç™»å½•
infisical login

# 3. åˆ›å»ºé¡¹ç›®ï¼ˆåœ¨ Web UIï¼‰
# è®¿é—® https://app.infisical.com
# åˆ›å»º Organization â†’ Project â†’ Environments (dev/test/staging/prod)

# 4. å¡«å†™ç¯å¢ƒå˜é‡
# åœ¨ Infisical Web UI ä¸­ï¼Œå¤åˆ¶ secrets/.env.example çš„å†…å®¹
# ä¸ºæ¯ä¸ªç¯å¢ƒå¡«å†™å¯¹åº”çš„å€¼

# 5. æµ‹è¯•å¯¼å‡º
./scripts/deploy/export-secrets.sh dev
```

**å…³é”®ç¯å¢ƒå˜é‡**ï¼ˆåœ¨ Infisical ä¸­é…ç½®ï¼‰:
- `PEG_ENV=development`
- `DB_TABLE_PREFIX=dev_`
- `NEO4J_PASSWORD=<ç”Ÿæˆå¼ºå¯†ç >`
- `POSTGRES_PASSWORD=<ç”Ÿæˆå¼ºå¯†ç >`
- `REDIS_PASSWORD=<ç”Ÿæˆå¼ºå¯†ç >`
- `API_DOMAIN=api.your_domain.com`

---

## ğŸš€ é¦–æ¬¡éƒ¨ç½²ï¼ˆç®€åŒ–ç‰ˆï¼‰

### Step 1: é…ç½® Cloudflare DNS

```bash
cd terraform/envs/dev

# åˆå§‹åŒ– Terraform
terraform init

# æŸ¥çœ‹è®¡åˆ’ï¼ˆä»…åˆ›å»º DNS è®°å½•ï¼Œä¸åˆ›å»º VPSï¼‰
terraform plan -var-file=terraform.tfvars

# åº”ç”¨ï¼ˆåˆ›å»º Cloudflare DNS è®°å½•ï¼‰
terraform apply -var-file=terraform.tfvars
```

è¿™ä¼šåˆ›å»ºï¼š
- `dev.your_domain.com` â†’ æŒ‡å‘æ‚¨çš„ VPS IP
- `api.dev.your_domain.com` â†’ API ç«¯ç‚¹

### Step 2: éƒ¨ç½²åº”ç”¨åˆ° VPS

```bash
# è¿”å› infra æ ¹ç›®å½•
cd ../../..

# å¯¼å‡ºç¯å¢ƒå˜é‡
./scripts/deploy/export-secrets.sh dev

# SSH åˆ° VPS
ssh root@<your-vps-ip>

# åœ¨ VPS ä¸Šï¼šåˆ›å»ºç›®å½•
mkdir -p /opt/truealpha
exit

# å¤åˆ¶æ–‡ä»¶åˆ° VPS
scp -r compose scripts .env.dev root@<your-vps-ip>:/opt/truealpha/

# SSH å› VPS å¹¶éƒ¨ç½²
ssh root@<your-vps-ip>
cd /opt/truealpha
./scripts/deploy/deploy.sh dev
```

### Step 3: éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker compose -p truealpha-dev ps

# æŸ¥çœ‹æ—¥å¿—
docker compose -p truealpha-dev logs -f backend

# æµ‹è¯• API
curl http://localhost:8000/health
```

### Step 4: é…ç½® Traefikï¼ˆå¯é€‰ï¼Œç”¨äºè‡ªåŠ¨ SSLï¼‰

å¦‚æœ VPS ä¸Šè¿˜æ²¡æœ‰é…ç½®åå‘ä»£ç†ï¼š

```bash
# åœ¨ VPS ä¸Šåˆ›å»º Traefik
cd /opt/truealpha
# Dokploy å·²ç»å†…ç½® Traefikï¼Œç›´æ¥ä½¿ç”¨å³å¯
```

---

## ğŸ“‹ åç»­ä»»åŠ¡æ¸…å•

### ç«‹å³å¯åš

- [ ] è·å– Cloudflare API Token å’Œ Zone ID
- [ ] é…ç½® VPS SSH è®¿é—®
- [ ] å¡«å†™ `terraform/envs/dev/terraform.tfvars`
- [ ] åœ¨ Infisical ä¸­é…ç½®ç¯å¢ƒå˜é‡
- [ ] è¿è¡Œ Terraform åˆ›å»º DNS è®°å½•
- [ ] éƒ¨ç½²åº”ç”¨åˆ° VPS

### å¯é€‰é…ç½®

- [ ] é…ç½® GitHub Secretsï¼ˆç”¨äº CI/CDï¼‰
- [ ] éƒ¨ç½² SigNoz (å¯è§‚æµ‹æ€§)
- [ ] éƒ¨ç½² PostHog (äº§å“åˆ†æ)
- [ ] éƒ¨ç½² Atlantis (Terraform è‡ªåŠ¨åŒ–)

---

### 3. Infisical éƒ¨ç½²

**æ–¹å¼ 1: ä½¿ç”¨ Infisical Cloud (æ¨èå¿«é€Ÿå¼€å§‹)**
- [ ] è®¿é—® https://app.infisical.com æ³¨å†Œè´¦å·
- [ ] åˆ›å»º Organization å’Œ Project
- [ ] ä¸ºæ¯ä¸ªç¯å¢ƒ (dev/test/staging/prod) åˆ›å»º Environment
- [ ] å®‰è£… CLI: `brew install infisical/tap/infisical`
- [ ] ç™»å½•: `infisical login`

**æ–¹å¼ 2: è‡ªæ‰˜ç®¡éƒ¨ç½²**
- [ ] å‚è€ƒå®˜æ–¹æ–‡æ¡£éƒ¨ç½² Infisical: https://infisical.com/docs/self-hosting/overview
- [ ] åˆ›å»º Project å’Œ Environments

**é…ç½®å®Œæˆå:**
- [ ] å°† `secrets/.env.example` ä¸­çš„é…ç½®å¯¼å…¥åˆ° Infisical
- [ ] æµ‹è¯•å¯¼å‡º: `./scripts/deploy/export-secrets.sh dev`

---

### 4. GitHub Secrets é…ç½®

åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹ Secrets (Settings â†’ Secrets and variables â†’ Actions):

- [ ] `INFISICAL_CLIENT_ID` - Infisical çš„ Client ID
- [ ] `INFISICAL_CLIENT_SECRET` - Infisical çš„ Client Secret  
- [ ] `INFISICAL_PROJECT_ID` - Infisical é¡¹ç›® ID
- [ ] `SSH_PRIVATE_KEY` - éƒ¨ç½²ç”¨çš„ SSH ç§é’¥
- [ ] `SSH_USER` - SSH ç™»å½•ç”¨æˆ·å (é€šå¸¸æ˜¯ root æˆ– ubuntu)
- [ ] `SSH_HOST` - VPS çš„ IP åœ°å€
- [ ] `CLOUDFLARE_API_TOKEN` - Cloudflare API Token
- [ ] `TF_STATE_BUCKET` - Terraform State å­˜å‚¨æ¡¶åç§°

---

### 5. é¦–æ¬¡éƒ¨ç½²

#### Step 1: åˆå§‹åŒ– Terraform

```bash
cd terraform/envs/dev
terraform init
terraform plan -var-file=terraform.tfvars
terraform apply -var-file=terraform.tfvars
```

#### Step 2: éƒ¨ç½²åº”ç”¨

```bash
cd ../../..  # å›åˆ° infra æ ¹ç›®å½•
./scripts/deploy/deploy.sh dev
```

#### Step 3: éªŒè¯éƒ¨ç½²

```bash
docker compose -p truealpha-dev ps
curl http://localhost:8000/health
```

---

## ğŸ“‹ å¾…å†³ç­–äº‹é¡¹

### VPS é…ç½®å»ºè®®

æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µï¼Œå»ºè®®é…ç½®ï¼š

| ç¯å¢ƒ | æ¨èè§„æ ¼ | æœˆè´¹ç”¨ä¼°ç®— |
|------|---------|-----------|
| dev | æœ¬åœ° Docker | $0 |
| test | å…±äº« staging | $0 |
| staging | 2vCPU 4GB | ~$20 |
| prod | 4vCPU 8GB | ~$60 |

### Terraform State Backend é€‰æ‹©

**é€‰é¡¹ 1: AWS S3 (æ¨èç”Ÿäº§ä½¿ç”¨)**
- é«˜å¯é æ€§
- æ”¯æŒ State Lock (éœ€ DynamoDB)
- è´¹ç”¨: ~$1/æœˆ

**é€‰é¡¹ 2: Cloudflare R2 (æ¨èæ€§ä»·æ¯”)**
- å…è´¹ 10GB å­˜å‚¨
- S3 å…¼å®¹ API
- è´¹ç”¨: å…è´¹æˆ– ~$0.5/æœˆ

**é€‰é¡¹ 3: Local (ä»…å¼€å‘æµ‹è¯•)**
- é›¶æˆæœ¬
- ä¸é€‚åˆå›¢é˜Ÿåä½œ
- å½“å‰é»˜è®¤é…ç½®

**éœ€è¦æ‚¨å†³ç­–:**
- [ ] é€‰æ‹© State Backend æ–¹æ¡ˆ
- [ ] é…ç½®å¯¹åº”çš„ `terraform/backend.tf`

---

## ğŸš€ å¯é€‰éƒ¨ç½² (Phase 2)

è¿™äº›ç»„ä»¶å·²æœ‰é…ç½®ï¼Œä½†éœ€è¦é¢å¤–éƒ¨ç½²ï¼š

### SigNoz (å¯è§‚æµ‹æ€§å¹³å°)

```bash
cd observability/signoz
# ä¸‹è½½å®˜æ–¹ docker-compose
curl -L https://github.com/SigNoz/signoz/releases/latest/download/clickhouse-setup.tar.gz | tar xz
docker compose -f docker-compose.yaml up -d
```

### PostHog (äº§å“åˆ†æ)

```bash
cd analytics/posthog
# ä¸‹è½½å®˜æ–¹ docker-compose
curl -L https://posthog.com/docker-compose.yml -o docker-compose.yaml
docker compose up -d
```

### Atlantis (Terraform PR è‡ªåŠ¨åŒ–)

```bash
cd ci/atlantis
# éœ€è¦å…ˆé…ç½® GitHub webhook
# å‚è€ƒ: https://www.runatlantis.io/docs/deployment.html
```

---

## ğŸ“ æœ‰é—®é¢˜ï¼Ÿ

å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. [æ¶æ„æ–‡æ¡£](architecture.md) - äº†è§£ç³»ç»Ÿè®¾è®¡
2. [å¼€å‘è€…æŒ‡å—](guides/developer-onboarding.md) - è¯¦ç»†æ­¥éª¤
3. [è¿ç»´æ‰‹å†Œ](runbooks/operations.md) - æ•…éšœæ’æŸ¥

æˆ–è€…ç›´æ¥é—®æˆ‘ ğŸ˜„
