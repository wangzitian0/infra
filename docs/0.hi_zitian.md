# 准备并跑通 k3s 部署

## What
- 按固定顺序完成：① 配好 R2 后端 ② 准备 VPS ③ 填 Repository Secrets ④ 触发 CI 部署 k3s，拿 kubeconfig。

## Why
- GitHub Actions + Terraform 自动在 VPS 装单节点 k3s，并把 kubeconfig 拉回。
- 远程 state 统一用 Cloudflare R2（S3 兼容，无锁）；若要锁请改用 S3+DynamoDB 或 Terraform Cloud。

## Who
- 你（Zitian）提供 VPS、SSH 权限、域名 DNS、Secrets、R2 凭据。

## When
- 在第一次成功获取 kubeconfig 且 `kubectl get nodes` 通过前完成所有信息准备。后续 VPS/域名/密钥变化时同步更新 Secrets。

## Where
- terraform/backend.tf：已入库，bucket/endpoint 通过 `-backend-config` 传入。
- VPS：实际机器/云主机，开放 22、6443。
- GitHub Repository Secrets：存放 R2 凭据 + SSH key + VPS 信息 + k3s 参数。
- DNS：如使用域名访问 API，则将 `K3S_API_ENDPOINT` 指向 VPS（否则默认用 `VPS_HOST`）。

## How
1) R2 backend：`backend.tf` 已入库，运行 `terraform init` 时通过 `-backend-config` 传入 bucket/endpoint。R2 无锁，若需锁改用 S3+DynamoDB/TF Cloud。
2) VPS：公网 IP/域名，开放 22/tcp 与 6443/tcp，Ubuntu 22.04+，账户可 sudo。
3) Repository Secrets（必填 R2 + VPS，k3s 可选）：
   - R2（必填）：`AWS_ACCESS_KEY_ID`、`AWS_SECRET_ACCESS_KEY`、`R2_BUCKET`、`R2_ACCOUNT_ID`
   - VPS（必填）：`VPS_HOST`（IP/域名）、`VPS_SSH_KEY`（私钥内容，具 sudo）
   - VPS（可选）：`VPS_USER`(默认 root)、`VPS_SSH_PORT`(默认 22)
   - k3s（可选）：`K3S_API_ENDPOINT`(默认 `VPS_HOST`，填域名需配 DNS)、`K3S_CHANNEL`(默认 stable)、`K3S_VERSION`(空则随 channel)、`K3S_CLUSTER_NAME`(默认 truealpha-k3s)
4) DNS：如需域名访问 API，将 `K3S_API_ENDPOINT` 指向 VPS；否则用 `VPS_HOST` 即可。  
5) CI：触发 `Deploy k3s to VPS`（push main 或手动），下载 kubeconfig artifact（`terraform/output/<cluster>-kubeconfig.yaml`），本地 `export KUBECONFIG=... && kubectl get nodes` 验证。  
6) 本地干跑/执行：
   - 复制 tfvars：`cp terraform/terraform.tfvars.example terraform/terraform.tfvars` 并填入 VPS/SSH 信息
   - 设置环境变量：`export AWS_ACCESS_KEY_ID=... AWS_SECRET_ACCESS_KEY=... R2_BUCKET=... R2_ACCOUNT_ID=...`
   - 初始化并部署：`cd terraform && terraform init -backend-config="bucket=$R2_BUCKET" -backend-config="endpoints={s3=\"https://$R2_ACCOUNT_ID.r2.cloudflarestorage.com\"}" && terraform plan && terraform apply`
   - plan 不会执行 provisioner；apply 才会连接 VPS。`TF_VAR_ssh_private_key` 需保留换行，可用 `\n` 逃逸或 tfvars 多行。

## hint
- R2 需先建 bucket + API Token（S3 权限），填入 GitHub Secrets（`AWS_ACCESS_KEY_ID`、`AWS_SECRET_ACCESS_KEY`、`R2_BUCKET`、`R2_ACCOUNT_ID`）。
- R2 无锁；需要锁改用 S3+DynamoDB 或 Terraform Cloud。
- `K3S_API_ENDPOINT` 可空（默认 VPS_HOST）；填域名需配 DNS。
- 防火墙务必放行 22、6443。Secrets 更新后需重跑 CI 以刷新 kubeconfig。

---

## BRN-004 Staging 部署决策（已确定 ✅）

### 基础设施选型

| 组件 | 选择 |
|------|------|
| 应用管理 | Kubero（k8s PaaS） |
| 密钥管理 | Infisical（自托管） |
| 主数据库 | PostgreSQL |
| 缓存 | Redis |
| 图数据库 | Neo4j |
| 部署工具 | Terraform + Helm Provider |
| 管理入口 | Kubero UI + Infisical UI |

### 待准备事项

- [ ] Staging VPS：Ubuntu 22.04+，公网 IP，SSH 访问
- [ ] Cloudflare：`staging.x.truealpha.club` 和 `*.staging.x.truealpha.club` DNS 指向 VPS
- [ ] SSL 证书：通配符 `*.staging.x.truealpha.club`
- [ ] R2：state key 配置为 `staging/terraform.tfstate`
- [ ] GitHub Secrets：R2 凭据 + VPS SSH key
- [ ] 初始化：Phase 0 → Phase 1-3 按顺序部署
