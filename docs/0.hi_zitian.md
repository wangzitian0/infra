# 准备并跑通 k3s 部署

## What
- 准备一台可 SSH 的 VPS，开放 22/6443，允许 k3s API 访问。
- 配置 GitHub Secrets（SSH 私钥、主机信息、可选 k3s 参数）。
- 如需远程 state，准备 Cloudflare R2（S3 兼容）或其他后端信息。
- 触发 CI 工作流，验证 kubeconfig 获取与 `kubectl get nodes`。

## Why
- 让 GitHub Actions + Terraform 自动在 VPS 装好单节点 k3s，并把 kubeconfig 拉回。
- 远程 state 避免本地 state 丢失；R2 可用但无锁，需锁时改用 S3+DynamoDB 或 Terraform Cloud。

## Who
- 你（Zitian）提供 VPS、SSH 权限、域名 DNS、Secrets、R2 凭据。

## When
- 在第一次成功获取 kubeconfig 且 `kubectl get nodes` 通过前完成所有信息准备。后续 VPS/域名/密钥变化时同步更新 Secrets。

## Where
- VPS：实际机器/云主机，开放 22、6443。
- GitHub 仓库 Secrets：存放 SSH key、VPS 信息、k3s 参数、R2 凭据。
- DNS：将 `K3S_API_ENDPOINT` 指向 VPS（或使用 IP）。

## How
1) VPS：提供公网 IP/域名，开放 22/tcp 与 6443/tcp，Ubuntu 22.04+，账户可 sudo。  
2) Secrets：  
   - 必填：`VPS_HOST`（IP/域名）、`VPS_SSH_KEY`（私钥内容，具 sudo）。  
   - 可选：`VPS_USER`(默认 root)、`VPS_SSH_PORT`(默认 22)、`K3S_API_ENDPOINT`(默认 VPS_HOST)、`K3S_CHANNEL`(默认 stable)、`K3S_VERSION`(空则跟随 channel)、`K3S_CLUSTER_NAME`(默认 truealpha-k3s)。  
   - 远程 state（R2 可选）：`AWS_ACCESS_KEY_ID`、`AWS_SECRET_ACCESS_KEY`，以及在 backend 中配置 R2 endpoint/bucket/key。  
3) DNS：把 `K3S_API_ENDPOINT` 指向 VPS。  
4) CI：触发 `Deploy k3s to VPS` 工作流（push main 或手动），下载 kubeconfig artifact（`terraform/output/<cluster>-kubeconfig.yaml`），本地 `export KUBECONFIG=... && kubectl get nodes` 验证。

## hint
- 若接受“无锁”可用 R2 作为 state；需要锁定则用 S3+DynamoDB 或 Terraform Cloud。  
- kube-apiserver 用域名更利于后续 IP 变更；防火墙务必放行 22、6443。  
- Secrets 更新后需重新跑 CI 以重新拉 kubeconfig。  
