# éœ€è¦ Zitian åšçš„äº‹æƒ…

## âœ… å·²æœ‰èµ„æº

- âœ… VPS: HostHatch (cloud.hosthatch.com)
- âœ… Cloudflare è´¦å·

## ğŸ¯ é…ç½®æ­¥éª¤ï¼ˆå…¨è‡ªæ‰˜ç®¡ï¼ŒTerraform ç®¡ç†ï¼Œè‡ªæ‰˜ç®¡ Infisicalï¼‰

1) **Cloudflare API Token / Zone ID**  
   - Cloudflare â†’ My Profile â†’ API Tokens â†’ Create Tokenï¼ˆæ¨¡æ¿: Edit zone DNSï¼‰  
   - è®°å½• `CLOUDFLARE_API_TOKEN`ã€`CLOUDFLARE_ZONE_ID`

2) **VPS SSH è®¿é—®**  
   - è·å– VPS IPï¼ˆHostHatch æ§åˆ¶é¢æ¿ï¼‰  
   - å¦‚æ— å¯†é’¥ï¼Œç”Ÿæˆå¹¶ä¸‹å‘ï¼š  
   ```bash
   ssh-keygen -t ed25519 -C "zitian@truealpha"
   ssh-copy-id root@<vps-ip>
   ssh root@<vps-ip>
   ```

3) **å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆä¸€æ¬¡æ€§ï¼Œå•å° VPSï¼‰**  
   ```bash
   curl -fsSL https://get.docker.com | sh        # Docker
   curl -sSL https://dokploy.com/install.sh | sh # Dokploy + Traefik
   ```

4) **è‡ªæ‰˜ç®¡ Infisicalï¼ˆå®¹å™¨ï¼ŒDokploy API è‡ªåŠ¨åŒ–ï¼‰**  
   - åœ¨ `terraform/envs/staging/terraform.tfvars` å¡«å†™ï¼š`enable_dokploy_infisical=true`ã€`dokploy_api_key`ã€`dokploy_ssh_*`ã€Infisical ç®¡ç†å‘˜è´¦å·/åŠ å¯†é’¥åŒ™/DB/Redis å¯†ç ç­‰ã€‚  
   - Terraform ä¼šè°ƒç”¨ `scripts/dokploy/bootstrap_infisical.sh`ï¼šåˆ›å»º SSH Key/Server/Project/Environmentï¼Œä¸Šä¼  `compose/platform/infisical.yml` å¹¶éƒ¨ç½²åˆ° `secrets.truealpha.club`ã€‚  
   - éƒ¨ç½²å®Œæˆååœ¨ Infisical UI å¯¼å…¥ `secrets/.env.example` å…¨éƒ¨å˜é‡ï¼ŒæŒ‰ç¯å¢ƒåˆ›å»º Machine Identity (MI)ï¼Œè®°å½• Client ID/Secret/Project IDã€‚

5) **GitHub Secretsï¼ˆæœ€å°åŒ–ï¼‰**  
   Settings â†’ Secrets and variables â†’ Actions ä»…æ·»åŠ ï¼š  
   - `INFISICAL_CLIENT_ID`  
   - `INFISICAL_CLIENT_SECRET`  
   - `INFISICAL_PROJECT_ID`  
   > SSH/Cloudflare/DB/åº”ç”¨ç­‰å…¨éƒ¨ç•™åœ¨è‡ªæ‰˜ç®¡ Infisicalã€‚

6) **Terraformï¼ˆä» staging å¼€å§‹ï¼Œç®¡ç† Cloudflare/DNS/WAF/Dokploy/Infisicalï¼‰**  
   ```bash
   cd terraform/envs/staging   # å…ˆåš stagingï¼Œå† test/prod
   terraform init
   terraform plan
   terraform apply
   ```

7) **åº”ç”¨éƒ¨ç½²ï¼ˆå…¨è‡ªåŠ¨ï¼Œæ—  UIï¼‰**  
   ```bash
./scripts/deploy/export-secrets.sh staging   # ä»è‡ªæ‰˜ç®¡ Infisical æ‹‰å–å…¨éƒ¨å˜é‡
./scripts/deploy/deploy.sh staging           # è„šæœ¬åº”ç”¨ composeï¼ˆæ—  UIï¼‰
   ```

8) **éªŒè¯**  
   ```bash
   dig x-staging.truealpha.club
   curl -I https://x-staging.truealpha.club
   curl https://api-x-staging.truealpha.club/graphql
   ```

## ğŸ“Œ å…³é”®è§„åˆ™
- åŸŸåï¼ˆæ‰å¹³ï¼‰ï¼štest `x-test.*` + PR `x-test-*.*`ï¼›staging `x-staging.*`ï¼›prod `truealpha.*`
- GitHub Secrets ä»… MI ä¸‰å…ƒç»„ï¼›å…¶ä»–å¯†é’¥å‡åœ¨è‡ªæ‰˜ç®¡ Infisicalã€‚
- Dokploy éƒ¨ç½²é€šè¿‡è„šæœ¬/CI è°ƒç”¨ deploy.shï¼ˆcomposeï¼‰ï¼Œé¿å… UI ç‚¹é€‰ã€‚

## ğŸ—’ï¸ å¾…åŠï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
- [ ] å®Œæˆ Cloudflare Token/Zone ID
- [ ] å®Œæˆ VPS SSH é…ç½®
- [ ] åœ¨ `terraform.tfvars` å¡« Dokploy API Key + Infisical ç®¡ç†å‘˜/DB/Redis å¯†é’¥
- [ ] éƒ¨ç½²è‡ªæ‰˜ç®¡ Infisical å¹¶åˆ›å»º MIï¼ˆTerraform è§¦å‘ Dokploy APIï¼‰
- [ ] å¡«å†™ GitHub Secretsï¼ˆMI ä¸‰å…ƒç»„ï¼‰
- [ ] è¿è¡Œ Terraformï¼ˆstaging â†’ test â†’ prodï¼‰
- [ ] éƒ¨ç½² staging åº”ç”¨å¹¶éªŒè¯
- [ ] éƒ¨ç½² SigNoz / PostHogï¼ˆè‡ªæ‰˜ç®¡ï¼‰
