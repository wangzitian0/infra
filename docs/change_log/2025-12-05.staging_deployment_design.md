# 2025-12-05 — Staging 部署设计确定

## 做了什么

- 聚焦 **BRN-004 → Staging 完整部署**，暂不涉及五环境（BRN-007）
- Phase 命名：0, 1.1, 1.2, 2.1, 3.1, 3.2（语义化）
- Terraform 简化为单 `staging.tfvars`，无多环境复杂度
- 命名空间确定为 8 个（secrets-infra, data, kubero, apps 等）
- Staging 域名方案：`*.staging.truealpha.club`

## 文档改动

| 文件 | 改动 | 内容 |
|------|------|------|
| `docs/BRN-004.env_eaas_design.md` | ✏️ 改 | 组件表 + Phase 表 + ns 表 + 域名方案 |
| `docs/0.hi_zitian.md` | ✏️ 改 | 基础设施决策 + 待准备事项 |
| `README.md` | ✏️ 改 | 后续演进章节（BRN-004 vs BRN-007） |

## Terraform 结构预期

```
terraform/
├── main.tf
├── providers.tf              (新)
├── variables.tf
├── locals.tf                 (新)
├── staging.tfvars            (新)
├── phases/
│   ├── 0_k3s.tf
│   ├── 1_1_postgresql.tf
│   ├── 1_2_infisical.tf
│   ├── 2_1_databases.tf
│   ├── 3_1_kubero.tf
│   └── 3_2_kubero_ui.tf
└── modules/
    ├── kubernetes/
    │   └── namespaces.tf
    └── helm_releases/
```

## 部署顺序（合法依赖链）

1. Phase 0: k3s（已完成）
2. Phase 1.1: PostgreSQL
3. Phase 1.2: Infisical （依赖 1.1）
4. Phase 2.1: Redis + Neo4j
5. Phase 3.1: Kubero （依赖 Infisical）
6. Phase 3.2: Kubero UI

**总耗时**：约 20-30 分钟（分阶段 apply）

## 验证清单

- [ ] Staging VPS 准备
- [ ] Cloudflare DNS 配置
- [ ] R2 state key 配置
- [ ] GitHub Secrets 配置
- [ ] Terraform init 通过
- [ ] Phase 0-3 apply 成功
- [ ] Kubero UI + Infisical UI 可访问

## 下一步

1. 编写 Terraform phases 代码
2. 本地验证 Phase 0-3
3. 产生 staging-k3s-kubeconfig.yaml
4. Infisical + Kubero 管理员账户初始化
5. 应用部署（后期）
