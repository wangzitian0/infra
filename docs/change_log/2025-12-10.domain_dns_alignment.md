# 2025-12-10: Domain DNS Alignment (i-/x-)

## Summary
Aligned Terraform DNS records and ingress hosts with the internal-domain (no prefix) convention; infra endpoints now live on the internal domain (e.g., `secrets.internal.org`), proxied for 443 services, with `k3s` left DNS-only. When `internal_zone_id` is not provided and `INTERNAL_DOMAIN` differs, Terraform now auto-resolves the Cloudflare zone for the internal domain.

## Changes

### L1 (1.bootstrap)
- `locals.tf`: Domain map uses prefix-less internal hosts; env domain mapping unchanged.
- `2.atlantis.tf`: Atlantis URL/ingress hosts switched to `atlantis.<internal_domain>` (e.g., `atlantis.internal.org`).
- `3.dns_and_cert.tf`: Explicit infra Cloudflare A records with per-host proxy (443 proxied, `k3s` DNS-only); optional internal wildcard only when `INTERNAL_DOMAIN` zone differs; validation checks `atlantis.<internal_domain>`.
- `variables.tf`: Clarify `internal_domain` / `env_prefix` descriptions.

### L2 (2.platform)
- `2.secret.tf`: Vault ingress/TLS/output hosts updated to `secrets.<internal_domain>` (e.g., `secrets.internal.org`).
- `3.dashboard.tf`: Dashboard ingress/TLS/output hosts use `kdashboard.<internal_domain>`.
- `4.kubero.tf`: Kubero UI ingress/TLS/output hosts use `kcloud.<internal_domain>`.

### Docs
- `1.bootstrap/network.md`, `1.bootstrap/README.md`, `2.platform/README.md`: Document `i-*` infra naming and DNS layout.

## Why
- Keep Terraform implementation consistent with the i-/x- domain architecture documented in `0.check_now.md`.
- Ensure infra stays DNS-only/grey when infra/public share the same Cloudflare zone.

## Verification
- `terraform fmt -recursive`
- (After apply) `dig +short i-atlantis.${INTERNAL_DOMAIN}` should resolve to `${VPS_HOST}` (unproxied).
- (After apply) `curl -sf https://i-atlantis.${INTERNAL_DOMAIN}/healthz` or check Vault/Dashboard ingress hosts for TLS issuance.
