# 2025-12-26: Digger PostgreSQL 密码同步修复

## 问题描述

Digger orchestrator 在 CrashLoopBackOff，无法启动：
- 错误信息：`password authentication failed for user "postgres"`
- 数据库记录的 GitHub App ID 不匹配（2542124 vs 2421159）
- GitHub Actions secret 格式错误导致 `Invalid keyData`

## 根本原因

1. **密码漂移**：`platform-pg-superuser` secret 密码与 PostgreSQL 实际密码不同步
   - CNPG 的 `cnpg.io/reload` 标签只更新文件，不执行 `ALTER USER`
   
2. **App ID 不匹配**：数据库中存储旧 App 2542124，但 K8s 使用 App 2421159

3. **GitHub Secret 格式错误**：`INFRA_FLASH_APP_KEY` 格式不对

## 解决方案

### 1. 密码同步（应急）
```bash
kubectl exec -n platform platform-pg-1 -- \
  psql -U postgres -c "ALTER USER postgres WITH PASSWORD '$(kubectl get secret -n platform platform-pg-superuser -o jsonpath='{.data.password}' | base64 -d)';"

kubectl delete pod -n bootstrap -l app.kubernetes.io/instance=digger --force
```

### 2. 数据库记录对齐
```sql
-- 清理旧记录
DELETE FROM github_app_installations WHERE github_app_id = 2542124;

-- 插入正确的 App 2421159
INSERT INTO github_app_installations 
  (created_at, updated_at, github_installation_id, github_app_id, login, status)
VALUES 
  (NOW(), NOW(), 101305644, 2421159, 'wangzitian0', 1);
```

### 3. GitHub Secret 更新
```bash
kubectl get secret -n bootstrap digger-digger-backend-secret \
  -o jsonpath='{.data.GITHUB_APP_PRIVATE_KEY}' | base64 -d \
  | gh secret set INFRA_FLASH_APP_KEY --repo wangzitian0/infra
```

## 代码变更

### bootstrap/2.digger.tf
1. **显式管理 Digger PostgreSQL Secret**
   ```hcl
   resource "kubernetes_secret" "digger_postgres_password" {
     metadata {
       name = "digger-digger-backend-postgres-secret"
       namespace = kubernetes_namespace.bootstrap.metadata[0].name
     }
     data = {
       postgres-password = var.vault_postgres_password
     }
   }
   ```

2. **添加密码同步文档**
   - 说明 CNPG 初始化行为
   - 记录手动恢复步骤
   - 不使用自动化 Job（避免复杂性）

### 文档更新
- `docs/ssot/ops.recovery.md`：添加 Bootstrap Day 0 Recovery Test
- 移除 `bootstrap/RECOVERY_TEST.md`（整合到 SSOT）

## 关键教训

1. **CNPG 的 reload 不等于密码同步**
   - `cnpg.io/reload` 只更新文件，不更新 PG 密码哈希
   - 需要手动 `ALTER USER` 同步密码

2. **信任 CNPG 的初始化**
   - `superuserSecret` 在 bootstrap 时工作正常
   - 从 0 部署不需要密码同步

3. **边缘情况不要过度设计**
   - 密码漂移是罕见操作事件
   - 手动处理更明确、可审计

4. **数据库与配置对齐**
   - GitHub App ID 必须在数据库和 K8s 配置中一致
   - 使用 GitHub API 验证 installation ID

## 验证清单

- [x] Digger pods Running (非 CrashLoopBackOff)
- [x] 无 PostgreSQL 认证错误
- [x] Digger health endpoint 响应
- [x] 密码 secrets 一致性
- [x] GitHub App ID 数据库记录正确
- [x] CI workflow Digger jobs 恢复

## 相关文件

- `bootstrap/2.digger.tf`
- `bootstrap/5.platform_pg.tf`
- `docs/ssot/ops.recovery.md`
- `.github/workflows/ci.yml`

## 参考

- CNPG 文档: https://cloudnative-pg.io/documentation/current/security/#about-the-superuser-password
- GitHub App API: https://docs.github.com/en/rest/apps/apps
