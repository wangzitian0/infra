# 2025-12-08: Layer Architecture Simplification (L5 → L4)

## What

Simplified infrastructure from 5-layer to 4-layer architecture.

## Why

Original 5-layer design was over-engineered for single-VPS MVP:
- L2 (env_and_networking) and L3 (computing) had overlapping responsibilities
- Too many layers made navigation and understanding harder
- Unnecessary complexity for current scale

## Changes

### Directory Renames

| Before | After |
|--------|-------|
| `2.env_and_networking/` | `2.platform/` |
| `3.computing/` | (merged into `2.platform/`) |
| `4.storage/` | `3.data/` |
| `5.insight/` | `4.insight/` |

### New Architecture (L1-L4)

| Layer | Name | Responsibility |
|-------|------|----------------|
| L1 | Bootstrap | K3s, Atlantis, DNS/Cert (零依赖) |
| L2 | Platform | Secrets (Vault), Dashboard, Kubero, Platform DB |
| L3 | Data | Business DBs (Postgres, Redis, ArangoDB, ClickHouse) |
| L4 | Insight | Observability (SigNoz), Analytics (PostHog), Alerting |

### Files Modified

- `terraform/main.tf` - Updated module references
- `terraform/moved.tf` - Added resource migration blocks (env_and_networking → platform, computing → platform)
- `CLAUDE.md` - Updated architecture table
- `docs/dir.md` - Updated directory map
- `terraform/README.md` - Updated layer table
- `terraform/2.platform/README.md` - Rewritten for merged scope
- `terraform/3.data/README.md` - Updated layer number
- `terraform/4.insight/README.md` - Updated layer number
- `terraform/envs/README.md` - Updated layer strategy

## Migration

Terraform `moved` blocks handle state migration automatically. No manual state manipulation required.

## Verification

```bash
cd terraform
terraform fmt -check
terraform validate
terraform plan  # Should show no changes (only moves)
```
