# Change Log: CI/CD Secret Chain Refactoring

**Date**: 2025-12-19
**Status**: COMPLETED
**Owner**: AI Assistant

---

## 1. 目标回顾
解决 GitHub Actions 变量传递链条断裂、冗余、缺乏校验以及 1Password 数据不一致的问题。实现“充分左移”的自动化防御体系。

## 2. 核心架构变动

### A. 统一加载器 (`0.tools/ci_load_secrets.py`)
- 引入 Python 脚本作为变量唯一的“注入引擎”。
- 支持从 GitHub Secrets JSON 自动导出 `TF_VAR_`。
- **左移增强**：内置数据清洗（剥离引号）、PEM 格式扫描、Derived Vars (Vault Addr) 自动推导。

### B. 契约式同步 (`0.tools/sync_secrets.py`)
- 规定了 1Password 存储契约（`Infra-VPS`, `Infra-R2` 等条目）。
- **左移增强**：同步前强制进行 `openssl rsa -check` 验证，杜绝坏密钥入库。

### C. 变量督察 (`0.tools/check_integrity.py`)
- 集成到 CI Validate 阶段。
- 自动扫描全量 `variables.tf` 与 Loader MAPPING 的对齐情况。
- **左移增强**：变量定义与注入逻辑不一致时，CI 立即报错。

## 3. 问题修复记录 (Findings Migrated)

- **[修复]** `TF_VAR_ssh_private_key` 泄露风险：通过精简 YAML 注入逻辑并利用环境变量继承解决。
- **[修复]** `ATLANTIS_GH_APP_KEY` 损坏：通过本地清洗脚本发现 1P 原始数据包含垃圾字符，已修复 1P 并重新同步。
- **[修复]** 状态一致性检查误判：修复了 `deploy-k3s.yml` 中 Atlantis 命名空间判定的 Bug。
- **[修复]** 脏数据写脏 GitHub：建立了 `sync_secrets.py` 本地验证机制，拦截不合规 Key 同步。
- **[修复]** 变量传递链条断裂：废弃大量 Explicit Inputs，统一走 JSON Context 注入。
- **[修复]** 文档覆盖率：补全了 `.github/actions`, `.github/workflows`, `0.tools` 目录的 README。

## 4. 坑点复盘 (Post-Mortem)

1.  **1Password 脏数据陷阱**：SSOT 不等于数据清洁。必须在进入流水线前进行格式验证。
2.  **Composite Action 变量阴影**：`${{ env }}` 上下文是静态的快照。在 Composite Action 内部必须直接引用 `$VAR`。
3.  **严格模式与容错的平衡**：`set -u` 导致可选变量缺失时脚本直接崩溃。使用 `${VAR:-}` 语法兜底。
4.  **衍生变量传递断裂**：移除 Explicit Inputs 后，`vault_address` 无法自动生成。逻辑应收敛到加载器内部。

---
*Archived from 0.check_now.md*
