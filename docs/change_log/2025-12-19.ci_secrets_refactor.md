# Change Log: CI/CD Secret Chain Refactoring

**Date**: 2025-12-19
**Status**: COMPLETED
**Owner**: AI Assistant

---

## 1. 目标回顾
解决 GitHub Actions 变量传递链条断裂、冗余、缺乏校验以及 1Password 数据不一致的问题。实现“充分左移”的自动化防御体系。

## 2. 核心架构变动

### A. 统一加载器 (`0.tools/ci_load_secrets.py`)
- 引入 Python 脚本作为变量唯一的“注入引擎”。
- 支持从 GitHub Secrets JSON 自动导出 `TF_VAR_`。
- **左移增强**：内置数据清洗（剥离引号）、PEM 格式扫描、Derived Vars (Vault Addr) 自动推导。

### B. 契约式同步 (`0.tools/sync_secrets.py`)
- 规定了 1Password 存储契约（`Infra-VPS`, `Infra-R2` 等条目）。
- **左移增强**：同步前强制进行 `openssl rsa -check` 验证，杜绝坏密钥入库。

### C. 变量督察 (`0.tools/check_integrity.py`)
- 集成到 CI Validate 阶段。
- 自动扫描全量 `variables.tf` 与 Loader MAPPING 的对齐情况。
- **左移增强**：变量定义与注入逻辑不一致时，CI 立即报错。

## 3. 坑点复盘 (Post-Mortem)

1.  **1Password 脏数据陷阱**：
    - **现象**：RSA 私钥末尾包含杂质字符且缺失 Footer，导致 OpenSSL 解析失败。
    - **教训**：SSOT 不等于数据清洁。必须在进入流水线前进行格式验证。
2.  **Composite Action 变量阴影**：
    - **现象**：在 Action 内部通过 `env:` 映射动态生成的变量导致变量被置空。
    - **教训**：`${{ env }}` 上下文是静态的快照。在 Composite Action 内部必须直接引用 `$VAR`。
3.  **严格模式与容错的平衡**：
    - **现象**：`set -u` 导致可选变量缺失时脚本直接崩溃。
    - **教训**：对加载逻辑严苛，对运行环境容错。使用 `${VAR:-}` 语法兜底。
4.  **衍生变量传递断裂**：
    - **现象**：移除了 Explicit Inputs 后，`vault_address` 无法自动生成导致超时。
    - **教训**：复杂变量的合成逻辑应收敛到加载器内部，而不是分散在 YAML 中。

## 4. 基础设施清理 (1Password)
- **Vault**: `my_cloud` 下所有旧条目已重命名为 `_old`。
- **New Registry**:
    - `Infra-VPS`: Host, User, Key.
    - `Infra-R2`: AWS Keys, Bucket ID.
    - `Infra-Cloudflare`: Domains, API Token.
    - `Infra-Atlantis`: FIXED App Key (PEM), Webhook Secret.
    - `Infra-Vault`: Root Token, PG Password.
    - `Infra-OAuth`: Client ID/Secret, PAT.

## 5. 收益
- **YAML 瘦身**：`-150+ lines`。
- **维护成本**：从 O(N) 降低到 O(1)（只需改 Python 字典）。
- **安全性**：坏数据无法进入 GitHub，变量泄露风险通过减少显式声明得到抑制。

---
*Archived from 0.check_now.md*