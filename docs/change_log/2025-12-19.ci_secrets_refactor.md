# Change Log: CI/CD Secret Chain Refactoring

**Date**: 2025-12-19
**Status**: COMPLETED
**Owner**: AI Assistant

---

## 1. 目标回顾
解决 GitHub Actions 变量传递链条断裂、冗余、缺乏校验以及 1Password 数据不一致的问题。实现“充分左移”的自动化防御体系。

## 2. 核心架构变动

### A. 统一加载器 (`0.tools/ci_load_secrets.py`)
- 引入 Python 脚本作为变量唯一的“注入引擎”。
- 支持从 GitHub Secrets JSON 自动导出 `TF_VAR_`。
- **左移增强**：内置数据清洗（剥离引号）、PEM 格式扫描、Derived Vars (Vault Addr) 自动推导。

### B. 契约式同步 (`0.tools/sync_secrets.py`)
- 规定了 1Password 存储契约（`Infra-VPS`, `Infra-R2` 等条目）。
- **左移增强**：同步前强制进行 `openssl rsa -check` 验证，杜绝坏密钥入库。

### C. 变量督察 (`0.tools/check_integrity.py`)
- 集成到 CI Validate 阶段。
- 自动扫描全量 `variables.tf` 与 Loader MAPPING 的对齐情况。
- **左移增强**：变量定义与注入逻辑不一致时，CI 立即报错。

## 3. 基础设施清理 (1Password)
- **Vault**: `my_cloud` 下所有旧条目已重命名为 `_old`。
- **New Registry**:
    - `Infra-VPS`: Host, User, Key.
    - `Infra-R2`: AWS Keys, Bucket ID.
    - `Infra-Cloudflare`: Domains, API Token.
    - `Infra-Atlantis`: FIXED App Key (PEM), Webhook Secret.
    - `Infra-Vault`: Root Token, PG Password.
    - `Infra-OAuth`: Client ID/Secret, PAT.

## 4. 收益
- **YAML 瘦身**：`-150+ lines`。
- **维护成本**：从 O(N) 降低到 O(1)（只需改 Python 字典）。
- **安全性**：坏数据无法进入 GitHub，环境变量阴影问题被“熔断器”彻底解决。

---
*Archived from 0.check_now.md*
