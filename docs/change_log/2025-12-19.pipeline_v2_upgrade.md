# Change Log: Pipeline V2 Upgrade (Dashboard SSOT & AI Observability)

**Date**: 2025-12-19
**Category**: CI/CD Automation
**Status**: COMPLETED

## 1. Objective
Transform the infrastructure pipeline from a fragmented comment stream into a unified, high-observability **Commit Dashboard (SSOT)**. Align code implementation with architectural documentation and enable automated AI auditing.

## 2. Key Changes

### A. Dashboard Engine (UI/UX)
- **Unified Per-Commit Dashboard**: Implemented a single `infra-flash` comment per commit that auto-updates with CI, Plan, Apply, and AI Review status.
- **Marker-Based Atomic Updates**: Introduced HTML markers (`<!-- next-step-placeholder -->`) to ensure dashboard sections update without duplication or noise.
- **Dynamic Action Tracking**: Added an `Atlantis Actions` table to record every plan and apply attempt for a specific commit, including trigger origin and output links.

### B. AI & Observability
- **Automated AI Review**: Enabled `claude-code-review.yml` to automatically trigger after successful infrastructure deployment, performing post-deployment audits.
- **Feedback Write-back**: Implemented automatic status updates from Claude (Manual/Auto) back to the central Dashboard Status Table.
- **Run Log Transparency**: Standardized link schema to ensure every status (including failures) points directly to specific Action Run Logs or Atlantis Outputs.

### C. Pipeline Robustness
- **PR Reverse Lookup**: Fixed `workflow_run` limitations by implementing a SHA-to-PR reverse lookup logic using GitHub API, ensuring cross-workflow state consistency.
- **Command Dispatcher**: Fixed execution context issues in `infra-commands.yml` (added checkout/git context) to enable `/dig` and `/help` reliably.
- **Permission Hardening**: Explicitly granted `issues: write` and `pull-requests: write` permissions to all dashboard-interactive workflows.

## 3. Documentation (SSOT Alignment)
- Updated `docs/ssot/ops.pipeline.md` with:
    - **Mermaid State Machine**: Defined deterministic dashboard state transitions.
    - **Sequence Diagrams**: Clarified the interaction timeline between GHA and Atlantis.
    - **Troubleshooting Tree**: Decision manual for common pipeline failures.
    - **Rollback Strategy**: Formalized protocols for failed applies.

## 4. Verification Results
- **PR #289 / #290**: Successfully verified skeleton creation, status table sync, multi-commit isolation, and error capture (e.g., stale plan detection).
- **Identity**: Confirmed all operations align with `infra-flash[bot]` and `claude[bot]` identity standards.

---
*Reference: [docs/ssot/ops.pipeline.md](../ssot/ops.pipeline.md)*
