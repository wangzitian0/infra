# BRN-004 变更日志

> **关联文档**: [BRN-004: EaaS 基础设施设计理念](../../PEG-scaner/docs/origin/BRN-004.dev_test_prod_design.md)

## 变更记录

### 2025-12-04 - Dokploy API 引导自托管 Infisical

**变更摘要**: 打通 Terraform → Dokploy API 闭环，使用 API Key 自动创建 SSH Key/Server/Project/Environment 并上传 Infisical compose，解决 Infisical 引导的循环依赖。

**细节**:
- 新增 `scripts/dokploy/bootstrap_infisical.sh`：通过 Dokploy API 创建 SSH Key、Server、Project、Environment，上传并部署 `compose/platform/infisical.yml`。
- 新增 Terraform 模块 `terraform/modules/dokploy`，在 `enable_dokploy_infisical=true` 时自动调用上述脚本；`terraform/main.tf` 和 `envs/staging` 传递相关变量。
- 补充 `compose/platform/infisical.yml`（envsubst 模板，Traefik 路由到 `secrets.truealpha.club`），`terraform/envs/staging/terraform.tfvars.example` 增加所需变量占位。
- 文档更新：`docs/PROGRESS.md` 标注 Infisical 已具备 Dokploy API 引导方案；`scripts/README.md`/`compose/README.md` 补充入口说明。

### 2025-12-03 - 文档对齐 IRD-004 三层模型

**变更摘要**: 整理文档与部署 SOP，强调三层架构（全局平台 → 共享基建 → 应用）与 Infisical 单一密钥源。

**细节**:
- `docs/deployment-sop.md` 重写为 Layer1/2/3 模式：全局 Dokploy+Infisical/CI → 环境级基建 (DB/MQ/存储/监控) → 应用层 (Dokploy/Compose)；Secrets 只在 Infisical，GitHub Secrets 仅存访问凭证。
- `docs/README.md`、`docs/project/BRN-004/ops.md` 更新导航，强调三层 SOP 入口。
- 保持 env 专属 SOP 入口不变，后续环境差异在 `docs/env.d/{env}_sop.md` 补充。
- 补充环境 SOP：`docs/env.d/staging_sop.md` 贴合三层模型；新增 `docs/env.d/test_sop.md`、`docs/env.d/prod_sop.md` 按层划分配置/步骤。
- 明确 Layer 1 仅在单台 VPS 上一次性安装（staging 阶段完成），test/prod 仅复用全局平台，不再重装。
- 精简导航：`docs/README.md` 改为单入口+简洁清单；新增 `docs/env.d/README.md` 说明环境 SOP 集合；`runbooks/operations.md` 顶部注明差异见 env.d，三层规则见 deployment-sop。
- 统一 Secrets 说明：GitHub Secrets 仅存 Infisical MI 三元组；SSH/Cloudflare/DB 等所有密钥与访问凭据均在 Infisical（env.d/* 已修正为单一来源）。
- SOP 具体化：明确组件名（Dokploy、Infisical、Cloudflare、API/DB/Cache/Worker 等），单机 Layer1 先完成，再执行 Terraform（Layer2）与 Dokploy/Compose（Layer3）的标准顺序。
- 环境 SOP 调整：新增 `docs/env.d/iac_sop.md`（全局层一次性安装），staging/test/prod SOP 统一引用全局层，强调高自动化，避免重复步骤。
- 自动化说明：Dokploy 部署通过脚本应用 compose（deploy.sh/layered_deploy，无 UI 点击）；SOP 中标明部署脚本调用方式，当前未集成 Dokploy API。
- 待补：自托管 Infisical/SigNoz/PostHog 的 Terraform/compose 定义与自动化。
- 强化自托管+Terraform 管理：明确 Dokploy、Infisical、SigNoz、PostHog 等选型全部自有部署，Layer1/2 均由 Terraform/脚本声明与执行。
- Infisical 明确为自托管容器部署，无需 app.infisical.com；MI 仍存 GitHub Secrets，其他凭据在自托管 Infisical。
- 补充入口脚本：`scripts/deploy/layered_deploy.sh`（Terraform+部署）；README/SOP 对齐，暂不提供手工 compose stack 脚本。
- Cloudflare 记录：在 staging 环境创建 `cloud.truealpha.club`（Dokploy）和 `secrets.truealpha.club`（Infisical）。

### 2025-12-02 - 初始实现

**Commit**: Initial Infrastructure Implementation

**实施人**: AI Agent (Antigravity)

**变更摘要**: 完成 BRN-004 描述的 EaaS 基础设施核心框架

#### 新增组件

##### 1. Terraform IaC 核心 ✅
- 创建 `terraform/` 目录结构
- 实现 `backend.tf` - 支持 local/S3/R2 多种 backend
- 实现 `main.tf` - 主配置编排
- 实现 `variables.tf` - 全局变量定义
- 实现 `outputs.tf` - 输出定义

**Modules**:
- `modules/cloudflare/` - DNS/CDN/WAF 管理
  - 实现环境域名管理 (dev/test/staging/prod)
  - 实现 PR 通配符域名 (pr-*.domain)
  - 实现 CDN 缓存规则
  - 实现 WAF Rate Limiting
  - 实现 SSL/TLS 强制配置
- `modules/vps/` - VPS 实例管理
  - 提供多云 Provider 模板 (DigitalOcean/Hetzner/UpCloud)
  - 实现 cloud-init 自动化初始化
  - 实现防火墙规则
  - 集成 Dokploy 自动安装
- `modules/database/` - 数据库资源管理 (预留)
- `modules/monitoring/` - 监控资源管理 (预留)

**Environments**:
- `envs/dev/terraform.tfvars.example` - 开发环境模板
- `envs/test/` - 测试环境目录
- `envs/staging/` - 预发环境目录
- `envs/prod/` - 生产环境目录

##### 2. Docker Compose 服务编排 ✅
- 创建 `compose/` 目录
- 实现 `base.yml` - 基础服务定义
  - Backend (GraphQL API)
  - Neo4j (图数据库)
  - PostgreSQL (关系数据库)
  - Redis (缓存 & Broker)
  - Celery Worker (后台任务)
  - Celery Beat (定时任务)
  - Flower (Celery 监控)

**环境覆盖文件**:
- `dev.yml` - 端口暴露、源码挂载、调试模式
- `ci.yml` - 资源限制、最小化服务
- `test.yml` - 动态域名、共享数据库
- `staging.yml` - 持久化卷、日志轮转
- `prod.yml` - 高可用、安全 headers、副本扩展

##### 3. CI/CD Pipeline ✅
- 创建 `ci/github-actions/` 目录
- 实现 `deploy.yml` - 应用部署 workflow
  - Infisical 集成
  - 多环境支持
  - 健康检查
- 实现 `terraform.yml` - 基础设施变更 workflow
  - 自动 plan on PR
  - Plan 结果评论到 PR
  - 审批后 apply
- 实现 `pr-preview.yml` - PR 预览环境 workflow
  - 自动部署预览
  - 动态域名分配
  - PR 关闭自动清理

**Atlantis 配置**:
- 创建 `ci/atlantis/atlantis.yaml`
- 配置 4 个环境项目 (dev/test/staging/prod)
- 实现分级审批要求
- 实现自定义 workflow

##### 4. 可观测性配置 ✅
- 创建 `observability/` 目录
- 实现 `otel/otel-collector-config.yml`
  - OTLP receivers (gRPC/HTTP)
  - Batch processor
  - Resource processor
  - ClickHouse exporters
  - 独立的 traces/metrics/logs pipelines

##### 5. 部署脚本 ✅
- 创建 `scripts/deploy/` 目录
- 实现 `export-secrets.sh` - Infisical 密钥导出
- 实现 `deploy.sh` - 自动化部署脚本
  - 配置验证
  - 镜像拉取
  - 零停机部署
  - 健康检查
  - 生产环境二次确认

##### 6. 文档体系 ✅
- 创建 `docs/` 目录结构
- 实现 `architecture.md` - 详细架构设计
  - 系统架构图 (Mermaid)
  - 数据流图
  - 组件详解
  - 环境隔离策略
  - 扩展性设计
  - 灾难恢复
- 实现 `runbooks/operations.md` - 运维手册
  - 日常操作
  - 故障排查
  - 备份恢复
  - 扩容指南
- 实现 `guides/developer-onboarding.md` - 开发者指南
  - 本地环境搭建
  - 新服务接入
  - OTel/PostHog 集成示例
  - 最佳实践

##### 7. 配置管理 ✅
- 创建 `secrets/` 目录
- 实现 `.env.example` - 环境变量模板
  - 包含所有必需的配置项
  - 详细的注释说明
- 实现 `.gitignore` - 排除敏感文件

##### 8. 项目文档 ✅
- 创建 `README.md` - 项目概述
  - 技术栈表格
  - 快速开始
  - 环境管理
  - 核心工作流
  - 常用命令

#### 技术债务标记

**需要后续实现**:
- [ ] VPS Provider 实际配置 (当前为模板)
- [ ] Terraform State Backend 迁移到远程
- [ ] SigNoz 实际部署
- [ ] PostHog 实际部署
- [ ] Atlantis 服务部署
- [ ] Backstage 门户实现

**需要用户配置**:
- [ ] 选择并配置 VPS 提供商
- [ ] 配置 Cloudflare API Token
- [ ] 部署自托管 Infisical
- [ ] 配置 GitHub Secrets
- [ ] 填写 terraform.tfvars

**设计决策**:
- Backend: 默认使用 local，可切换至 S3/R2
- VPS Module: 提供多云模板，需用户选择后配置
- 密钥管理: 自托管 Infisical
- 可观测性: SigNoz 配置已备，等待部署

#### 文件统计

- **Terraform 文件**: 12 个
- **Docker Compose 配置**: 6 个 (base + 5 envs)
- **CI/CD Workflows**: 3 个
- **部署脚本**: 2 个
- **文档**: 5 个主要文档
- **总计配置文件**: 30+

#### 覆盖范围

**环境**: ✅ dev, ✅ ci, ✅ test, ✅ staging, ✅ prod

**功能域**:
- ✅ 基础设施管理 (Terraform)
- ✅ 服务编排 (Docker Compose)
- ✅ 密钥管理 (Infisical 集成)
- ✅ 持续部署 (GitHub Actions + Atlantis)
- ✅ 可观测性 (SigNoz + OTel 配置)
- ✅ 网络安全 (Cloudflare WAF)
- ✅ 文档 (Architecture + Runbooks + Guides)

#### Git 提交建议

```bash
git add .
git commit -m "feat(infra): implement BRN-004 EaaS infrastructure

- Add Terraform modules (cloudflare, vps, database, monitoring)
- Add Docker Compose configs for 5 environments
- Add CI/CD workflows (deploy, terraform, pr-preview)
- Add observability configs (SigNoz, OTel)
- Add deployment scripts and documentation
- Add comprehensive architecture and runbooks

Implements: BRN-004
"
```

---

### 未来计划变更

#### Phase 2: 实际部署配置
- 配置实际 VPS Provider
- 部署 SigNoz 和 PostHog
- 部署 Atlantis
- 迁移 State Backend 到 S3/R2

#### Phase 3: Backstage 门户
- 初始化 Backstage 项目
- 创建软件目录
- 实现自定义插件
- 创建 Scaffolder 模板

#### Phase 4: 高级特性
- 多 region 部署
- 自动伸缩
- 高可用改造
- 灾难恢复演练

---

## 变更模板

```markdown
### YYYY-MM-DD - 变更标题

**Commit**: <commit-hash-or-description>
**实施人**: <name>
**变更摘要**: <一句话描述>

#### 新增
- 新增的文件/功能

#### 修改
- 修改的文件/功能

#### 删除
- 删除的文件/功能

#### 技术债务
- [ ] 待解决的问题

#### Git 提交
\`\`\`bash
git commit -m "type(scope): description"
\`\`\`
```
