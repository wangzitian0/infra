# 2025-12-22: L1 Bootstrap Provider Migration

## Summary
Migrate L1 bootstrap validation and configuration from `null_resource` + provisioners to native Terraform providers (kubectl, dns, http, time).

## Changes

### Replaced Resources

1. **DNS & Cert validation** (`1.bootstrap/3.dns_and_cert.tf`)
   - `null_resource.validate_dns` → `data.dns_a_record_set` + `time_sleep` + postcondition
   - `null_resource.validate_cert` → removed (covered by health check)
   - `null_resource.validate_atlantis` → `data.http` with retry + postcondition
   - `null_resource.cluster_issuer_letsencrypt_prod` → `kubectl_manifest`
   - `null_resource.wildcard_certificate_public/internal` → `kubectl_manifest`

2. **Storage provisioner restart** (`1.bootstrap/4.storage.tf`)
   - `null_resource.restart_local_path_provisioner` → `kubernetes_manifest` with annotation-based trigger

3. **Traefik config deployment** (`1.bootstrap/4.traefik_config.tf`)
   - `null_resource.traefik_config` (SSH file copy) → `kubectl_manifest` (server-side apply)

4. **PostgreSQL initialization** (`1.bootstrap/5.platform_pg.tf`)
   - `null_resource.vault_pg_schema` → `kubectl_manifest` Job resource
   - `null_resource.casdoor_database` → merged into single init Job

### New Providers

- `alekc/kubectl` (~> 2.0): CRD resources without plan-time validation
- `hashicorp/dns` (~> 3.4): DNS resolution validation
- `hashicorp/http` (~> 3.5): HTTPS health checks with retry
- `hashicorp/time` (~> 0.13): Cooldown/wait for DNS/cert propagation

## Benefits

1. **Plan-time validation**: Failures detected during `terraform plan` instead of `apply`
2. **No SSH dependency**: Traefik config deployed via Kubernetes API
3. **Better idempotency**: Provider-managed resources vs. shell scripts
4. **Improved error handling**: Postconditions provide clear failure messages

## Breaking Changes

- **Atlantis health check now fails apply** if `/healthz` is unreachable after retry window
  - Previously: Warning only, apply succeeds
  - Now: Hard failure with postcondition error
  - Impact: First-time deployments may need retry if Atlantis starts slowly

## Testing

- CI validated format, lint, and validate for all layers
- Lock file updated for darwin_amd64 + linux_amd64

## Related

- PR: https://github.com/wangzitian0/infra/pull/321
- Commit: ded4855
