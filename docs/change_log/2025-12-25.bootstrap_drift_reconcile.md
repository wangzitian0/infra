# 2025-12-25: Reconcile Bootstrap Drift in Post-Merge CI

## Situation
Post-merge CI did not reconcile L1 drift because the Bootstrap workflow only ran on
`bootstrap/**` changes. At the same time, the secrets loader path moved, causing
post-merge failures (`tools/ci_load_secrets.py` missing). Bootstrap init also used
an implicit state key that could diverge from the `k3s/terraform.tfstate` SSOT.

## Task
1. Reconcile Bootstrap drift on every push to `main`.
2. Fix secrets loader path and state key alignment for bootstrap init.
3. Update relevant workflow/docs to reflect the new behavior.

## Action
1. **terraform-setup action**: Pointed to `tools/secrets/ci_load_secrets.py` and
   defaulted the bootstrap state key to `k3s/terraform.tfstate`.
2. **bootstrap-deploy workflow**: Removed path filter, injected the state key,
   removed redundant init, and gated apply on `terraform plan -detailed-exitcode`.
3. **Digger HTTPS guard**: Fixed the ingress postcondition to validate TLS config
   instead of matching a URL string.
4. **E2E move**: Removed DNS/HTTPS health checks from Terraform and added a
   post-apply CI check to avoid apply-time flakiness.
5. **Drift adopt**: CI imports existing Helm releases and secrets before apply to
   avoid "already exists" failures.
6. **Digger chart pin**: Updated `digger-backend` chart version to `0.1.12` after
   upstream removed `0.1.0`.
7. **Helm import hardening**: Resolve Helm release namespace via secret name
   pattern to avoid false-positive imports.
8. **Docs**: Updated workflow and bootstrap READMEs to match the new drift policy.

## Result
- Bootstrap drift is reconciled post-merge (apply only when drift exists).
- Post-merge setup no longer fails on missing loader path.
- Bootstrap plan no longer fails on the Digger HTTPS postcondition check.
- DNS/HTTPS health checks run post-apply in CI instead of blocking apply.
- Existing Helm releases and secrets are adopted into state before apply.
- Digger chart pin restored to an available upstream version (`0.1.12`).
- Helm release imports no longer fail on mismatched namespaces.
- Documentation reflects the updated L1 pipeline behavior.
- **Confidence**: 85%.

## Verification Checklist
- [ ] `bootstrap-deploy` runs on every push to `main`.
- [ ] Loader uses `tools/secrets/ci_load_secrets.py` without path errors.
- [ ] `terraform plan` exit code gates apply (only runs on exit code 2).
- [ ] Post-merge run shows bootstrap drift reconciled (apply success or no-op).
- [ ] Digger Helm release no longer fails on missing chart version.
