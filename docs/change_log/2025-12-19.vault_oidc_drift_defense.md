# Change Log: Vault OIDC Permission Fix & Native Drift Defense

**Date**: 2025-12-19
**Status**: COMPLETED
**Owner**: AI Assistant

---

## 1. 目标回顾
修复 Vault UI 选择 OIDC 登录后报 `Permission Denied` 的问题，并解决 Casdoor 资源创建时的状态一致性冲突。

## 2. 核心修复记录

### A. Vault UI "预检死锁"
- **修复**: 注释掉 `vault_jwt_auth_backend` 中的 `default_role`。
- **原因**: UI 会在未登录时预读取 `default_role` 配置，导致 403 错误拦截了登录流程。
- **后果**: 用户需手动在 UI 填入 Role 名 `reader`。

### B. Casdoor API 路径与拼接
- **修复**: 统一移除资源路径中的 `/api` 前缀（Provider URI 已含），并改用 `{id}` 占位符。
- **原因**: 之前的路径冗余导致 404 HTML 响应；直接追加 ID 导致 URL 参数格式错误触发 Casdoor Panic (500)。

### C. 状态漂移 (Drift) 防御
- **落地**: 虽然移除原生的 `import` 块（对 restapi 支持较差），但在文档中建立了清理幽灵资源的 SOP。
- **经验**: Casdoor 具有内存缓存，删除数据库记录后必须重启/重缩容 Pod 才能彻底同步。

## 3. 健壮性增强
- **Health Check**: 废弃脆弱的 `data.http` 检查，引入带有 60s 冷静期的 `time_sleep` + `data.http` 组合，为 Ingress 传播预留时间。
- **Whitebox**: 通过 `terraform_data` 显式输出检查 URL，便于在 Atlantis Plan 输出中直接调试。

## 4. 坑点复盘 (Post-Mortem)
1. **Provider 参数盲猜**: 连续在 `terracurl` 参数名上报错。
   - *教训*: 严禁凭直觉使用 `timeout` / `retry` 等参数，必须核对官方文档。
2. **SPA 404 误导**: Casdoor 404 时返回 HTML，导致报错 `invalid character '<'`。
   - *教训*: 看到该报错优先检查路径是否双重拼接或 404。

---
*Archived to AGENTS.md SOP*
