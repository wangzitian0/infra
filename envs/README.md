# Multi-Environment Architecture

This directory implements **directory-based environment isolation** for L3 Data layer.

> Architecture SSOT lives in `docs/ssot/` (especially `docs/ssot/env.md`). This README is operational guidance, not a second SSOT.

## Directory Structure

```
envs/
  staging/
    data/          # L3 staging data layer
  prod/
    data/          # L3 production data layer
```

## Layer Strategy (L1-L4)

| Layer | Name | Scope | Location | Managed By | Description |
|-------|------|-------|----------|------------|-------------|
| **L1** | **Bootstrap** | **Shared** (Singleton) | `1.bootstrap/` | GitHub Actions | K3s Cluster, Atlantis, DNS/Cert, Storage, Platform PG |
| **L2** | **Platform** | **Shared** (Singleton) | `platform/` | Atlantis (`platform`) | Vault, Dashboard, Casdoor |
| **L3** | **Data** | **Isolated** (Per-env) | `envs/{env}/data/` | Atlantis (`data-staging`/`data-prod`) | Business databases in `data-{env}` |
| **L4** | **Apps** | **Shared** (Singleton) | `4.apps/` | Atlantis (`apps`) | Control plane (Kubero, SigNoz) manages apps in `apps-{env}` |

## Environment Isolation

- **L1/L2/L4 Singleton**: Single instance shared by all environments
- **L3 Directory Isolation**: Separate state files per environment
  - Staging: `envs/staging/data/` → `k3s/data-staging.tfstate`
  - Prod: `envs/prod/data/` → `k3s/data-prod.tfstate`

## Design Decision: Namespace vs Cluster Isolation

**Decision**: Use **Namespace Isolation** (Soft Multi-Tenancy) instead of separate Clusters.

**Rationale**:
1.  **Cost Efficiency**: Running multiple K3s clusters doubles/triples infrastructure requirements.
2.  **Operational Simplicity**: Managing one set of L1/L2 reduces maintenance burden.
3.  **Scale Appropriateness**: For this project size, separate physical clusters introduce unnecessary complexity.

**Trade-offs**:
- **Risk**: Shared Failure Domain. If the L1 Cluster fails, *both* Staging and Prod go down.
- **Mitigation**:
    - `staging` deployment verifies application logic.
    - `infra` workflow is separated to prevent accidental cluster-wide changes during app deployment.
    - Resource Quotas (CPU/RAM) can be applied to namespaces.

## Terragrunt Integration

L3 Data layers use **Terragrunt** for configuration management:
- **Backend**: Auto-generated by root `terragrunt.hcl` (gitignored)
- **Providers**: Auto-generated (gitignored)
- **Environment Detection**: Automatic via directory structure
  - `envs/staging/data/` → `environment = "staging"`
  - `envs/prod/data/` → `environment = "prod"`

### Usage

```bash
# Staging
cd envs/staging/data
export R2_BUCKET=<bucket> R2_ACCOUNT_ID=<account-id>
terragrunt init
terragrunt apply

# Production
cd envs/prod/data
terragrunt init
terragrunt apply
```

For the authoritative environment model, see: `docs/ssot/env.md`.

---
*Last updated: 2025-12-22 (Terragrunt migration)*
