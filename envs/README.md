# Multi-Environment Architecture

This directory implements **directory-based environment isolation** for the Data layer.

> Architecture SSOT lives in `docs/ssot/` (especially `docs/ssot/env.md`). This README is operational guidance, not a second SSOT.

## Directory Structure

```
envs/
  staging/
    data/          # staging data layer
  prod/
    data/          # production data layer
```

## Layer Strategy

| Module | Scope | Location | Managed By | Description |
|-------|-------|----------|------------|-------------|
| **Bootstrap** | **Shared** (Singleton) | `bootstrap/` | GitHub Actions | Cluster, Atlantis, DNS/Cert, Platform PG |
| **Platform** | **Shared** (Singleton) | `platform/` | Atlantis (`platform`) | Vault, SSO, Kubero, SigNoz |
| **Data** | **Isolated** (Per-env) | `envs/{env}/data/` | Atlantis (`data-staging`/`data-prod`) | Business databases in `data-{env}` |

## Environment Isolation

- **Bootstrap/Platform Singleton**: Single control plane shared by all environments
- **Data Directory Isolation**: Separate state files per environment
  - Staging: `envs/staging/data/` → `k3s/data-staging.tfstate`
  - Prod: `envs/prod/data/` → `k3s/data-prod.tfstate`

## Design Decision: Namespace vs Cluster Isolation

**Decision**: Use **Namespace Isolation** (Soft Multi-Tenancy) instead of separate Clusters.

**Rationale**:
1.  **Cost Efficiency**: Running multiple K3s clusters doubles/triples infrastructure requirements.
2.  **Operational Simplicity**: Managing one set of Bootstrap/Platform reduces maintenance burden.
3.  **Scale Appropriateness**: For this project size, separate physical clusters introduce unnecessary complexity.

**Trade-offs**:
- **Risk**: Shared Failure Domain. If the L1 Cluster fails, *both* Staging and Prod go down.
- **Mitigation**:
    - `staging` deployment verifies application logic.
    - `infra` workflow is separated to prevent accidental cluster-wide changes during app deployment.
    - Resource Quotas (CPU/RAM) can be applied to namespaces.

## Terragrunt Integration

Data layers use **Terragrunt** for configuration management:
- **Backend**: Auto-generated by root `terragrunt.hcl` (gitignored)
- **Providers**: Auto-generated (gitignored)
- **Environment Detection**: Automatic via directory structure
  - `envs/staging/data/` → `environment = "staging"`
  - `envs/prod/data/` → `environment = "prod"`

### Usage

```bash
# Staging
cd envs/staging/data
export R2_BUCKET=<bucket> R2_ACCOUNT_ID=<account-id>
terragrunt init
terragrunt apply

# Production
cd envs/prod/data
terragrunt init
terragrunt apply
```

For the authoritative environment model, see: `docs/ssot/env.md`.

---
*Last updated: 2025-12-22 (Terragrunt migration)*
