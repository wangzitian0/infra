# Digger Configuration
# Handles terraform plan/apply via GitHub Actions
# Reference: https://docs.digger.dev/

# Global settings
auto_merge: false
comment_render_mode: basic

# Projects to manage
projects:
  - name: bootstrap
    dir: bootstrap
    workflow: terraform
    
  - name: platform
    dir: platform
    terragrunt: true
    workflow: terragrunt
    
  - name: data-staging
    dir: envs/staging/data
    terragrunt: true
    workflow: terragrunt
    
  - name: data-prod
    dir: envs/prod/data
    terragrunt: true
    workflow: terragrunt

# Workflows with proper event configuration
workflows:
  terraform:
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger apply"]
    plan:
      steps:
        - init
        - plan
    apply:
      steps:
        - init
        - apply
        
  terragrunt:
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger apply"]
    plan:
      steps:
        - run: terragrunt init -no-color
        - run: terragrunt plan -no-color -out=plan.tfplan
    apply:
      steps:
        - run: terragrunt init -no-color
        - run: terragrunt apply -no-color -auto-approve plan.tfplan
