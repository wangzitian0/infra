# Digger Configuration (OSS Mode)
# Purpose: Manual project-specific operations via PR comments
# 
# Architecture:
# - Auto CI: Native terragrunt plan/apply (terraform-plan, terraform-apply jobs)
# - Manual: Digger orchestration for selective operations
# 
# Reference: https://docs.digger.dev/

# Projects to manage (Bootstrap excluded - uses dedicated workflow)
projects:
  - name: platform
    dir: platform
    terragrunt: true
    workflow: terragrunt
    # Always run plan on every PR to detect drift
    include_patterns:
      - "**/*"
    
  - name: data-staging
    dir: envs/staging/data
    terragrunt: true
    workflow: terragrunt
    include_patterns:
      - "**/*"
    
  - name: data-prod
    dir: envs/prod/data
    terragrunt: true
    workflow: terragrunt
    include_patterns:
      - "**/*"

# Auto-merge: disabled (use manual /apply)
auto_merge: false

# Post-merge: now handled by self-hosted Digger Orchestrator
# Orchestrator receives push webhooks and triggers apply automatically
on_commit_to_default: apply

# Comment options
comment_render_mode: basic

# Workflows
workflows:
  terraform:
    plan:
      steps:
        - init
        - plan
    apply:
      steps:
        - init
        - apply
        
  terragrunt:
    workflow_configuration:
      on_pull_request_pushed: [digger plan]
      on_pull_request_closed: [digger unlock]
      on_commit_to_default: [digger apply]
    env_vars:
      state:
        - name: TF_INPUT
          value: "false"
      commands: []
    plan:
      steps:
        - run: terragrunt init -no-color
        - run: terragrunt plan -no-color -out=plan.tfplan
    apply:
      steps:
        - run: terragrunt init -no-color
        - run: terragrunt apply -no-color -auto-approve plan.tfplan
