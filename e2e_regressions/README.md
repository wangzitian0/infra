# E2E Regression Tests

æ­¤ç›®å½•åŒ…å« **cc_infra** é¡¹ç›®çš„ç«¯åˆ°ç«¯ï¼ˆE2Eï¼‰è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ã€‚è¯¥æ¡†æ¶åŸºäº **Python**ã€**Playwright** å’Œ **pytest** æ„å»ºï¼Œç”¨äºéªŒè¯ä»åŸºç¡€è®¾æ–½éƒ¨ç½²åˆ°åº”ç”¨å±‚åŠŸèƒ½çš„å®Œæ•´æµç¨‹ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

æœ¬é¡¹ç›®éµå¾ªæµ‹è¯•é‡‘å­—å¡”åŸåˆ™ï¼Œæµ‹è¯•ç”¨ä¾‹æŒ‰éƒ¨ç½²é˜¶æ®µå’ŒåŠŸèƒ½æ¨¡å—åˆ†å±‚ç»„ç»‡ã€‚

**å…³é”®ç‰¹ç‚¹**ï¼š
- âœ… **å…¨æ ˆè¦†ç›–**ï¼šè¦†ç›– Portalã€Platformã€APIã€æ•°æ®åº“ç­‰å„ä¸ªå±‚é¢ã€‚
- âš¡ **å¿«é€Ÿåé¦ˆ**ï¼šçƒŸé›¾æµ‹è¯•ï¼ˆSmoke Testï¼‰å¯åœ¨ 1-2 åˆ†é’Ÿå†…éªŒè¯ç³»ç»Ÿæ ¸å¿ƒå¥åº·çŠ¶æ€ã€‚
- ğŸ“¦ **æ¨¡å—åŒ–ç»“æ„**ï¼šæµ‹è¯•ç›®å½•ç»“æ„ä¸åŸºç¡€è®¾æ–½ä»£ç ç›®å½•ç»“æ„ï¼ˆ`1.bootstrap`, `2.platform`, `3.data`, `4.apps`ï¼‰å¯¹é½ã€‚
- ğŸš€ **CI/CD å°±ç»ª**ï¼šåŒ…å« GitHub Actions å·¥ä½œæµï¼Œæ”¯æŒè‡ªåŠ¨è§¦å‘å’Œå®šæ—¶è¿è¡Œã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. åˆå§‹åŒ–é¡¹ç›®

```bash
cd e2e_regressions

# å®‰è£…ä¾èµ–ï¼ˆè‡ªåŠ¨è¯»å– pyproject.toml å¹¶ç”Ÿæˆ uv.lockï¼‰
uv sync

# å®‰è£…æµè§ˆå™¨é©±åŠ¨
uv run playwright install chromium
```

### 2. é…ç½®ç¯å¢ƒ

å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿å¹¶æ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹ï¼š

```bash
cp .env.example .env
```

**å…³é”®é…ç½®é¡¹**ï¼ˆ`.env`ï¼‰ï¼š

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `PORTAL_URL` | Portal ä¸»é¡µ URL | `https://home.zitian.party` |
| `SSO_URL` | Casdoor SSO URL | `https://sso.zitian.party` |
| `VAULT_URL` | Vault URL | `https://secrets.zitian.party` |
| `DASHBOARD_URL` | K8s Dashboard URL | `https://kdashboard.zitian.party` |
| `TEST_USERNAME` | æµ‹è¯•ç”¨ç”¨æˆ·å | `test_user` |
| `TEST_PASSWORD` | æµ‹è¯•ç”¨å¯†ç  | `***` |

> æ›´å¤šé…ç½®é¡¹ï¼ˆå¦‚æ•°æ®åº“è¿æ¥ï¼‰è¯·æŸ¥çœ‹ `.env.example` æ–‡ä»¶ã€‚

### 3. è¿è¡Œæµ‹è¯•

æ¨èä½¿ç”¨ `Makefile` è¿›è¡Œæ“ä½œï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
make help

# è¿è¡ŒçƒŸé›¾æµ‹è¯•ï¼ˆå¿«é€Ÿæ£€æŸ¥æ ¸å¿ƒæœåŠ¡ï¼Œ~1-2 åˆ†é’Ÿï¼‰
make test-smoke

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# è°ƒè¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºæµè§ˆå™¨ç•Œé¢ï¼Œæ…¢é€Ÿæ‰§è¡Œï¼‰
make test-headed
```

æˆ–è€…ç›´æ¥ä½¿ç”¨ `uv run pytest`ï¼š

```bash
# è¿è¡ŒæŒ‡å®šæ ‡ç­¾çš„æµ‹è¯•
uv run pytest -m smoke
uv run pytest -m sso
uv run pytest -m platform

# ç”Ÿæˆ HTML æŠ¥å‘Š
uv run pytest --html=report.html --self-contained-html
```

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„ä¸æµ‹è¯•åˆ†å±‚

æµ‹è¯•æ–‡ä»¶ç»“æ„ä¸åŸºç¡€è®¾æ–½ä»£ç ç»“æ„ä¿æŒä¸€è‡´ï¼Œä¾¿äºç»´æŠ¤å’Œå®šä½é—®é¢˜ã€‚

```
e2e_regressions/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ bootstrap/          # Bootstrap å±‚æµ‹è¯•ï¼ˆK8sã€å­˜å‚¨ã€ç½‘ç»œç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ k8s/           # K8s é›†ç¾¤æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ atlantis/      # Atlantis CI/CD æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ dns_cert/      # DNS å’Œè¯ä¹¦æµ‹è¯•
â”‚   â”‚   â””â”€â”€ ...            # å…¶ä»– Bootstrap ç»„ä»¶
â”‚   â”œâ”€â”€ platform/           # Platform å±‚æµ‹è¯•
â”‚   â”‚   â””â”€â”€ test_platform.py    # Vault, Dashboard, Casdoor å¯ç”¨æ€§
â”‚   â”œâ”€â”€ data/               # Data å±‚æµ‹è¯•
â”‚   â”‚   â””â”€â”€ test_databases.py   # PostgreSQL, Redis, ClickHouse è¿æ¥éªŒè¯
â”‚   â”œâ”€â”€ apps/               # Apps å±‚æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_portal_sso.py  # Portal SSO ç™»å½•æµç¨‹
â”‚   â”‚   â””â”€â”€ test_api_health.py  # ä¸šåŠ¡ API å¥åº·æ£€æŸ¥
â”‚   â””â”€â”€ smoke/              # è·¨å±‚çƒŸé›¾æµ‹è¯•
â”‚       â””â”€â”€ test_smoke.py       # æ•´ä½“ç³»ç»Ÿå¿«é€Ÿå¥åº·æ£€æŸ¥
â”œâ”€â”€ Makefile                # å¿«æ·å‘½ä»¤
â”œâ”€â”€ pyproject.toml          # ä¾èµ–ç®¡ç†é…ç½®
â”œâ”€â”€ conftest.py             # pytest å…¨å±€é…ç½® & Fixtures
â””â”€â”€ ...
```

### æµ‹è¯•ç­–ç•¥åˆ†å±‚

| å±‚çº§ | æµ‹è¯•å†…å®¹ | è€—æ—¶ | ç›®çš„ |
|------|---------|------|------|
| **Smoke** | æ ¸å¿ƒæœåŠ¡å¯è®¿é—®æ€§ | 1-2 min | éƒ¨ç½²åçš„å†’çƒŸæµ‹è¯•ï¼Œå¿«é€Ÿé˜»æ–­ |
| **Platform** | Ingress, Vault, Casdoor | 2-3 min | éªŒè¯å¹³å°åŸºç¡€ç»„ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œ |
| **Data** | Postgres, Redis, ClickHouse | 3-5 min | éªŒè¯æ•°æ®å±‚è¿æ¥å’ŒåŸºæœ¬è¯»å†™æƒé™ |
| **Apps** | Portal, SSO flows, APIs | 5-10 min | éªŒè¯ä¸Šå±‚ä¸šåŠ¡é€»è¾‘å’Œç”¨æˆ·äº¤äº’æµç¨‹ |
| **E2E** | å…¨é“¾è·¯åœºæ™¯ | 10+ min | å®Œæ•´æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸ºçš„ç«¯åˆ°ç«¯æµ‹è¯• |

---

## ğŸ”§ å¸¸è§åœºæ™¯ä¸æ•…éšœæ’é™¤

### åœºæ™¯ï¼šéƒ¨ç½²åéªŒè¯
1. è¿è¡Œ `make test-smoke`ã€‚
2. å¦‚æœé€šè¿‡ï¼Œç³»ç»ŸåŸºæœ¬å¥åº·ã€‚å¦‚æœå¤±è´¥ï¼ŒæŸ¥çœ‹å…·ä½“æŠ¥é”™çš„æœåŠ¡ã€‚

### åœºæ™¯ï¼šè°ƒè¯• SSO ç™»å½•é—®é¢˜
1. è®¾ç½® `HEADLESS=false` æˆ–è¿è¡Œ `make test-headed`ã€‚
2. è§‚å¯Ÿæµè§ˆå™¨ä¸­çš„è‡ªåŠ¨æ“ä½œï¼Œç¡®è®¤æ˜¯å¦å¡åœ¨è·³è½¬ã€éªŒè¯ç æˆ–æƒé™é¡µé¢ã€‚
3. æ£€æŸ¥ `.env` ä¸­çš„ `TEST_USERNAME` å’Œ `TEST_PASSWORD` æ˜¯å¦æ­£ç¡®ã€‚

### æ•…éšœæ’é™¤æŒ‡å—

- **æµè§ˆå™¨å¯åŠ¨å¤±è´¥**ï¼šæ‰§è¡Œ `uv run playwright install chromium --with-deps` é‡æ–°å®‰è£…ä¾èµ–ã€‚
- **è¶…æ—¶ï¼ˆTimeoutï¼‰**ï¼šæœåŠ¡å“åº”æ…¢å¯èƒ½å¯¼è‡´æµ‹è¯•è¶…æ—¶ã€‚å¯åœ¨å‘½ä»¤å‰åŠ ç¯å¢ƒå˜é‡ä¸´æ—¶è°ƒæ•´ï¼š`TIMEOUT_MS=60000 make test-smoke`ã€‚
- **æ•°æ®åº“è¿æ¥å¤±è´¥**ï¼š
    - æ£€æŸ¥ `.env` ä¸­çš„ `DB_HOST` æ˜¯å¦æ­£ç¡®ï¼ˆæ˜¯å¦éœ€è¦ç«¯å£è½¬å‘ï¼Ÿï¼‰ã€‚
    - ç¡®ä¿æµ‹è¯•è¿è¡Œç¯å¢ƒï¼ˆå°¤å…¶æ˜¯æœ¬åœ°ï¼‰èƒ½è®¿é—® K8s é›†ç¾¤å†…çš„ Service åœ°å€ï¼ˆå¯èƒ½éœ€è¦ VPN æˆ– `kubectl port-forward`ï¼‰ã€‚

---

## ğŸ¤– CI/CD é›†æˆ

æœ¬é¡¹ç›®åŒ…å« GitHub Actions é…ç½®ç¤ºä¾‹ `.github-workflow-example.yml`ã€‚

**é›†æˆæ­¥éª¤**ï¼š
1. å°† `.github-workflow-example.yml` å¤åˆ¶åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ `.github/workflows/e2e-tests.yml`ã€‚
2. åœ¨ GitHub ä»“åº“ Settings -> Secrets ä¸­é…ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡ï¼ˆ`PORTAL_URL`, `TEST_USERNAME` ç­‰ï¼‰ã€‚
3. å·¥ä½œæµå°†åœ¨ `main` åˆ†æ”¯æ¨é€æˆ– Pull Request æ—¶è‡ªåŠ¨è§¦å‘ã€‚

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Playwright Python Documentation](https://playwright.dev/python/)
- [pytest Documentation](https://docs.pytest.org/)
