name: Update infra-flash Status

on:
  # Trigger when Atlantis updates check status
  status:
  # Also trigger on check_run for more granular updates
  check_run:
    types: [completed]

jobs:
  update-comment:
    runs-on: ubuntu-latest
    # Only run for Atlantis checks on PRs
    if: |
      github.event.context && startsWith(github.event.context, 'atlantis/') ||
      github.event.check_run && startsWith(github.event.check_run.name, 'atlantis/')
    
    steps:
      - name: Get PR number from commit
        id: get_pr
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const sha = context.sha || context.payload.check_run?.head_sha;
            if (!sha) return '';
            
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha
            });
            
            if (prs.data.length === 0) return '';
            return prs.data[0].number.toString();

      - name: Generate infra-flash App Token
        if: steps.get_pr.outputs.result != ''
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Get Atlantis status
        if: steps.get_pr.outputs.result != ''
        id: atlantis_status
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          result-encoding: string
          script: |
            const pr = ${{ steps.get_pr.outputs.result }};
            const sha = context.sha || context.payload.check_run?.head_sha;
            
            // Get all check runs for this commit
            const checks = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha
            });
            
            // Parse Atlantis checks
            const atlantisChecks = checks.data.check_runs.filter(c => 
              c.name.startsWith('atlantis/')
            );
            
            const status = {
              plan: { platform: 'â³', 'data-staging': 'â³', 'data-prod': 'â³' },
              apply: { platform: 'â³', 'data-staging': 'â³', 'data-prod': 'â³' }
            };
            
            for (const check of atlantisChecks) {
              const name = check.name;
              const icon = check.conclusion === 'success' ? 'âœ…' : 
                          check.conclusion === 'failure' ? 'âŒ' :
                          check.status === 'in_progress' ? 'ğŸ”„' : 'â³';
              
              if (name.includes('plan:')) {
                const project = name.split(': ')[1];
                if (project) status.plan[project] = icon;
              } else if (name.includes('apply:')) {
                const project = name.split(': ')[1];
                if (project) status.apply[project] = icon;
              } else if (name === 'atlantis/plan') {
                // Overall plan status
                if (check.conclusion === 'success') {
                  Object.keys(status.plan).forEach(k => {
                    if (status.plan[k] === 'â³') status.plan[k] = 'âœ…';
                  });
                }
              }
            }
            
            return JSON.stringify(status);

      - name: Find infra-flash comment
        if: steps.get_pr.outputs.result != ''
        uses: peter-evans/find-comment@v3
        id: find_comment
        with:
          issue-number: ${{ steps.get_pr.outputs.result }}
          comment-author: 'infra-flash[bot]'
          body-includes: '<!-- infra-flash -->'
          token: ${{ steps.app_token.outputs.token }}

      - name: Update infra-flash comment
        if: steps.find_comment.outputs.comment-id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const commentId = '${{ steps.find_comment.outputs.comment-id }}';
            const prNumber = ${{ steps.get_pr.outputs.result }};
            const status = JSON.parse('${{ steps.atlantis_status.outputs.result }}');
            
            // Get current comment
            const { data: comment } = await github.rest.issues.getComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId
            });
            
            // Parse existing comment to preserve CI status
            let body = comment.body;
            
            // Update Atlantis section
            const atlantisSection = `
            ### ğŸ”® Atlantis Status
            
            | Project | Plan | Apply |
            |:--------|:----:|:-----:|
            | **platform** | ${status.plan.platform} | ${status.apply.platform} |
            | **data-staging** | ${status.plan['data-staging']} | ${status.apply['data-staging']} |
            | **data-prod** | ${status.plan['data-prod']} | ${status.apply['data-prod']} |
            `;
            
            // Replace or append Atlantis section
            if (body.includes('### ğŸ”® Atlantis Status')) {
              body = body.replace(/### ğŸ”® Atlantis Status[\s\S]*?(?=###|<details|$)/, atlantisSection);
            } else if (body.includes('### ğŸ”® Pipeline Status')) {
              body = body.replace(/### ğŸ”® Pipeline Status[\s\S]*?(?=###|<details|$)/, atlantisSection);
            } else {
              // Append before details section
              body = body.replace('---\n\n<details', atlantisSection + '\n---\n\n<details');
            }
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });
            
            console.log('Updated infra-flash comment with Atlantis status');

