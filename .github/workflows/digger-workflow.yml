# Digger Orchestrator Workflow
# Triggered by self-hosted Digger Orchestrator via workflow_dispatch
# Handles: auto-plan on PR, post-merge apply (on_commit_to_default)
#
# Flow:
# 1. GitHub sends webhook to Orchestrator (digger.zitian.party)
# 2. Orchestrator triggers this workflow via workflow_dispatch
# 3. Digger action runs plan/apply based on orchestrator instructions

name: Digger Workflow

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'Digger run id'
        required: false
      job:
        description: 'Job name'
        required: false
      comment_id:
        description: 'Comment id'
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: write
  statuses: write

env:
  PYTHON_VERSION: '3.11'
  TERRAGRUNT_VERSION: '0.68.4'
  KUBECONFIG_PATH: ${{ github.workspace }}/bootstrap/output/k3s-kubeconfig.yaml

jobs:
  digger-job:
    name: Digger Run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          secrets_json: ${{ toJSON(secrets) }}
      
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INFRA_FLASH_APP_ID }}
          private-key: ${{ secrets.INFRA_FLASH_APP_KEY }}
      
      - name: Digger Run
        uses: diggerhq/digger@v0.6.80
        with:
          setup-terragrunt: true
          terragrunt-version: ${{ env.TERRAGRUNT_VERSION }}
          # No digger-hostname or digger-token for self-hosted
          # Orchestrator already handles coordination
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          KUBECONFIG: ${{ env.KUBECONFIG_PATH }}
