name: Copilot Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  copilot:
    runs-on: ubuntu-latest
    # Trigger conditions:
    # Manual only: /review, @copilot, PTAL from any user (not bot)
    if: |
      (
        github.event_name == 'issue_comment' &&
        github.event.comment.user.type != 'Bot' &&
        (contains(lower(github.event.comment.body), '@copilot') || contains(lower(github.event.comment.body), '/review') || contains(lower(github.event.comment.body), 'ptal'))
      ) ||
      (
        github.event_name == 'pull_request_review_comment' &&
        github.event.comment.user.type != 'Bot' &&
        (contains(lower(github.event.comment.body), '@copilot') || contains(lower(github.event.comment.body), '/review') || contains(lower(github.event.comment.body), 'ptal'))
      ) ||
      (
        github.event_name == 'pull_request_review' &&
        github.event.review.user.type != 'Bot' &&
        (contains(lower(github.event.review.body), '@copilot') || contains(lower(github.event.review.body), '/review') || contains(lower(github.event.review.body), 'ptal'))
      )

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Get PR branch
        id: get_branch
        run: |
          PR_URL="${{ github.event.issue.pull_request.url || github.event.pull_request.html_url }}"
          BRANCH=$(gh pr view $PR_URL --json headRefName --template '{{.headRefName}}')
          SHA=$(gh pr view $PR_URL --json headRefOid --template '{{.headRefOid}}')
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "sha=${SHA:0:7}" >> $GITHUB_OUTPUT
          echo "full_sha=$SHA" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_branch.outputs.full_sha }}
          fetch-depth: 0

      - name: Run Copilot Review
        id: review
        uses: github/copilot-review-action@v1
        with:
          github_token: ${{ steps.app_token.outputs.token }}
          custom_prompt: |
            (Output ONLY the markdown body of your review. Do not create the comment yourself.)
            This is a Terraform IaC project with layered architecture (L1-L4).
            
            ## Documentation Guard (REQUIRED)
            Check if:
            1. `0.check_now.md` is updated
            2. Each changed directory's `README.md` is updated

            ## Code Review Criteria
            1. Structure: L1-nodep/L2-platform/L3-data/L4-insight alignment.
            2. SSOT: No duplicate config or hardcoded secrets.
            3. Terraform: `terraform fmt` and naming conventions.
          # We will handle the posting ourselves to keep infra-flash SSOT
          post_comment: false 

      - name: Update infra-flash comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const sha = '${{ steps.get_branch.outputs.sha }}';
            const reviewBody = `${{ steps.review.outputs.review_body }}`;
            const MARKER = `<!-- infra-flash-commit:${sha} -->`;
            const COPILOT_SECTION_START = '<!-- copilot-review -->';
            const COPILOT_SECTION_END = '<!-- /copilot-review -->';

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number || github.event.pull_request.number }},
              per_page: 100
            });
            
            const existing = comments.data.find(c => c.body.includes(MARKER));
            if (!existing) {
              console.log("No infra-flash comment found for this commit.");
              return;
            }

            const timestamp = new Date().toISOString().slice(11, 16) + ' UTC';
            const newContent = [
              COPILOT_SECTION_START,
              `### ðŸ¤– Copilot Review | ${timestamp}`,
              '',
              reviewBody,
              '',
              COPILOT_SECTION_END
            ].join('\n');

            let updatedBody;
            if (existing.body.includes(COPILOT_SECTION_START)) {
              // Replace existing section
              const regex = new RegExp(`${COPILOT_SECTION_START}[\\s\\S]*?${COPILOT_SECTION_END}`);
              updatedBody = existing.body.replace(regex, newContent);
            } else {
              // Append before Atlantis Actions
              updatedBody = existing.body.replace('### Atlantis Actions', `${newContent}\n\n---\n\n### Atlantis Actions`);
            }

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existing.id,
              body: updatedBody
            });
