name: Update infra-flash Comment

"on":
  issue_comment:
    types: [created]

jobs:
  update:
    # Âè™Â§ÑÁêÜ Atlantis bot Âú® PR ‰∏äÁöÑËØÑËÆ∫
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'infra-flash[bot]' &&
      (contains(github.event.comment.body, 'Ran Plan') ||
       contains(github.event.comment.body, 'Ran Apply'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    outputs:
      is_apply_success: ${{ steps.update_dashboard.outputs.is_apply_success }}
      pr_number: ${{ steps.update_dashboard.outputs.pr_number }}
      head_sha: ${{ steps.pr_sha.outputs.result }}

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Get PR head SHA
        id: pr_sha
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          result-encoding: string
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number
            });
            return pr.data.head.sha.substring(0, 7);

      - name: Update Dashboard
        id: update_dashboard
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = context.payload.issue.number;
            const atlantisBody = context.payload.comment.body;
            const atlantisCommentUrl = context.payload.comment.html_url;
            const timestamp = new Date().toISOString().slice(11, 16) + ' UTC';
            const currentSha = '${{ steps.pr_sha.outputs.result }}';

            // Parse commit SHA from Atlantis output
            const shaMatch = atlantisBody.match(/infra-flash-commit:([0-9a-f]{7,40})/i);
            const targetSha = (shaMatch ? shaMatch[1] : currentSha).substring(0, 7);

            const isPlan = atlantisBody.includes('Ran Plan');
            const isApply = atlantisBody.includes('Ran Apply');
            // Check for success - prioritize 'Apply complete!' over error patterns
            // IMPORTANT: terragrunt WARN or 'exit status' in logs should not cause false failures
            const applyComplete = /Apply complete!/i.test(atlantisBody);
            const planComplete = /Plan:.*to (add|import|change|destroy)/i.test(atlantisBody);
            const hasExplicitError = /\*\*(Plan|Apply) Error\*\*|panic:/i.test(atlantisBody) && !applyComplete;
            const isSuccess = (isApply && applyComplete) || (isPlan && planComplete) || (!hasExplicitError && (applyComplete || planComplete));

            const stage = isPlan ? 'Plan' : 'Apply';
            const statusIcon = isSuccess ? '‚úÖ' : '‚ùå';

            // Output for downstream jobs
            core.setOutput('is_apply_success', isApply && isSuccess ? 'true' : 'false');
            core.setOutput('pr_number', prNumber.toString());

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            // Find trigger comment and add üëÄ reaction
            const atlantisCommentTime = new Date(context.payload.comment.created_at);
            const triggerComment = comments
              .filter(c => new Date(c.created_at) < atlantisCommentTime)
              .filter(c => (c.body || '').toLowerCase().includes(`atlantis ${stage.toLowerCase()}`))
              .pop();

            if (triggerComment) {
              try {
                await github.rest.reactions.createForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: triggerComment.id,
                  content: 'eyes'
                });
                console.log(`Added üëÄ to trigger comment #${triggerComment.id}`);
              } catch (e) {
                console.log(`Could not add reaction: ${e.message}`);
              }
            }

            const prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${prNumber}`;
            const MARKER = `<!-- infra-flash-commit:${targetSha} -->`;

            let flashComment = comments.find(c =>
              c.user.login === 'infra-flash[bot]' &&
              c.body.includes(MARKER)
            );

            if (!flashComment) {
              console.log(`Creating dashboard for commit ${targetSha}`);

              const skeleton = [
                MARKER,
                `## ‚ö° Commit \`${targetSha}\` Dashboard`,
                "",
                "| Stage | Status | Link | Time |",
                "|:---|:---:|:---|:---|",
                "| Static CI | ‚è≥ | Pending | - |",
                `| Infra Plan | ‚è≥ | [View](${atlantisCommentUrl}) | ${timestamp} |`,
                "| Infra Apply | ‚è≠Ô∏è | - | - |",
                "| AI Review | ‚è≠Ô∏è | - | - |",
                "",
                "<details><summary>üìú Action History</summary>",
                "",
                "| Action | Trigger | Output | Time |",
                "|:---|:---|:---|:---|",
                "<!-- history-rows -->",
                "",
                "</details>",
                "",
                "<details><summary>üìñ Commands</summary>",
                "",
                "| Command | Description |",
                "|:---|:---|",
                "| `atlantis plan` | Re-run plan |",
                "| `atlantis apply` | Deploy changes |",
                "",
                "</details>",
                "",
                "<!-- next-step -->",
                "‚è≥ Waiting for results...",
                "<!-- /next-step -->"
              ].join('\n');

              const created = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: skeleton
              });
              flashComment = { id: created.data.id, body: skeleton };
            }

            let body = flashComment.body;

            // Update status table
            if (isPlan) {
              body = body.replace(
                /\| Infra Plan \| .* \| .* \| .* \|/,
                `| Infra Plan | ${statusIcon} | [View](${atlantisCommentUrl}) | ${timestamp} |`
              );
            } else if (isApply) {
              body = body.replace(
                /\| Infra Apply \| .* \| .* \| .* \|/,
                `| Infra Apply | ${statusIcon} | [View](${atlantisCommentUrl}) | ${timestamp} |`
              );
              // Reset AI Review to pending when apply succeeds
              if (isSuccess) {
                body = body.replace(
                  /\| AI Review \| .* \| .* \| .* \|/,
                  `| AI Review | ‚è≥ | Running... | ${timestamp} |`
                );
              }
            }

            // Build trigger link with üëÄ
            const triggerLink = triggerComment
              ? `[@${triggerComment.user.login.replace('[bot]', '')}](${triggerComment.html_url}) üëÄ`
              : 'autoplan';

            // Add history row
            const historyRow = `| ${stage} | ${triggerLink} | [result](${atlantisCommentUrl}) | ${timestamp} |`;
            body = body.replace('<!-- history-rows -->', `${historyRow}\n<!-- history-rows -->`);

            // Update next step with actionable guidance
            let nextStep = '‚è≥ Waiting for results...';
            if (isPlan && isSuccess) {
              nextStep = `Review [plan output](${atlantisCommentUrl}), then comment \`atlantis apply\``;
            } else if (isApply && isSuccess) {
              nextStep = '‚úÖ Ready to merge';
            } else if (!isSuccess) {
              nextStep = `See [${stage.toLowerCase()} output](${atlantisCommentUrl}) for errors`;
            }
            body = body.replace(/<!-- next-step -->[\s\S]*?<!-- \/next-step -->/, `<!-- next-step -->\n${nextStep}\n<!-- /next-step -->`);

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: flashComment.id,
              body: body
            });

            console.log(`Updated dashboard: ${stage} ${statusIcon}`);
