name: Update infra-flash Comment

on:
  issue_comment:
    types: [created]

jobs:
  update:
    # åªå¤„ç† Atlantis bot åœ¨ PR ä¸Šçš„è¯„è®º
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'infra-flash[bot]' &&
      (contains(github.event.comment.body, 'Ran Plan') || 
       contains(github.event.comment.body, 'Ran Apply'))
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Get PR head SHA
        id: pr_sha
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          result-encoding: string
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number
            });
            return pr.data.head.sha.substring(0, 7);

      - name: Update infra-flash comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = context.payload.issue.number;
            const atlantisBody = context.payload.comment.body;
            const atlantisCommentUrl = context.payload.comment.html_url;
            const timestamp = new Date().toISOString().slice(11, 16) + ' UTC';
            const currentSha = '${{ steps.pr_sha.outputs.result }}';
            
            // åˆ¤æ–­æ˜¯ plan è¿˜æ˜¯ apply
            const isPlan = atlantisBody.includes('Ran Plan');
            const isApply = atlantisBody.includes('Ran Apply');
            const isSuccess = !/(failed|error|panic:)/i.test(atlantisBody);
            
            const stage = isPlan ? 'Plan' : 'Apply';
            const icon = isSuccess ? 'âœ…' : 'âŒ';
            
            // è·å–æ‰€æœ‰è¯„è®ºï¼ˆåˆ†é¡µï¼‰ï¼Œæ‰¾è§¦å‘å‘½ä»¤çš„äººç±»è¯„è®º
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });
            
            // æ‰¾åˆ°è§¦å‘æ­¤æ“ä½œçš„äººç±»è¯„è®ºï¼ˆåœ¨ Atlantis è¯„è®ºä¹‹å‰ï¼ŒåŒ…å« atlantis plan/applyï¼‰
            const atlantisCommentTime = new Date(context.payload.comment.created_at);
            const triggerComment = comments
              .filter(c => c.user?.type !== 'Bot')
              .filter(c => new Date(c.created_at) < atlantisCommentTime)
              .filter(c => (c.body || '').toLowerCase().includes(`atlantis ${stage.toLowerCase()}`))
              .pop();  // å–æœ€è¿‘çš„ä¸€æ¡
            
            const triggerUrl = triggerComment ? triggerComment.html_url : null;
            
            // æ‰¾åˆ°å½“å‰æ“ä½œå¯¹åº”çš„ infra-flash è¯„è®ºï¼š
            // - ä¼˜å…ˆï¼šç”¨è§¦å‘è¯„è®ºæ—¶é—´å¯¹é½æœ€è¿‘ä¸€æ¬¡ CI è¯„è®ºï¼ˆé¿å… Atlantis æ‰§è¡ŒæœŸé—´ PR åˆ push å¯¼è‡´ head SHA æ¼‚ç§»ï¼‰
            // - å…œåº•ï¼šç”¨ PR head SHA marker ç²¾ç¡®åŒ¹é…
            const triggerTime = triggerComment ? new Date(triggerComment.created_at) : null;
            const flashCommentByTriggerTime = triggerTime
              ? comments
                  .filter(c => c.user.login === 'infra-flash[bot]')
                  .filter(c => c.body.includes('<!-- infra-flash-commit:'))
                  .filter(c => new Date(c.created_at) <= triggerTime)
                  .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
                  .pop()
              : null;
            
            const flashCommentByHeadSha = comments.find(c =>
              c.user.login === 'infra-flash[bot]' &&
              c.body.includes(`<!-- infra-flash-commit:${currentSha} -->`)
            );
            
            const flashComment = flashCommentByTriggerTime || flashCommentByHeadSha;
            
            if (!flashComment) {
              console.log(`No infra-flash comment found (triggerSha=${triggerTime ? 'by-time' : 'none'}, headSha=${currentSha})`);
              return;
            }
            
            // ç¡®å®šä¸‹ä¸€æ­¥æ“ä½œ
            let nextStep = '';
            if (isPlan && isSuccess) {
              nextStep = '\n\nğŸ‘‰ **Next:** Review plan, then comment `atlantis apply`';
            } else if (isApply && isSuccess) {
              nextStep = '\n\nâœ… **Ready to merge!**';
            } else if (!isSuccess) {
              nextStep = '\n\nğŸ‘‰ **Next:** Fix errors (push if needed), then `atlantis plan`';
            }
            
            // ç§»é™¤æ—§çš„ next step æç¤º
            let updatedBody = flashComment.body
              .replace(/\n*ğŸ‘‰ \*\*Next:\*\*.*/g, '')
              .replace(/\n*âœ… \*\*Ready to merge!\*\*/g, '');
            
            // æ„å»ºé“¾æ¥
            const triggerLink = triggerUrl ? `[Triggered by](${triggerUrl})` : 'Manual trigger';
            const outputLink = `[View output](${atlantisCommentUrl})`;
            
            // æ„å»ºæ–°çš„ Atlantis çŠ¶æ€å—
            const newSection = `

---

### Atlantis ${stage} ${icon} | ${timestamp}

ğŸ“ ${triggerLink} â†’ ${outputLink}${nextStep}`;
            
            // ç§»é™¤æ—§çš„åŒç±»å‹çŠ¶æ€ï¼ˆé¿å…é‡å¤ï¼‰
            const sectionRegex = new RegExp(`\\n---\\n+### Atlantis ${stage}[\\s\\S]*?(?=\\n---|$)`, 'g');
            updatedBody = updatedBody.replace(sectionRegex, '');
            
            // è¿½åŠ æ–°çŠ¶æ€
            updatedBody = updatedBody.trim() + newSection;
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: flashComment.id,
              body: updatedBody
            });
            
            console.log(`Updated comment for commit ${currentSha} with ${stage} ${icon}`);
