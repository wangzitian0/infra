name: Update infra-flash Comment

"on":
  issue_comment:
    types: [created]

jobs:
  update:
    # åªå¤„ç† Atlantis bot åœ¨ PR ä¸Šçš„è¯„è®º
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'infra-flash[bot]' &&
      (contains(github.event.comment.body, 'Ran Plan') || 
       contains(github.event.comment.body, 'Ran Apply'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Get PR head SHA
        id: pr_sha
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          result-encoding: string
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number
            });
            return pr.data.head.sha.substring(0, 7);

      - name: Update infra-flash comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = context.payload.issue.number;
            const atlantisBody = context.payload.comment.body;
            const atlantisCommentUrl = context.payload.comment.html_url;
            const timestamp = new Date().toISOString().slice(11, 16) + ' UTC';
            const currentSha = '${{ steps.pr_sha.outputs.result }}';
            
            // Parse commit SHA from Atlantis output (infra-flash-commit:xxxxxxx in the plan/apply output)
            const shaMatch = atlantisBody.match(/infra-flash-commit:([0-9a-f]{7,40})/i);
            const targetSha = (shaMatch ? shaMatch[1] : currentSha).substring(0, 7);
            
            // åˆ¤æ–­æ˜¯ plan è¿˜æ˜¯ apply
            const isPlan = atlantisBody.includes('Ran Plan');
            const isApply = atlantisBody.includes('Ran Apply');
            
            // Atlantis ç‰¹å®šçš„å¤±è´¥æ ‡è®°ï¼ˆä¸æ˜¯ç®€å•åŒ¹é… "error"ï¼‰
            // æˆåŠŸ: "Plan: X to add", "Apply complete!"
            // å¤±è´¥: "**Plan Error**", "**Apply Error**", "exit status 1"
            const hasAtlantisError = /\*\*(Plan|Apply) Error\*\*|exit status [1-9]|panic:|terraform:.*failed/i.test(atlantisBody);
            const isSuccess = !hasAtlantisError;
            
            const stage = isPlan ? 'Plan' : 'Apply';
            const icon = isSuccess ? 'âœ…' : 'âŒ';
            
            // è·å–æ‰€æœ‰è¯„è®º
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });
            
            // æ‰¾åˆ°è§¦å‘æ­¤æ“ä½œçš„è¯„è®ºï¼ˆäººç±»æˆ– botï¼‰
            const atlantisCommentTime = new Date(context.payload.comment.created_at);
            const triggerComment = comments
              .filter(c => new Date(c.created_at) < atlantisCommentTime)
              .filter(c => (c.body || '').toLowerCase().includes(`atlantis ${stage.toLowerCase()}`))
              .pop();
            
            const prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${prNumber}`;
            
            // Find infra-flash comment for the commit that Atlantis actually processed
            // Use targetSha (from Atlantis output) not currentSha (PR HEAD may have moved)
            const MARKER = `<!-- infra-flash-commit:${targetSha} -->`;
            const flashComment = comments.find(c =>
              c.user.login === 'infra-flash[bot]' &&
              c.body.includes(MARKER)
            );
            
            if (!flashComment) {
              console.log(`No infra-flash comment found for commit ${currentSha}`);
              return;
            }
            
            // ç¡®å®šä¸‹ä¸€æ­¥æ“ä½œ
            let nextStep = '';
            if (isPlan && isSuccess) {
              nextStep = '\n\nğŸ‘‰ **Next:** Review plan, then comment `atlantis apply`';
            } else if (isApply && isSuccess) {
              nextStep = '\n\nâœ… **Ready to merge!**';
            } else if (!isSuccess) {
              nextStep = isPlan
                ? '\n\nğŸ‘‰ **Next:** Fix errors, then comment `atlantis plan`'
                : '\n\nğŸ‘‰ **Next:** Fix errors, then comment `atlantis apply` (or rerun `atlantis plan`)';
            }
            
            // ç§»é™¤æ—§çš„ next step æç¤º
            let updatedBody = flashComment.body
              .replace(/\n*ğŸ‘‰ \*\*Next:\*\*.*/g, '')
              .replace(/\n*âœ… \*\*Ready to merge!\*\*/g, '')
              .replace(/\n*â³ \*\*Triggering Atlantis plan\.\.\.\*\*/g, '')
              .replace(/\n*âŒ \*\*CI failed\.\*\*.*/g, '');
            
            // æ„å»ºè§¦å‘é“¾æ¥
            // æ ¼å¼: [@user #comment-id](link) æˆ– [@autoplan #atlantis-id](link)
            let triggerLink;
            if (triggerComment) {
              // äººç±»æˆ– bot è¯„è®ºè§¦å‘
              const commentId = triggerComment.id;
              const username = triggerComment.user.login.replace('[bot]', '');
              triggerLink = `[@${username} #${commentId}](${triggerComment.html_url})`;
            } else {
              // autoplan: é“¾æ¥åˆ° Atlantis è¾“å‡ºè¯„è®ºæœ¬èº«
              const atlantisCommentId = context.payload.comment.id;
              triggerLink = `[@autoplan #${atlantisCommentId}](${atlantisCommentUrl})`;
            }
            const outputLink = `[output](${atlantisCommentUrl})`;
            
            // æ„å»ºæ–°æ“ä½œè®°å½•è¡Œ
            const actionRow = `| ${stage} | ${triggerLink} | ${icon} | ${outputLink} | ${timestamp} |`;
            
            // æ‰¾åˆ°æˆ–åˆ›å»º Atlantis Actions è¡¨æ ¼
            const tableMarker = '<!-- atlantis-actions -->';
            if (updatedBody.includes(tableMarker)) {
              // è¿½åŠ æ–°è¡Œåˆ°è¡¨æ ¼
              const tableEnd = updatedBody.indexOf('<!-- /atlantis-actions -->');
              if (tableEnd > 0) {
                updatedBody = updatedBody.slice(0, tableEnd) + actionRow + '\n' + updatedBody.slice(tableEnd);
              }
            } else {
              // åˆ›å»ºæ–°è¡¨æ ¼
              const newTable = [
                '',
                '---',
                '### Atlantis Actions',
                '',
                tableMarker,
                '| Action | Trigger | Status | Output | Time |',
                '|:-------|:--------|:------:|:-------|:-----|',
                actionRow,
                '<!-- /atlantis-actions -->',
                ''
              ].join('\n');
              updatedBody = updatedBody.trim() + newTable;
            }
            
            // è¿½åŠ  next step
            updatedBody = updatedBody.trim() + nextStep;
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: flashComment.id,
              body: updatedBody
            });
            
            console.log(`Updated infra-flash comment for ${targetSha} with ${stage} ${icon}`);
