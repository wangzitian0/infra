name: Update infra-flash Comment

"on":
  issue_comment:
    types: [created]

jobs:
  update:
    # Âè™Â§ÑÁêÜ Atlantis bot Âú® PR ‰∏äÁöÑËØÑËÆ∫
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'infra-flash[bot]' &&
      (contains(github.event.comment.body, 'Ran Plan') || 
       contains(github.event.comment.body, 'Ran Apply'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Get PR head SHA
        id: pr_sha
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          result-encoding: string
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number
            });
            return pr.data.head.sha.substring(0, 7);

      - name: Add eyes reaction to atlantis comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Update infra-flash comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = context.payload.issue.number;
            const atlantisBody = context.payload.comment.body;
            const atlantisCommentUrl = context.payload.comment.html_url;
            const timestamp = new Date().toISOString().slice(11, 16) + ' UTC';
            const currentSha = '${{ steps.pr_sha.outputs.result }}';
            
            // Parse commit SHA from Atlantis output (infra-flash-commit:xxxxxxx in the plan/apply output)
            const shaMatch = atlantisBody.match(/infra-flash-commit:([0-9a-f]{7,40})/i);
            const targetSha = (shaMatch ? shaMatch[1] : currentSha).substring(0, 7);
            
            // Âà§Êñ≠ÊòØ plan ËøòÊòØ apply
            const isPlan = atlantisBody.includes('Ran Plan');
            const isApply = atlantisBody.includes('Ran Apply');
            
            // Atlantis ÁâπÂÆöÁöÑÂ§±Ë¥•Ê†áËÆ∞Ôºà‰∏çÊòØÁÆÄÂçïÂåπÈÖç "error"Ôºâ
            // ÊàêÂäü: "Plan: X to add", "Apply complete!"
            // Â§±Ë¥•: "**Plan Error**", "**Apply Error**", "exit status 1"
            const hasAtlantisError = /\*\*(Plan|Apply) Error\*\*|exit status [1-9]|panic:|terraform:.*failed/i.test(atlantisBody);
            const isSuccess = !hasAtlantisError;
            
            const stage = isPlan ? 'Plan' : 'Apply';
            const icon = isSuccess ? '‚úÖ' : '‚ùå';
            
            // Ëé∑ÂèñÊâÄÊúâËØÑËÆ∫
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });
            
            // ÊâæÂà∞Ëß¶ÂèëÊ≠§Êìç‰ΩúÁöÑËØÑËÆ∫Ôºà‰∫∫Á±ªÊàñ botÔºâ
            const atlantisCommentTime = new Date(context.payload.comment.created_at);
            const triggerComment = comments
              .filter(c => new Date(c.created_at) < atlantisCommentTime)
              .filter(c => (c.body || '').toLowerCase().includes(`atlantis ${stage.toLowerCase()}`))
              .pop();
            
            const prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${prNumber}`;
            
            // Find infra-flash comment for the commit that Atlantis actually processed
            // Use targetSha (from Atlantis output) not currentSha (PR HEAD may have moved)
            const MARKER = `<!-- infra-flash-commit:${targetSha} -->`;
            const flashComment = comments.find(c =>
              c.user.login === 'infra-flash[bot]' &&
              c.body.includes(MARKER)
            );
            
            if (!flashComment) {
              console.log(`No infra-flash comment found for commit ${targetSha}. Creating skeleton now.`);
              
              // Define skeleton matching terraform-plan.yml
              const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions`;
              const commandHelp = [
                '<details><summary>üìñ Available Infra Commands</summary>',
                '',
                '| Command | Description | Feedback |',
                '|:---|:---|:---|',
                '| `atlantis plan` | Re-run infrastructure plan | Append to this table |',
                '| `atlantis apply` | Deploy changes | Append to this table |',
                '| `@claude review this` | AI Code Review | New comment reply |',
                '| `infra dig` | Service Health Check | Append to dashboard |',
                '| `infra help` | Show detailed help | New reply |',
                '',
                '</details>'
              ].join('\n');

              // Find trigger comment for initial autoplan
              const triggerInfo = triggerComment
                ? `[@${triggerComment.user.login.replace('[bot]', '')}](${triggerComment.html_url})`
                : '[autoplan on push]';

              const skeleton = [
                MARKER,
                `## ‚ö° Commit \`${targetSha}\` Dashboard`,
                "",
                `**Triggered by:** ${triggerInfo}`,
                "",
                "| Component | Status | Info/Link | Time |",
                "|:---|:---:|:---|:---|",
                "| **Static CI** | ‚è≥ | Pending | - |",
                "| **AI Review** | ‚è≥ | Pending | - |",
                `| **Infra Plan** | ‚è≥ | [Running Output](${atlantisCommentUrl}) | ${timestamp} |`,
                "| **Infra Apply** | ‚è≠Ô∏è | - | - |",
                "| **Health Check** | ‚è≠Ô∏è | - | - |",
                "",
                "---",
                "",
                "<!-- claude-review-placeholder -->",
                "",
                "---",
                "",
                "### üöÄ Atlantis Actions",
                "",
                "<!-- atlantis-actions -->",
                "| Action | Commit | Trigger | Status | Output | Time |",
                "|:-------|:-------|:--------|:------:|:-------|:-----|",
                "<!-- /atlantis-actions -->",
                "",
                "<!-- health-check-placeholder -->",
                "",
                "---",
                commandHelp,
                "",
                "---",
                "‚è≥ **Waiting for results...**"
              ].join('\n');

              const created = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: skeleton
              });
              
              // Reload flashComment to continue update logic
              flashComment = { id: created.data.id, body: skeleton };
            }
            
            // Á°ÆÂÆö‰∏ã‰∏ÄÊ≠•Êìç‰Ωú
            let nextStep = '';
            if (isPlan && isSuccess) {
              nextStep = 'üëâ **Recommended Next Step:** Review plan, then comment `atlantis apply`';
            } else if (isApply && isSuccess) {
              nextStep = 'üëâ **Recommended Next Step:** ‚úÖ **Ready to merge!**';
            } else if (!isSuccess) {
              nextStep = isPlan
                ? 'üëâ **Recommended Next Step:** ‚ùå **Plan failed.** Fix errors, then comment `atlantis plan` (or push again)'
                : 'üëâ **Recommended Next Step:** ‚ùå **Apply failed.** Fix errors, then comment `atlantis apply`';
            }
            
            let updatedBody = flashComment.body;
            
            // Update Global Status Table for Atlantis
            const statusIcon = isSuccess ? '‚úÖ' : '‚ùå';
            if (isPlan) {
              updatedBody = updatedBody.replace(
                /\| \*\*Infra Plan\*\* \| .* \| .* \| .* \|/,
                `| **Infra Plan** | ${statusIcon} | [View Output](${atlantisCommentUrl}) | ${timestamp} |`
              );
            } else if (isApply) {
              updatedBody = updatedBody.replace(
                /\| \*\*Infra Apply\*\* \| .* \| .* \| .* \|/,
                `| **Infra Apply** | ${statusIcon} | [View Output](${atlantisCommentUrl}) | ${timestamp} |`
              );
            }

            // Update Next Step using placeholder
            const nextStepSection = `<!-- next-step-placeholder -->\n${nextStep}\n<!-- /next-step-placeholder -->`;
            if (updatedBody.includes('<!-- next-step-placeholder -->')) {
              updatedBody = updatedBody.replace(/<!-- next-step-placeholder -->[\s\S]*?<!-- \/next-step-placeholder -->/, nextStepSection);
            } else {
              // Cleanup old styles and append new section
              updatedBody = updatedBody
                .replace(/\n*üëâ \*\*Recommended Next Step:\*\*.*/g, '')
                .replace(/\n*‚è≥ \*\*Waiting for results\.\.\.\*\*/g, '')
                .trim() + '\n\n' + nextStepSection;
            }

            // ÊûÑÂª∫Ëß¶ÂèëÈìæÊé•
            let triggerLink;
            if (triggerComment) {
              const username = triggerComment.user.login.replace('[bot]', '');
              triggerLink = `[@${username} #${triggerComment.id}](${triggerComment.html_url})`;
            } else {
              triggerLink = `[@autoplan #${context.payload.comment.id}](${atlantisCommentUrl})`;
            }
            const outputLink = `[output](${atlantisCommentUrl})`;
            
            // ÊûÑÂª∫Êñ∞Êìç‰ΩúËÆ∞ÂΩïË°å
            const commitLink = `[\`${targetSha}\`](${prUrl}/commits/${targetSha})`;
            const actionRow = `| ${stage} | ${commitLink} | ${triggerLink} | ${statusIcon} | ${outputLink} | ${timestamp} |`;
            
            // ÊâæÂà∞ Atlantis Actions Ë°®Ê†ºÂπ∂ËøΩÂä†
            if (updatedBody.includes('<!-- atlantis-actions -->')) {
              updatedBody = updatedBody.replace('<!-- /atlantis-actions -->', `${actionRow}\n<!-- /atlantis-actions -->`);
            }
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: flashComment.id,
              body: updatedBody
            });
            
            console.log(`Updated infra-flash comment for ${targetSha} with ${stage} ${icon}`);
