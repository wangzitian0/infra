name: E2E Regression Tests

on:
  # Post-merge: 合并到 main 后立即运行
  push:
    branches: [main]
    paths:
      - 'platform/**'
      - 'envs/*/data/**'
      - 'platform/**'

  # 手动触发或由 Atlantis 调用
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Test scope to run'
        required: false
        default: 'all'
        type: choice
        options:
          - smoke
          - compute
          - storage
          - network
          - all
      pr_number:
        description: 'PR number for dashboard update'
        required: false
        type: string
      commit_sha:
        description: 'Full commit SHA for dashboard update'
        required: false
        type: string

  # 供其他 workflow 调用
  workflow_call:
    inputs:
      test_scope:
        description: 'Test scope to run'
        required: false
        default: 'all'
        type: string
      pr_number:
        description: 'PR number for dashboard update'
        required: false
        type: string
      commit_sha:
        description: 'Full commit SHA for dashboard update'
        required: false
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  PORTAL_URL: https://home.zitian.party
  SSO_URL: https://sso.zitian.party
  VAULT_URL: https://secrets.zitian.party
  DASHBOARD_URL: https://kdashboard.zitian.party
  # Used for mapping test scopes to markers
  SCOPE_COMPUTE: "-m bootstrap and compute"
  SCOPE_STORAGE: "-m bootstrap and storage"
  SCOPE_NETWORK: "-m bootstrap and network"

jobs:
  e2e-smoke:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        working-directory: e2e_regressions
        run: |
          uv sync
          uv run playwright install chromium

      - name: Determine test scope
        id: scope
        run: |
          SCOPE="${{ inputs.test_scope || 'smoke' }}"
          if [ "$SCOPE" = "all" ]; then
            echo "marker=" >> $GITHUB_OUTPUT
          else
            echo "marker=-m $SCOPE" >> $GITHUB_OUTPUT
          fi

      - name: Generate App Token
        if: inputs.pr_number || github.event.pull_request.number
        id: app_token_init
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Set initial status
        if: inputs.pr_number || github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token_init.outputs.token }}
          script: |
            const sha = ('${{ inputs.commit_sha }}' || context.sha).substring(0, 7);
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // 1. Set Commit Status to Pending
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ inputs.commit_sha }}' || context.sha,
              state: 'pending',
              context: 'e2e/smoke-test',
              description: 'E2E tests running...',
              target_url: runUrl
            });

      - name: Run E2E tests
        working-directory: e2e_regressions
        run: |
          SCOPE="${{ inputs.test_scope || 'all' }}"
          case $SCOPE in
            smoke)   MARKER="-m smoke" ;;
            compute) MARKER="$SCOPE_COMPUTE" ;;
            storage) MARKER="$SCOPE_STORAGE" ;;
            network) MARKER="$SCOPE_NETWORK" ;;
            all)     MARKER="" ;;
            *)       MARKER="-m smoke" ;;
          esac
          uv run pytest $MARKER -v --tb=short

      - name: Generate HTML report
        if: always()
        working-directory: e2e_regressions
        run: |
          uv run pytest -m smoke --html=report.html --self-contained-html || true

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report
          path: e2e_regressions/report.html
          retention-days: 14

      - name: Generate App Token
        if: always() && (inputs.pr_number || github.event.pull_request.number)
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Update Dashboard (CI)
        if: always() && (inputs.pr_number || github.event.pull_request.number)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/tools
        run: |
          PR="${{ inputs.pr_number || github.event.pull_request.number }}"
          STATUS="${{ job.status }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          python -m ci update --pr "$PR" --stage e2e --status "$STATUS" --link "$RUN_URL"

      - name: Post result summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "### ✅ E2E Tests Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ E2E Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Scope**: ${{ inputs.test_scope || 'smoke' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
