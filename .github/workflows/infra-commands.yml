name: Infra Commands

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]
  workflow_dispatch:

jobs:
  dispatch:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.comment.user.type != 'Bot' && startsWith(lower(github.event.comment.body), 'infra')) ||
      (github.event_name == 'workflow_dispatch')

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Acknowledge Command
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Parse Command
        id: parse
        run: |
          EVENT_NAME="${{ github.event_name }}"
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            echo "command=review" >> $GITHUB_OUTPUT
            echo "valid=true" >> $GITHUB_OUTPUT
          elif [[ "$EVENT_NAME" == "issue_comment" ]]; then
            RAW_BODY="${{ github.event.comment.body }}"
            FIRST_LINE=$(echo "$RAW_BODY" | head -n 1 | xargs | tr '[:upper:]' '[:lower:]')
            echo "Processing command line: $FIRST_LINE"
            if [[ "$FIRST_LINE" == "infra review"* ]]; then
              echo "command=review" >> $GITHUB_OUTPUT
              echo "valid=true" >> $GITHUB_OUTPUT
            elif [[ "$FIRST_LINE" == "infra dig"* ]]; then
              echo "command=dig" >> $GITHUB_OUTPUT
              echo "valid=true" >> $GITHUB_OUTPUT
            elif [[ "$FIRST_LINE" == "infra help"* ]] || [[ "$FIRST_LINE" == "infra" ]]; then
              echo "command=help" >> $GITHUB_OUTPUT
              echo "valid=true" >> $GITHUB_OUTPUT
            else
              echo "valid=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "command=help" >> $GITHUB_OUTPUT
            echo "valid=true" >> $GITHUB_OUTPUT
          fi

      - name: Get PR Info
        if: steps.parse.outputs.valid == 'true'
        id: pr
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            SHA="${{ github.event.pull_request.head.sha }}"
            echo "sha=${SHA:0:7}" >> $GITHUB_OUTPUT
            echo "full_sha=$SHA" >> $GITHUB_OUTPUT
          else
            PR_JSON=$(gh pr view ${{ github.event.issue.number }} --json headRefName,headRefOid)
            BRANCH=$(echo "$PR_JSON" | jq -r .headRefName)
            SHA=$(echo "$PR_JSON" | jq -r .headRefOid)
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "sha=${SHA:0:7}" >> $GITHUB_OUTPUT
            echo "full_sha=$SHA" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}

      - name: Checkout
        if: steps.parse.outputs.valid == 'true' && steps.parse.outputs.command != 'help'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.full_sha }}
          fetch-depth: 0

      - name: Help Command
        if: steps.parse.outputs.command == 'help'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const body = [
              "### üõ†Ô∏è Available Infra Commands",
              "",
              "| Command | Description | Feedback |",
              "|:---|:---|:---|",
              "| `infra review` | AI Code Review by Gemini | Append to `infra-flash` |",
              "| `infra dig` | Global Service Health Check | Append to `infra-flash` |",
              "| `infra help` | Show this help message | New reply |",
              "",
              "---",
              "_Commands are case-insensitive. Consistent with `atlantis plan` style._"
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number || github.event.pull_request.number }},
              body: body
            });

      - name: Run Gemini Review
        if: steps.parse.outputs.command == 'review'
        id: review
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          model: 'gemini-1.5-flash'
          prompt: |
            You are a Senior SRE reviewing a Terraform IaC project.
            Reference AGENTS.md conventions.
            Review for:
            1. Layers (L1-L4) correctness.
            2. SSOT principles.
            3. Doc Guard (0.check_now.md and README.md).
            Output your review in concise Markdown.

      - name: Extract Review Body
        if: steps.parse.outputs.command == 'review'
        id: extract
        run: |
          echo "review_body<<EOF" >> $GITHUB_OUTPUT
          echo "${{ steps.review.outputs.text }}" | head -c 50000 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Health Checks
        if: steps.parse.outputs.command == 'dig'
        id: health_check
        env:
          BASE_DOMAIN: ${{ secrets.BASE_DOMAIN }}
        run: |
          SERVICES=("L1|K3s API|i-k3s:6443" "L1|Atlantis|i-atlantis" "L2|Vault|i-secrets" "L2|K8s Dashboard|i-kdashboard" "L2|Kubero UI|i-kcloud" "L4|SigNoz|i-signoz" "Prod|Root|@")
          TABLE="| Layer | Service | Status |\n|:---|:---|:---|"
          for entry in "${SERVICES[@]}"; do
            IFS='|' read -r layer service sub <<< "$entry"
            domain="${sub}.${BASE_DOMAIN}"; [[ "$sub" == "@" ]] && domain="${BASE_DOMAIN}"
            [[ "$sub" == *":"* ]] && domain="${sub%%:*}.${BASE_DOMAIN}:${sub##*:}"
            code=$(curl -s -o /dev/null -w "%{{http_code}}" --connect-timeout 3 "https://${domain}" || echo "000")
            icon="‚ùå"; [[ "$code" == "200" || "$code" == "401" ]] && icon="‚úÖ"
            TABLE+="\n| $layer | $service | $icon $code |"
          done
          echo "table<<EOFTABLE" >> $GITHUB_OUTPUT
          echo -e "$TABLE" >> $GITHUB_OUTPUT
          echo "EOFTABLE" >> $GITHUB_OUTPUT

      - name: Update infra-flash
        if: always() && steps.parse.outputs.valid == 'true' && (steps.parse.outputs.command == 'review' || steps.parse.outputs.command == 'dig')
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const sha = '${{ steps.pr.outputs.sha }}';
            const cmd = '${{ steps.parse.outputs.command }}';
            const MARKER = `<!-- infra-flash-commit:${sha} -->`;
            let triggerInfo = 'ü§ñ [Automatic]';
            if (context.eventName === 'issue_comment') {
              triggerInfo = `üôã Triggered by [@${context.payload.comment.user.login}](${context.payload.comment.html_url})`;
            }
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number || github.event.pull_request.number }},
              per_page: 100
            });
            const existing = comments.find(c => c.body.includes(MARKER));
            if (!existing) return;
            const timestamp = new Date().toISOString().slice(11, 16) + ' UTC';
            let body = existing.body;
            if (cmd === 'review') {
              const reviewBody = `${{ steps.extract.outputs.review_body }}` || "AI Review Completed.";
              const section = ['<!-- copilot-review-placeholder -->', `### ü§ñ AI Review (Gemini) | ${timestamp}`, `> ${triggerInfo}`, '', reviewBody, '', '---'].join('\n');
              body = body.replace(/| **AI Review** | .* | .* | .* |/, `| **AI Review** | ‚úÖ | [View Details](#copilot-review-placeholder) | ${timestamp} |`);
              body = body.includes('<!-- copilot-review-placeholder -->') ? body.replace('<!-- copilot-review-placeholder -->', section) : body.replace('### üöÄ Atlantis Actions', `${section}\n\n### üöÄ Atlantis Actions`);
            }
            if (cmd === 'dig') {
              const table = `${{ steps.health_check.outputs.table }}`;
              const section = ['<!-- health-check-placeholder -->', `### üîç Health Check: [dig] | ${timestamp}`, `> ${triggerInfo}`, '', table, '', '---'].join('\n');
              body = body.replace(/| **Health Check** | .* | .* | .* |/, `| **Health Check** | ‚úÖ | [View Details](#health-check-placeholder) | ${timestamp} |`);
              body = body.includes('<!-- health-check-placeholder -->') ? body.replace('<!-- health-check-placeholder -->', section) : body.replace('---', `${section}\n\n---`);
            }
            await github.rest.issues.updateComment({
              owner: context.repo.owner, repo: context.repo.repo,
              comment_id: existing.id, body: body
            });