name: Operations Hub

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

jobs:
  dispatch:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.comment.user.type != 'Bot' && (contains(github.event.comment.body, 'infra') || contains(github.event.comment.body, 'Infra'))) ||
      (github.event_name == 'workflow_dispatch')

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Acknowledge
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner, repo: context.repo.repo,
              comment_id: context.payload.comment.id, content: 'eyes'
            });

      - name: Parse
        id: parse
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            if [[ -z "${{ github.event.issue.pull_request }}" ]]; then
              echo "valid=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            BODY=$(echo "${{ github.event.comment.body }}" | head -n 1 | tr '[:upper:]' '[:lower:]')
            if [[ "$BODY" == *"infra dig"* ]]; then
              echo "command=dig" >> $GITHUB_OUTPUT
              echo "valid=true" >> $GITHUB_OUTPUT
            else
              echo "command=help" >> $GITHUB_OUTPUT
              echo "valid=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: PR Info
        if: steps.parse.outputs.valid == 'true'
        id: pr
        run: |
          JSON=$(gh pr view ${{ github.event.issue.number }} --json headRefName,headRefOid)
          echo "branch=$(echo $JSON | jq -r .headRefName)" >> $GITHUB_OUTPUT
          echo "sha=$(echo $JSON | jq -r .headRefOid)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}

      - name: Health Check
        if: steps.parse.outputs.command == 'dig'
        id: dig
        continue-on-error: true
        env:
          BASE_DOMAIN: ${{ secrets.BASE_DOMAIN }}
        run: |
          SERVICES=("L1|K3s API|i-k3s:6443" "L1|Atlantis|i-atlantis" "L2|Vault|i-secrets" "L2|K8s Dashboard|i-kdashboard" "L2|Kubero UI|i-kcloud" "L4|SigNoz|i-signoz" "Prod|Root|@")
          TABLE="| Layer | Service | Status |\n|:---|:---|:---|"
          for entry in "${SERVICES[@]}"; do
            IFS='|' read -r l s sub <<< "$entry"
            domain="${sub}.${BASE_DOMAIN}"; [[ "$sub" == "@" ]] && domain="${BASE_DOMAIN}"
            [[ "$sub" == *":"* ]] && domain="${sub%%:*}.${BASE_DOMAIN}:${sub##*:}"
            code=$(curl -s -o /dev/null -w "%{{http_code}}" --connect-timeout 3 "https://${domain}" || echo "000")
            icon="‚ùå"; [[ "$code" == "200" || "$code" == "401" ]] && icon="‚úÖ"
            TABLE+="\n| $l | $s | $icon $code |"
          done
          echo "table<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update Dashboard
        if: always() && steps.parse.outputs.valid == 'true' && steps.parse.outputs.command != 'help'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const sha = '${{ steps.pr.outputs.sha }}'.substring(0,7);
            const cmd = '${{ steps.parse.outputs.command }}';
            const marker = `<!-- infra-flash-commit:${sha} -->`;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number || github.event.pull_request.number }},
              per_page: 100
            });
            const existing = comments.find(c => c.body.includes(marker));
            if (!existing) return;
            const ts = new Date().toISOString().slice(11, 16) + ' UTC';
            let body = existing.body;
            if (cmd === 'dig') {
              const content = `${{ steps.dig.outputs.table }}`;
              const section = ['<!-- health-check-placeholder -->', `### üîç Health Check | ${ts}`, content, '---'].join('\n');
              body = body.replace(/\| \*\*Health Check\*\* \| .* \| .* \| .* \|/, `| **Health Check** | ‚úÖ | [View Details](#health-check-placeholder) | ${ts} |`);
              body = body.includes('<!-- health-check-placeholder -->') ? body.replace('<!-- health-check-placeholder -->', section) : body.replace('---', `${section}\n\n---`);
            }
            await github.rest.issues.updateComment({
              owner: context.repo.owner, repo: context.repo.repo,
              comment_id: existing.id, body: body
            });

      - name: Help
        if: always() && steps.parse.outputs.command == 'help'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const body = [
              "### üõ†Ô∏è Operations Hub",
              "",
              "**L1 Bootstrap** (k3s, cert-manager, Platform PG, Atlantis):",
              "- `bootstrap plan`: Preview L1 changes",
              "- `bootstrap apply`: Deploy L1",
              "",
              "**L2/L3/L4** (Vault, Data, Apps - via Atlantis):",
              "- `atlantis plan`: Preview changes",
              "- `atlantis apply`: Deploy changes",
              "",
              "**Other**:",
              "- `@claude review this`: AI Code Review",
              "- `infra dig`: Health Check",
              "- `infra help`: This message"
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number || github.event.pull_request.number }},
              body: body
            });
