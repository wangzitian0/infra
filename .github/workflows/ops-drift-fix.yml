name: Ops Fix Drift

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  TF_VERSION: "1.11.0"
  WORKING_DIR: bootstrap

jobs:
  fix-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform & Secrets
        uses: ./.github/actions/terraform-setup
        with:
          secrets_json: ${{ toJSON(secrets) }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init -input=false

      - name: Import Resources
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          set +e # Allow imports to fail if already imported
          
          echo ">>> Importing Namespaces..."
          terraform import kubernetes_namespace.bootstrap bootstrap
          terraform import kubernetes_namespace.cert_manager cert-manager
          terraform import kubernetes_namespace.platform platform

          echo ">>> Importing Storage..."
          terraform import kubernetes_storage_class.local_path_retain local-path-retain
          terraform import kubernetes_config_map_v1.local_path_config kube-system/local-path-config

          echo ">>> Importing Helm Releases..."
          terraform import helm_release.cnpg_operator cnpg-system/cnpg
          terraform import helm_release.cert_manager cert-manager/cert-manager

          echo ">>> Importing Secrets..."
          terraform import kubernetes_secret.cloudflare_api_token cert-manager/cloudflare-api-token-secret
          terraform import kubernetes_secret.platform_pg_superuser platform/platform-pg-superuser
          
          echo ">>> Drift Fix Attempt Complete"
