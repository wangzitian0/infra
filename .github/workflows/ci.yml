name: Custom Commands

# Handles commands that Digger doesn't support:
# /health, /review, /e2e, /help

on:
  issue_comment:
    types: [created]

jobs:
  custom:
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '/health') ||
       contains(github.event.comment.body, '/review') ||
       contains(github.event.comment.body, '/e2e') ||
       contains(github.event.comment.body, '/help'))
    permissions:
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Run Command
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_DOMAIN: ${{ secrets.BASE_DOMAIN }}
          PYTHONPATH: ${{ github.workspace }}/0.tools
        run: |
          COMMENT="${{ github.event.comment.body }}"
          PR="${{ github.event.issue.number }}"
          
          if [[ "$COMMENT" == *"/health"* ]]; then
            python -m ci health --pr $PR
          elif [[ "$COMMENT" == *"/e2e"* ]]; then
            gh workflow run e2e-tests.yml --ref ${{ github.head_ref }}
            gh pr comment $PR --body "üß™ E2E tests triggered. [View runs](https://github.com/${{ github.repository }}/actions/workflows/e2e-tests.yml)"
          elif [[ "$COMMENT" == *"/review"* ]]; then
            gh pr comment $PR --body "üîç AI Review not yet implemented."
          elif [[ "$COMMENT" == *"/help"* ]]; then
            gh pr comment $PR --body "## üìñ Available Commands
            
            | Command | Description |
            |:---|:---|
            | \`digger plan\` | Run terraform plan |
            | \`digger apply\` | Run terraform apply |
            | \`/health\` | Service health check |
            | \`/e2e\` | Trigger E2E tests |
            | \`/review\` | AI code review |"
          fi
