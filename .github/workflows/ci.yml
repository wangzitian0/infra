name: CI Pipeline

# Unified entry point for all CI commands
# /plan, /apply ‚Üí Digger (plan/apply)
# /e2e, /review ‚Üí Custom handlers

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      command:
        description: "Command to run"
        required: true
        type: choice
        options:
          - plan
          - apply

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: write

jobs:
  # =============================================================
  # Init: Dashboard Creation (PR Only)
  # =============================================================
  init-dashboard:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    concurrency:
      group: init-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Init Dashboard
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/0.tools
        run: |
          python -m ci init --pr ${{ github.event.pull_request.number }}

  # =============================================================
  # Post-Merge: Auto Apply (Push to Main)
  # =============================================================
  post-merge:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    concurrency:
      group: post-merge-apply
      cancel-in-progress: false  # CRITICAL: Never cancel apply
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          secrets_json: ${{ toJSON(secrets) }}
      - name: Digger Apply
        id: digger
        uses: diggerhq/digger@v0.6.80
        with:
          setup-terragrunt: true
          terragrunt-version: 0.68.4
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Find Merged PR
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            // Find PR associated with this merge commit
            const commits = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });
            
            if (commits.data.length > 0) {
              const pr = commits.data[0];
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_title', pr.title);
              console.log(`Found PR #${pr.number}: ${pr.title}`);
            } else {
              console.log('No PR found for this commit');
              core.setOutput('pr_number', '');
            }

      - name: Update Merged PR
        if: always() && steps.find-pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find-pr.outputs.pr_number }};
            const status = '${{ job.status }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const commitSha = '${{ github.sha }}'.substring(0, 7);
            
            const statusIcon = status === 'success' ? '‚úÖ' : '‚ùå';
            const statusText = status === 'success' ? 'succeeded' : 'failed';
            
            const body = [
              `## üöÄ Post-Merge Apply ${statusIcon}`,
              '',
              '| Field | Value |',
              '|:---|:---|',
              `| **Status** | ${statusText} |`,
              `| **Commit** | \`${commitSha}\` |`,
              `| **Run** | [View Logs](${runUrl}) |`,
              '',
              '> This PR has been merged and the changes have been applied to production.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
            
            console.log(`Posted status to PR #${prNumber}`);

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const commitSha = '${{ github.sha }}'.substring(0, 7);
            
            // Create a commit status to mark failure
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.sha }}',
              state: 'failure',
              context: 'post-merge/apply',
              description: 'Post-merge apply failed!',
              target_url: runUrl
            });
            
            // Also create an issue for visibility
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Post-merge apply failed for ${commitSha}`,
              body: `The post-merge apply job failed.\n\n**Commit**: ${commitSha}\n**Run**: ${runUrl}\n\nPlease investigate immediately.`,
              labels: ['bug', 'priority/high']
            });

  # =============================================================
  # Digger: handles /plan, /apply, digger plan, digger apply
  # =============================================================
  digger:
    runs-on: ubuntu-latest
    concurrency:
      # Use different concurrency for apply vs plan
      group: digger-${{ contains(github.event.comment.body, '/apply') && 'apply' || 'plan' }}-${{ github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: ${{ !contains(github.event.comment.body, '/apply') }}
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       (contains(github.event.comment.body, '/plan') ||
        contains(github.event.comment.body, '/apply') ||
        contains(github.event.comment.body, 'digger plan') ||
        contains(github.event.comment.body, 'digger apply')))
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          secrets_json: ${{ toJSON(secrets) }}
          
      - name: Digger
        uses: diggerhq/digger@v0.6.80
        with:
          setup-terragrunt: true
          terragrunt-version: 0.68.4
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Dashboard
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/0.tools
        run: |
          # Determine PR Number
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR="${{ github.event.pull_request.number }}"
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            PR="${{ github.event.issue.number }}"
          else
            echo "Skipping dashboard update for event: ${{ github.event_name }}"
            exit 0
          fi

          # Determine Stage (default to plan)
          STAGE="plan"
          COMMENT="${{ github.event.comment.body }}"
          if [[ "$COMMENT" == *"/apply"* ]] || [[ "$COMMENT" == *"digger apply"* ]]; then
            STAGE="apply"
          fi
          
          STATUS="${{ job.status }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          python -m ci update --pr "$PR" --stage "$STAGE" --status "$STATUS" --link "$RUN_URL"

  # =============================================================
  # Custom: handles /e2e, /review, /help
  # =============================================================
  custom:
    runs-on: ubuntu-latest
    concurrency:
      group: custom-${{ github.event.issue.number }}
      cancel-in-progress: true
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '/e2e') ||
       contains(github.event.comment.body, '/review') ||
       contains(github.event.comment.body, '/help'))
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Run Command
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_DOMAIN: ${{ secrets.BASE_DOMAIN }}
          PYTHONPATH: ${{ github.workspace }}/0.tools
        run: |
          COMMENT="${{ github.event.comment.body }}"
          PR="${{ github.event.issue.number }}"
          
          if [[ "$COMMENT" == *"/e2e"* ]]; then
            echo "üîç Fetching branch for PR #$PR..."
            PR_BRANCH=$(gh pr view $PR --repo ${{ github.repository }} --json headRefName --jq .headRefName)
            echo "‚úÖ Found branch: $PR_BRANCH"
            
            if [[ -z "$PR_BRANCH" ]]; then
              echo "‚ùå Failed to determine branch name."
              exit 1
            fi
            
            gh workflow run e2e-tests.yml --ref "$PR_BRANCH" -f pr_number=$PR
            gh pr comment $PR --body "üß™ E2E tests triggered for branch \`$PR_BRANCH\`."
          elif [[ "$COMMENT" == *"/review"* ]]; then
            gh pr comment $PR --body "üîç AI Review not yet implemented."
          elif [[ "$COMMENT" == *"/help"* ]]; then
            gh pr comment $PR --body "## üìñ Available Commands
            
            | Command | Description |
            |:---|:---|
            | \`/plan\` | Run terraform plan |
            | \`/apply\` | Run terraform apply |
            | \`/e2e\` | Trigger E2E tests |
            | \`/review\` | AI code review |"
          fi
