name: CI Pipeline

# Unified CI entry point
# Replaces: terraform-plan.yml, post-merge-verify.yml, infra-commands.yml,
#           atlantis-acknowledge.yml, atlantis-comment-format.yml, etc.

on:
  # PR events
  pull_request:
    branches: [main]

  # Push to main (post-merge)
  push:
    branches: [main]

  # PR comment commands (/plan, /apply, /health, etc.)
  issue_comment:
    types: [created]

  # Manual trigger
  workflow_dispatch:
    inputs:
      command:
        description: "Command to run"
        required: true
        type: choice
        options:
          - plan
          - apply
          - verify
          - health
      layers:
        description: "Layers (comma-separated or 'all')"
        required: false
        default: "all"

concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  PYTHON_VERSION: "3.11"

jobs:
  # =============================================================
  # Job 1: Parse event and determine action
  # =============================================================
  parse:
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      layers: ${{ steps.parse.outputs.layers }}
      pr_number: ${{ steps.parse.outputs.pr_number }}
      should_run: ${{ steps.parse.outputs.should_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Parse Event
        id: parse
        run: |
          EVENT="${{ github.event_name }}"
          
          if [[ "$EVENT" == "pull_request" ]]; then
            echo "command=plan" >> $GITHUB_OUTPUT
            echo "layers=all" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
          
          elif [[ "$EVENT" == "push" ]]; then
            echo "command=verify" >> $GITHUB_OUTPUT
            echo "layers=all" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
          
          elif [[ "$EVENT" == "issue_comment" ]]; then
            # Only process PR comments
            if [[ -z "${{ github.event.issue.pull_request }}" ]]; then
              echo "should_run=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            COMMENT="${{ github.event.comment.body }}"
            
            # Parse using Python module
            cd 0.tools
            RESULT=$(python -m ci parse "$COMMENT" 2>/dev/null || echo "command=unknown")
            
            if echo "$RESULT" | grep -q "command=unknown"; then
              echo "should_run=false" >> $GITHUB_OUTPUT
            else
              echo "$RESULT" >> $GITHUB_OUTPUT
              echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "should_run=true" >> $GITHUB_OUTPUT
            fi
          
          elif [[ "$EVENT" == "workflow_dispatch" ]]; then
            echo "command=${{ inputs.command }}" >> $GITHUB_OUTPUT
            echo "layers=${{ inputs.layers }}" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
          
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Acknowledge (PR comment)
        if: github.event_name == 'issue_comment' && steps.parse.outputs.should_run == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

  # =============================================================
  # Job 2: CI Validate (PR only)
  # =============================================================
  validate:
    needs: parse
    if: needs.parse.outputs.should_run == 'true' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: TFLint
        uses: terraform-linters/setup-tflint@v4
      
      - run: tflint --init && tflint --recursive --minimum-failure-severity=error

  # =============================================================
  # Job 3: Execute Command
  # =============================================================
  execute:
    needs: [parse, validate]
    if: |
      always() &&
      needs.parse.outputs.should_run == 'true' &&
      (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          working_directory: "bootstrap"
          secrets_json: ${{ toJSON(secrets) }}

      - name: Execute Command
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_DOMAIN: ${{ secrets.BASE_DOMAIN }}
        run: |
          cd 0.tools
          
          CMD="${{ needs.parse.outputs.command }}"
          LAYERS="${{ needs.parse.outputs.layers }}"
          PR="${{ needs.parse.outputs.pr_number }}"
          
          ARGS=""
          if [[ -n "$PR" ]]; then
            ARGS="--pr $PR"
          fi
          
          if [[ "$CMD" == "verify" ]]; then
            ARGS="$ARGS --apply"
          fi
          
          echo "ðŸš€ Running: python -m ci $CMD $LAYERS $ARGS"
          python -m ci $CMD $LAYERS $ARGS

  # =============================================================
  # Job 4: Post-Execute (E2E, Review)
  # =============================================================
  post-execute:
    needs: [parse, execute]
    if: |
      always() &&
      needs.execute.result == 'success' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install E2E dependencies
        working-directory: e2e_regressions
        run: |
          pip install uv
          uv sync
          uv run playwright install chromium

      - name: Run E2E Tests
        working-directory: e2e_regressions
        run: uv run pytest -m smoke -v --tb=short
