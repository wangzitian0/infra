name: CI Pipeline

# æ­¤ workflow å¤„ç†:
# 1. è‡ªåŠ¨è§¦å‘: PR, Push
# 2. Bootstrap å‘½ä»¤: /check, /bootstrap-plan, /bootstrap-apply, /e2e, /help
# 3. Platform/Data å‘½ä»¤ (/plan, /apply) ç”± Digger Orchestrator å¤„ç†

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  issue_comment:
    types: [created]

env:
  PYTHON_VERSION: '3.11'
  TERRAGRUNT_VERSION: '0.68.4'

jobs:
  # ================================================================
  # /check - Format & Validate (è‡ªåŠ¨ + å‘½ä»¤)
  # ================================================================
  check:
    name: Check (fmt + validate)
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/check'))
    uses: ./.github/workflows/check.yml
  
  # ================================================================
  # /bootstrap-plan - Bootstrap Plan (è‡ªåŠ¨ + å‘½ä»¤)
  # ================================================================
  bootstrap-plan:
    name: Bootstrap Plan
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/bootstrap-plan'))
    needs: []
    uses: ./.github/workflows/bootstrap-plan.yml
    secrets: inherit
  
  # ================================================================
  # /bootstrap-apply - Bootstrap Apply (è‡ªåŠ¨ + å‘½ä»¤)
  # ================================================================
  bootstrap-apply:
    name: Bootstrap Apply
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/bootstrap-apply'))
    uses: ./.github/workflows/bootstrap-apply.yml
    secrets: inherit
  
  # ================================================================
  # /e2e - E2E Tests (è‡ªåŠ¨ + å‘½ä»¤)
  # ================================================================
  e2e:
    name: E2E Tests
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/e2e'))
    uses: ./.github/workflows/e2e.yml
    secrets: inherit
  
  # ================================================================
  # /help - Show Help
  # ================================================================
  help:
    name: Help
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/help')
    runs-on: ubuntu-latest
    steps:
      - name: Show Help
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "
          ## ğŸ“– Available Commands (7 æ€»å…±)
          
          | Command | Description | Layer | Handler |
          |---------|-------------|-------|---------|
          | \`/check\` | Format & Validate all | All | GitHub Actions |
          | \`/bootstrap-plan\` | Plan Bootstrap (L1) | Bootstrap | GitHub Actions |
          | \`/plan\` | Plan Platform/Data (L2-L4) | Digger | **Digger Orchestrator** |
          | \`/bootstrap-apply\` | Apply Bootstrap (L1) | Bootstrap | GitHub Actions |
          | \`/apply\` | Apply Platform/Data (L2-L4) | Digger | **Digger Orchestrator** |
          | \`/e2e\` | Trigger E2E Tests | Test | GitHub Actions |
          | \`/help\` | Show this message | - | GitHub Actions |
          
          ### ğŸ“Œ è¯´æ˜
          - **Bootstrap å‘½ä»¤** (\`/check\`, \`/bootstrap-*\`, \`/e2e\`, \`/help\`): ç›´æ¥åœ¨ CI Pipeline ä¸­å¤„ç†
          - **Digger å‘½ä»¤** (\`/plan\`, \`/apply\`): ç”± Digger Orchestrator (K8s) æ¥æ”¶ webhook å¹¶è§¦å‘
          
          ### âš¡ è‡ªåŠ¨è§¦å‘
          - **PR åˆ›å»º/æ›´æ–°**: è‡ªåŠ¨è¿è¡Œ \`check\`, \`bootstrap-plan\`
          - **Merge åˆ° main**: è‡ªåŠ¨è¿è¡Œ \`bootstrap-apply\`, Platform/Data apply (via Digger)
          "
  
  # ================================================================
  # æ³¨æ„: /plan å’Œ /apply ç”± digger-orchestrator.yml å¤„ç†
  # é€šè¿‡ Digger Orchestrator (K8s) webhook â†’ workflow_dispatch
  # ================================================================
