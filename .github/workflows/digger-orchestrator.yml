name: Digger Orchestrator

# 此 workflow 由 Digger Orchestrator (K8s) 通过 workflow_dispatch 触发
# 处理所有 Digger 相关的命令: /plan, /apply

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'Digger run id'
        required: false
      job:
        description: 'Job name'
        required: false
      comment_id:
        description: 'Comment id'
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: write
  statuses: write

env:
  PYTHON_VERSION: '3.11'
  TERRAGRUNT_VERSION: '0.68.4'
  KUBECONFIG_PATH: ${{ github.workspace }}/bootstrap/output/k3s-kubeconfig.yaml

jobs:
  digger:
    name: Digger (${{ inputs.job || 'default' }})
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          secrets_json: ${{ toJSON(secrets) }}
      
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INFRA_FLASH_APP_ID }}
          private-key: ${{ secrets.INFRA_FLASH_APP_KEY }}
      
      - name: Run Digger
        uses: diggerhq/digger@v0.6.138
        with:
          setup-terragrunt: true
          terragrunt-version: ${{ env.TERRAGRUNT_VERSION }}
          digger-hostname: https://digger.zitian.party
          digger-token: ${{ secrets.DIGGER_BEARER_TOKEN }}
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          KUBECONFIG: ${{ env.KUBECONFIG_PATH }}
          # Credentials for R2 Backend & Cloudflare
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_r2_bucket: ${{ secrets.R2_BUCKET }}
          TF_VAR_r2_account_id: ${{ secrets.R2_ACCOUNT_ID }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_base_domain: ${{ secrets.BASE_DOMAIN }}
          TF_VAR_vps_host: ${{ secrets.VPS_HOST }}
          TF_VAR_vps_ssh_key: ${{ secrets.VPS_SSH_KEY }}
