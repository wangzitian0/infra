name: Post-Merge Verification

# Runs full infrastructure verification after merge to main
# Flow:
# 1. Find the merged PR
# 2. L1: Direct terraform plan in GHA
# 3. L2/L3/L4: Comment `atlantis plan` on the merged PR
# 4. Wait for Atlantis result
# 5. Post summary to merged PR

on:
  push:
    branches: [main]
    paths:
      - "bootstrap/**"
      - "platform/**"
      - "envs/**"
      - "platform/**"
  workflow_dispatch:

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

jobs:
  # Find the PR that was merged
  find-merged-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.find.outputs.pr_number }}
      has_pr: ${{ steps.find.outputs.has_pr }}
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Find Merged PR
        id: find
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            if (context.eventName === 'workflow_dispatch') {
              console.log('Manual trigger - no PR context');
              core.setOutput('pr_number', '');
              core.setOutput('has_pr', 'false');
              return;
            }

            // Method 1: Parse PR number from commit message (squash-and-merge format: "... (#123)")
            const commit = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });
            const message = commit.data.commit.message;
            const prMatch = message.match(/\(#(\d+)\)/);

            if (prMatch) {
              const prNumber = prMatch[1];
              console.log(`Found PR #${prNumber} from commit message`);
              core.setOutput('pr_number', prNumber);
              core.setOutput('has_pr', 'true');
              return;
            }

            // Method 2: Fallback to API lookup (for merge commits)
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });

            const merged = prs.data.find(pr => pr.merged_at);
            if (merged) {
              console.log(`Found merged PR #${merged.number} via API`);
              core.setOutput('pr_number', merged.number.toString());
              core.setOutput('has_pr', 'true');
            } else {
              console.log('No merged PR found');
              core.setOutput('pr_number', '');
              core.setOutput('has_pr', 'false');
            }

  # L1 Bootstrap verification (direct terraform plan)
  verify-l1:
    needs: find-merged-pr
    if: needs.find-merged-pr.outputs.has_pr == 'true'
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.plan.outputs.result }}
      summary: ${{ steps.plan.outputs.summary }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Terraform Environment (L1)
        uses: ./.github/actions/terraform-setup
        with:
          working_directory: "bootstrap"
          tf_state_key: "k3s/terraform.tfstate"
          secrets_json: ${{ toJSON(secrets) }}

      - name: Terraform Plan (L1)
        id: plan
        working-directory: bootstrap
        continue-on-error: true
        run: |
          echo "Running L1 Bootstrap plan..."
          OUTPUT=$(terraform plan -no-color -detailed-exitcode 2>&1) || EXIT_CODE=$?
          EXIT_CODE=${EXIT_CODE:-0}

          # Exit codes: 0=no changes, 1=error, 2=changes pending
          if [[ $EXIT_CODE -eq 0 ]]; then
            echo "result=no_changes" >> $GITHUB_OUTPUT
            echo "summary=‚úÖ No drift" >> $GITHUB_OUTPUT
          elif [[ $EXIT_CODE -eq 2 ]]; then
            echo "result=drift" >> $GITHUB_OUTPUT
            CHANGES=$(echo "$OUTPUT" | grep -E "Plan:|to add|to change|to destroy" | head -1 || echo "Changes detected")
            echo "summary=‚ö†Ô∏è $CHANGES" >> $GITHUB_OUTPUT
          else
            echo "result=error" >> $GITHUB_OUTPUT
            ERROR=$(echo "$OUTPUT" | grep -E "Error:|error:" | head -1 || echo "Plan failed")
            echo "summary=‚ùå $ERROR" >> $GITHUB_OUTPUT
          fi

  # L2/L3/L4 verification via atlantis plan on merged PR
  verify-l234:
    needs: find-merged-pr
    if: needs.find-merged-pr.outputs.has_pr == 'true'
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.wait.outputs.result }}
      summary: ${{ steps.wait.outputs.summary }}
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Trigger Atlantis Plan
        id: trigger
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = parseInt('${{ needs.find-merged-pr.outputs.pr_number }}');
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Post atlantis plan comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `atlantis plan

              <!-- post-merge-verify: ${context.runId} -->
              üîÑ **Post-Merge Verification** triggered by [workflow run](${runUrl})`
            });

            console.log(`Triggered atlantis plan on PR #${prNumber}`);
            core.setOutput('trigger_time', new Date().toISOString());

      - name: Wait for Atlantis Result
        id: wait
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = parseInt('${{ needs.find-merged-pr.outputs.pr_number }}');
            const triggerTime = new Date('${{ steps.trigger.outputs.trigger_time }}');
            const maxWait = 10 * 60 * 1000; // 10 minutes
            const pollInterval = 15 * 1000; // 15 seconds
            const startTime = Date.now();

            console.log(`Waiting for Atlantis plan on PR #${prNumber}...`);

            let result = 'timeout';
            let summary = '‚è≥ Atlantis plan timed out';

            while (Date.now() - startTime < maxWait) {
              await new Promise(r => setTimeout(r, pollInterval));

              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                per_page: 20
              });

              // Find Atlantis response after our trigger
              const atlantisComment = comments.data
                .filter(c => new Date(c.created_at) > triggerTime)
                .find(c => c.user.login === 'infra-flash[bot]' && c.body.includes('Ran Plan'));

              if (atlantisComment) {
                const body = atlantisComment.body;
                const hasError = /\*\*Plan Error\*\*|panic:/i.test(body);
                const noChanges = /No changes\.|infrastructure matches/i.test(body);
                const hasChanges = /Plan:.*to (add|import|change|destroy)/i.test(body);

                if (hasError) {
                  result = 'error';
                  summary = '‚ùå Atlantis plan failed';
                } else if (noChanges) {
                  result = 'no_changes';
                  summary = '‚úÖ No drift';
                } else if (hasChanges) {
                  result = 'drift';
                  const match = body.match(/Plan:.*?([\d]+ to add.*?[\d]+ to destroy)/);
                  summary = `‚ö†Ô∏è ${match ? match[1] : 'Changes detected'}`;
                } else {
                  result = 'unknown';
                  summary = '‚ùì Could not parse Atlantis output';
                }

                console.log(`Atlantis plan completed: ${result}`);
                break;
              }

              console.log(`Waiting... (${Math.round((Date.now() - startTime) / 1000)}s)`);
            }

            core.setOutput('result', result);
            core.setOutput('summary', summary);

  # Post summary to merged PR
  post-results:
    needs: [find-merged-pr, verify-l1, verify-l234]
    if: always() && needs.find-merged-pr.outputs.has_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Post Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = parseInt('${{ needs.find-merged-pr.outputs.pr_number }}');
            const timestamp = new Date().toISOString().slice(0, 16).replace('T', ' ') + ' UTC';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const l1Result = '${{ needs.verify-l1.outputs.result }}' || 'skipped';
            const l1Summary = '${{ needs.verify-l1.outputs.summary }}' || '‚è≠Ô∏è Skipped';
            const l234Result = '${{ needs.verify-l234.outputs.result }}' || 'skipped';
            const l234Summary = '${{ needs.verify-l234.outputs.summary }}' || '‚è≠Ô∏è Skipped';

            const hasDrift = l1Result === 'drift' || l234Result === 'drift';
            const hasError = l1Result === 'error' || l234Result === 'error';
            const hasTimeout = l234Result === 'timeout';

            let overallIcon, overallStatus;
            if (hasError) {
              overallIcon = '‚ùå';
              overallStatus = 'Error';
            } else if (hasTimeout) {
              overallIcon = '‚è≥';
              overallStatus = 'Timeout';
            } else if (hasDrift) {
              overallIcon = '‚ö†Ô∏è';
              overallStatus = 'Drift Detected';
            } else {
              overallIcon = '‚úÖ';
              overallStatus = 'No Drift';
            }

            const statusIcon = (r) => r === 'no_changes' ? '‚úÖ' : (r === 'drift' ? '‚ö†Ô∏è' : (r === 'error' ? '‚ùå' : (r === 'timeout' ? '‚è≥' : '‚è≠Ô∏è')));

            const body = [
              `## ${overallIcon} Post-Merge Verification: ${overallStatus}`,
              '',
              '| Layer | Status | Details |',
              '|:---|:---:|:---|',
              `| L1 Bootstrap | ${statusIcon(l1Result)} | ${l1Summary} |`,
              `| L2/L3/L4 Atlantis | ${statusIcon(l234Result)} | ${l234Summary} |`,
              '',
              `**Time**: ${timestamp} | [Workflow Run](${runUrl})`,
              '',
              hasDrift ? '> ‚ö†Ô∏è **Action**: Review drift and create PR to reconcile if needed.' : '',
              hasError ? '> ‚ùå **Action**: Check logs and fix errors.' : '',
              hasTimeout ? '> ‚è≥ **Action**: Atlantis may be slow. Check Atlantis pod logs.' : '',
              !hasDrift && !hasError && !hasTimeout ? '> ‚úÖ Infrastructure state matches code.' : '',
              '',
              '---',
              'ü§ñ Generated by Post-Merge Verification'
            ].filter(Boolean).join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`Posted verification summary to PR #${prNumber}`);

            // Fail the workflow if there are errors
            if (hasError) {
              core.setFailed('Post-merge verification found errors');
            }
