name: Post-Merge Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  issues: write

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

jobs:
  find-merged-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.find.outputs.pr_number }}
      has_pr: ${{ steps.find.outputs.has_pr }}
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Find Merged PR
        id: find
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            if (context.eventName === 'workflow_dispatch') {
              core.setOutput('pr_number', '');
              core.setOutput('has_pr', 'false');
              return;
            }
            if (context.eventName === 'pull_request') {
              core.setOutput('pr_number', context.payload.pull_request.number);
              core.setOutput('has_pr', 'true');
              return;
            }
            // Simplified for debug, just basic checking...
            core.setOutput('has_pr', 'true');

  drift-scan:
    needs: find-merged-pr
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        layer: [bootstrap, platform, envs/staging/data, envs/prod/data]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          working_directory: ${{ matrix.layer }}
          tf_state_key: ${{ matrix.layer == 'bootstrap' ? 'k3s/terraform.tfstate' : '' }}
          secrets_json: ${{ toJSON(secrets) }}

      - name: Plan Layer
        id: plan
        working-directory: ${{ matrix.layer }}
        run: |
          echo "Scanning drift for ${{ matrix.layer }}..."
          if [ -f "terragrunt.hcl" ] || [ -L "terragrunt.hcl" ]; then
            terragrunt plan -no-color --terragrunt-non-interactive -detailed-exitcode || EXIT_CODE=$?
          else
            terraform plan -no-color -detailed-exitcode || EXIT_CODE=$?
          fi
          EXIT_CODE=${EXIT_CODE:-0}
          if [ $EXIT_CODE -eq 0 ]; then
             echo "No drift"
          elif [ $EXIT_CODE -eq 2 ]; then
             echo "Drift detected"
             exit 0
          else
             echo "Error"
             exit 1
          fi
