name: Post-Merge Verification

# Runs full infrastructure verification after merge to main
# Purpose: Drift detection and deployment health check
#
# Flow:
# 1. L1 (Bootstrap): Direct terraform plan in GHA
# 2. L2/L3/L4 (Atlantis): Creates drift-check PR ‚Üí Atlantis autoplan ‚Üí Close PR
# 3. Results posted to merged PR that triggered this

on:
  push:
    branches: [main]
    paths:
      - "1.bootstrap/**"
      - "2.platform/**"
      - "envs/**"
      - "4.apps/**"
      - "*.yaml"
      - "*.yml"
  schedule:
    # Daily drift check at UTC 00:00 (08:00 Beijing)
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      skip_drift_pr:
        description: "Skip creating drift-check PR for L2/L3/L4"
        type: boolean
        default: false

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

jobs:
  # Find the PR that was merged (for push events)
  find-merged-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.find.outputs.pr_number }}
      pr_url: ${{ steps.find.outputs.pr_url }}
      trigger_type: ${{ steps.find.outputs.trigger_type }}
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Find Merged PR
        id: find
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            let prNumber = '';
            let prUrl = '';
            let triggerType = '${{ github.event_name }}';

            if (triggerType === 'push') {
              // Find PR associated with this commit
              const commit = context.sha;
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commit
              });

              const merged = prs.data.find(pr => pr.merged_at);
              if (merged) {
                prNumber = merged.number.toString();
                prUrl = merged.html_url;
                console.log(`Found merged PR #${prNumber}`);
              } else {
                console.log('No merged PR found for this commit');
              }
            }

            core.setOutput('pr_number', prNumber);
            core.setOutput('pr_url', prUrl);
            core.setOutput('trigger_type', triggerType);

  # L1 Bootstrap verification (direct terraform plan)
  verify-l1:
    needs: find-merged-pr
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.plan.outputs.result }}
      summary: ${{ steps.plan.outputs.summary }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Terraform Environment (L1)
        uses: ./.github/actions/terraform-setup
        with:
          working_directory: "1.bootstrap"
          tf_state_key: "k3s/terraform.tfstate"
          secrets_json: ${{ toJSON(secrets) }}

      - name: Terraform Plan (L1)
        id: plan
        working-directory: 1.bootstrap
        continue-on-error: true
        run: |
          echo "Running L1 Bootstrap plan..."
          OUTPUT=$(terraform plan -no-color -detailed-exitcode 2>&1) || EXIT_CODE=$?
          EXIT_CODE=${EXIT_CODE:-0}

          # Exit codes: 0=no changes, 1=error, 2=changes pending
          if [[ $EXIT_CODE -eq 0 ]]; then
            echo "result=no_changes" >> $GITHUB_OUTPUT
            echo "summary=‚úÖ L1 Bootstrap: No drift detected" >> $GITHUB_OUTPUT
          elif [[ $EXIT_CODE -eq 2 ]]; then
            echo "result=drift" >> $GITHUB_OUTPUT
            CHANGES=$(echo "$OUTPUT" | grep -E "Plan:|to add|to change|to destroy" | head -3 || echo "Changes detected")
            echo "summary=‚ö†Ô∏è L1 Bootstrap: $CHANGES" >> $GITHUB_OUTPUT
          else
            echo "result=error" >> $GITHUB_OUTPUT
            echo "summary=‚ùå L1 Bootstrap: Plan failed" >> $GITHUB_OUTPUT
          fi

          echo "L1 Plan complete with exit code $EXIT_CODE"

  # L2/L3/L4 verification via drift-check PR
  verify-l234:
    needs: find-merged-pr
    if: github.event.inputs.skip_drift_pr != 'true'
    runs-on: ubuntu-latest
    outputs:
      drift_pr_number: ${{ steps.create_pr.outputs.pr_number }}
      drift_pr_url: ${{ steps.create_pr.outputs.pr_url }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app_token.outputs.token }}
          fetch-depth: 0

      - name: Create Drift-Check Branch & PR
        id: create_pr
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          BRANCH="drift-check/${TIMESTAMP}"

          # Configure git
          git config user.name "infra-flash[bot]"
          git config user.email "infra-flash[bot]@users.noreply.github.com"

          # Create branch
          git checkout -b "$BRANCH"

          # Create drift-check marker file
          echo "# Drift Check: $TIMESTAMP" > .drift-check
          echo "" >> .drift-check
          echo "Triggered by: ${{ github.event_name }}" >> .drift-check
          echo "Commit: ${{ github.sha }}" >> .drift-check
          echo "Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> .drift-check

          git add .drift-check
          git commit -m "chore(drift): automated drift check $TIMESTAMP

          Trigger: ${{ github.event_name }}
          Original commit: ${{ github.sha }}

          This PR will be auto-closed after Atlantis plan completes.
          Do NOT merge this PR."

          git push origin "$BRANCH"

          # Create PR
          PR_URL=$(gh pr create \
            --title "üîç Drift Check: $TIMESTAMP" \
            --body "$(cat <<'EOF'
          ## Automated Drift Detection

          This PR was automatically created to verify infrastructure state.

          | Info | Value |
          |:---|:---|
          | **Trigger** | ${{ github.event_name }} |
          | **Original Commit** | ${{ github.sha }} |
          | **Run** | [View](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

          ### ‚ö†Ô∏è Do NOT merge this PR

          This PR will be **automatically closed** after Atlantis completes the plan.

          ---
          ü§ñ Generated by Post-Merge Verification
          EOF
          )" \
            --base main \
            --head "$BRANCH" \
            --label "drift-check" 2>/dev/null || echo "")

          if [[ -n "$PR_URL" ]]; then
            PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "Created drift-check PR #$PR_NUMBER"
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "pr_url=" >> $GITHUB_OUTPUT
            echo "::warning::Failed to create drift-check PR"
          fi

  # Wait for Atlantis to complete plan on drift-check PR
  wait-atlantis:
    needs: [find-merged-pr, verify-l234]
    if: needs.verify-l234.outputs.drift_pr_number != ''
    runs-on: ubuntu-latest
    outputs:
      atlantis_result: ${{ steps.check.outputs.result }}
      atlantis_summary: ${{ steps.check.outputs.summary }}
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Wait for Atlantis Plan
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = parseInt('${{ needs.verify-l234.outputs.drift_pr_number }}');
            const maxWait = 10 * 60 * 1000; // 10 minutes
            const pollInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();

            console.log(`Waiting for Atlantis plan on PR #${prNumber}...`);

            let result = 'timeout';
            let summary = '‚è≥ Atlantis plan timed out';

            while (Date.now() - startTime < maxWait) {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                per_page: 50
              });

              // Look for Atlantis plan result
              const atlantisComment = comments.data.find(c =>
                c.user.login === 'infra-flash[bot]' &&
                c.body.includes('Ran Plan')
              );

              if (atlantisComment) {
                const body = atlantisComment.body;
                const hasError = /\*\*Plan Error\*\*|panic:/i.test(body);
                const noChanges = /No changes\. Your infrastructure matches the configuration/i.test(body);
                const hasChanges = /Plan:.*to (add|import|change|destroy)/i.test(body);

                if (hasError) {
                  result = 'error';
                  summary = '‚ùå L2/L3/L4: Atlantis plan failed';
                } else if (noChanges) {
                  result = 'no_changes';
                  summary = '‚úÖ L2/L3/L4: No drift detected';
                } else if (hasChanges) {
                  result = 'drift';
                  const match = body.match(/Plan:.*?([\d]+ to add.*?[\d]+ to destroy)/);
                  summary = `‚ö†Ô∏è L2/L3/L4: ${match ? match[1] : 'Changes detected'}`;
                }

                console.log(`Atlantis plan completed: ${result}`);
                break;
              }

              console.log(`Waiting... (${Math.round((Date.now() - startTime) / 1000)}s)`);
              await new Promise(r => setTimeout(r, pollInterval));
            }

            core.setOutput('result', result);
            core.setOutput('summary', summary);

  # Close drift-check PR and cleanup
  cleanup-drift-pr:
    needs: [verify-l234, wait-atlantis]
    if: always() && needs.verify-l234.outputs.drift_pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Close PR and Delete Branch
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          PR_NUMBER="${{ needs.verify-l234.outputs.drift_pr_number }}"

          # Close PR with comment
          gh pr close "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --comment "‚úÖ Drift check complete. Closing PR.

          Results posted to original merged PR.

          ---
          ü§ñ Generated by Post-Merge Verification" \
            --delete-branch || true

          echo "Closed drift-check PR #$PR_NUMBER"

  # Post summary to original merged PR
  post-results:
    needs: [find-merged-pr, verify-l1, verify-l234, wait-atlantis]
    if: always() && needs.find-merged-pr.outputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Post Results Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const prNumber = parseInt('${{ needs.find-merged-pr.outputs.pr_number }}');
            const timestamp = new Date().toISOString().slice(0, 16).replace('T', ' ') + ' UTC';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const triggerType = '${{ needs.find-merged-pr.outputs.trigger_type }}';

            // Collect results
            const l1Result = '${{ needs.verify-l1.outputs.result }}' || 'skipped';
            const l1Summary = '${{ needs.verify-l1.outputs.summary }}' || '‚è≠Ô∏è L1: Skipped';
            const l234Result = '${{ needs.wait-atlantis.outputs.atlantis_result }}' || 'skipped';
            const l234Summary = '${{ needs.wait-atlantis.outputs.atlantis_summary }}' || '‚è≠Ô∏è L2/L3/L4: Skipped';
            const driftPrUrl = '${{ needs.verify-l234.outputs.drift_pr_url }}';

            // Determine overall status
            const hasDrift = l1Result === 'drift' || l234Result === 'drift';
            const hasError = l1Result === 'error' || l234Result === 'error';
            const overallIcon = hasError ? '‚ùå' : (hasDrift ? '‚ö†Ô∏è' : '‚úÖ');
            const overallStatus = hasError ? 'Error' : (hasDrift ? 'Drift Detected' : 'No Drift');

            const body = [
              `## ${overallIcon} Post-Merge Verification: ${overallStatus}`,
              '',
              `| Layer | Status | Details |`,
              `|:---|:---:|:---|`,
              `| L1 Bootstrap | ${l1Result === 'no_changes' ? '‚úÖ' : (l1Result === 'drift' ? '‚ö†Ô∏è' : '‚ùå')} | ${l1Summary} |`,
              `| L2/L3/L4 Atlantis | ${l234Result === 'no_changes' ? '‚úÖ' : (l234Result === 'drift' ? '‚ö†Ô∏è' : (l234Result === 'skipped' ? '‚è≠Ô∏è' : '‚ùå'))} | ${l234Summary} |`,
              '',
              `| Info | Value |`,
              `|:---|:---|`,
              `| **Trigger** | ${triggerType} |`,
              `| **Time** | ${timestamp} |`,
              `| **Run** | [View Logs](${runUrl}) |`,
              driftPrUrl ? `| **Drift PR** | [View](${driftPrUrl}) (closed) |` : '',
              '',
              hasDrift ? '‚ö†Ô∏è **Action Required**: Review drift and create PR to reconcile if needed.' : '',
              hasError ? '‚ùå **Action Required**: Check logs and fix errors.' : '',
              !hasDrift && !hasError ? '‚úÖ Infrastructure state matches code. No action needed.' : '',
              '',
              '---',
              'ü§ñ Generated by Post-Merge Verification'
            ].filter(Boolean).join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`Posted verification results to PR #${prNumber}`);

  # Create issue for scheduled runs (no PR to post to)
  post-scheduled-results:
    needs: [find-merged-pr, verify-l1, verify-l234, wait-atlantis]
    if: always() && needs.find-merged-pr.outputs.pr_number == '' && github.event_name != 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Create Issue for Scheduled Run
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const timestamp = new Date().toISOString().slice(0, 16).replace('T', ' ') + ' UTC';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const l1Result = '${{ needs.verify-l1.outputs.result }}' || 'skipped';
            const l1Summary = '${{ needs.verify-l1.outputs.summary }}' || '‚è≠Ô∏è L1: Skipped';
            const l234Result = '${{ needs.wait-atlantis.outputs.atlantis_result }}' || 'skipped';
            const l234Summary = '${{ needs.wait-atlantis.outputs.atlantis_summary }}' || '‚è≠Ô∏è L2/L3/L4: Skipped';
            const driftPrUrl = '${{ needs.verify-l234.outputs.drift_pr_url }}';

            const hasDrift = l1Result === 'drift' || l234Result === 'drift';
            const hasError = l1Result === 'error' || l234Result === 'error';

            // Only create issue if there's drift or error
            if (!hasDrift && !hasError) {
              console.log('No drift or errors detected. Skipping issue creation.');
              return;
            }

            const overallIcon = hasError ? '‚ùå' : '‚ö†Ô∏è';
            const overallStatus = hasError ? 'Error' : 'Drift Detected';

            const body = [
              `## Summary`,
              '',
              `| Layer | Status | Details |`,
              `|:---|:---:|:---|`,
              `| L1 Bootstrap | ${l1Result === 'no_changes' ? '‚úÖ' : (l1Result === 'drift' ? '‚ö†Ô∏è' : '‚ùå')} | ${l1Summary} |`,
              `| L2/L3/L4 Atlantis | ${l234Result === 'no_changes' ? '‚úÖ' : (l234Result === 'drift' ? '‚ö†Ô∏è' : '‚ùå')} | ${l234Summary} |`,
              '',
              `| Info | Value |`,
              `|:---|:---|`,
              `| **Time** | ${timestamp} |`,
              `| **Run** | [View Logs](${runUrl}) |`,
              driftPrUrl ? `| **Drift PR** | [View](${driftPrUrl}) (closed) |` : '',
              '',
              '## Action Required',
              '',
              hasDrift ? '1. Review drift details in the workflow logs' : '',
              hasDrift ? '2. Create a PR to reconcile infrastructure state' : '',
              hasError ? '1. Check workflow logs for error details' : '',
              hasError ? '2. Fix the underlying issue' : '',
              '',
              '---',
              'ü§ñ Generated by Scheduled Drift Detection'
            ].filter(Boolean).join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${overallIcon} Scheduled Drift Check: ${overallStatus} (${timestamp.slice(0, 10)})`,
              body: body,
              labels: ['drift-check', 'automated']
            });

            console.log('Created issue for scheduled drift check results');
