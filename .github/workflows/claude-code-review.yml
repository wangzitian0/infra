name: Claude Code Review

on:
  # Trigger when Atlantis apply comment is posted
  issue_comment:
    types: [created]

jobs:
  claude-review:
    # Only run on PR Apply success from infra-flash bot
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'infra-flash[bot]' &&
      contains(github.event.comment.body, 'Ran Apply') &&
      contains(github.event.comment.body, 'Apply complete!')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Get PR info
        id: pr_info
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number
            });

            const headSha = pr.data.head.sha.substring(0, 7);
            core.setOutput('pr_number', context.payload.issue.number.toString());
            core.setOutput('head_sha', headSha);
            core.setOutput('head_ref', pr.data.head.ref);

            console.log(`PR #${context.payload.issue.number} - SHA: ${headSha} - Branch: ${pr.data.head.ref}`);
            return headSha;

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_info.outputs.head_ref }}
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr_info.outputs.pr_number }}

            Atlantis apply completed successfully. Review this PR for:
            - Code quality and best practices
            - Potential bugs or issues
            - Security concerns

            Use CLAUDE.md for guidance. Be concise.
            Use `gh pr comment` to post your review.

          claude_args: '--model claude-haiku-4-5 --allowed-tools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"'

      - name: Update Dashboard
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.pr_info.outputs.pr_number }}');
            const sha = '${{ steps.pr_info.outputs.head_sha }}';
            const marker = `<!-- infra-flash-commit:${sha} -->`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            const dashboard = comments.find(c => c.body.includes(marker));
            if (!dashboard) {
              console.log('Dashboard not found for ' + sha);
              return;
            }

            const status = '${{ steps.claude-review.outcome }}' === 'success' ? '✅' : '❌';
            const timestamp = new Date().toISOString().slice(11, 16) + ' UTC';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body = dashboard.body.replace(
              /\| AI Review \| .* \| .* \| .* \|/,
              `| AI Review | ${status} | [View](${runUrl}) | ${timestamp} |`
            );

            // Update next step if AI review completed successfully
            if (status === '✅') {
              body = body.replace(
                /<!-- next-step -->[\s\S]*?<!-- \/next-step -->/,
                `<!-- next-step -->\n✅ **Ready to merge!**\n<!-- /next-step -->`
              );
            }

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: dashboard.id,
              body: body
            });

            console.log(`Updated AI Review status: ${status}`);
