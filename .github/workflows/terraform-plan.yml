name: Terraform CI

on:
  pull_request:
    branches: [main]
    paths:
      - "0.tools/**"
      - "1.bootstrap/**"
      - "2.platform/**"
      - "3.data/**"
      - "4.apps/**"
      - ".github/workflows/**"

# Cancel in-progress runs for same PR
concurrency:
  group: terraform-${{ github.event.pull_request.number }}-${{ github.event.pull_request.head.sha }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

jobs:
  validate:
    name: CI Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ============================================================
      # PRE-FLIGHT: Integrity and Security
      # ============================================================
      - name: Variable Integrity Check
        run: python3 0.tools/check_integrity.py

      - name: Verify Key Format (Strict)
        run: |
          echo "${{ secrets.ATLANTIS_GH_APP_KEY }}" > atlantis_key.pem
          echo "Checking key format..."
          if ! openssl rsa -in atlantis_key.pem -check -noout; then
            echo "::error::ATLANTIS_GH_APP_KEY is corrupted in CI environment!"
            exit 1
          fi
          echo "‚úÖ Key format is valid."
          rm atlantis_key.pem

      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Create skeleton comment
        id: skeleton
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const sha = context.payload.pull_request.head.sha.substring(0, 7);
            const timestamp = new Date().toISOString().slice(11, 16) + ' UTC';
            const runUrl = "https://github.com/" + context.repo.owner + "/" + context.repo.repo + "/actions/runs/" + context.runId;
            const prUrl = "https://github.com/" + context.repo.owner + "/" + context.repo.repo + "/pull/" + context.payload.pull_request.number;
            const MARKER = "<!-- infra-flash-commit:" + sha + " -->";
            
            // Check if comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              per_page: 100
            });
            const existing = comments.data.find(c => c.body.includes(MARKER));
            
            const commandHelp = [
              '<details><summary>üìñ Available Infra Commands</summary>',
              '',
              '| Command | Description | Feedback |',
              '|:---|:---|:---|',
              '| `atlantis plan` | Re-run infrastructure plan | Append to this table |',
              '| `atlantis apply` | Deploy changes | Append to this table |',
              '| `@claude review this` | AI Code Review | New comment reply |',
              '| `infra dig` | Service Health Check | Append to dashboard |',
              '| `infra help` | Show detailed help | New reply |',
              '',
              '</details>'
            ].join('\n');

            // Full skeleton with Status Table
            const skeleton = [
              MARKER,
              "## ‚ö° Commit `" + sha + "` Dashboard",
              "",
              "| Component | Status | Info/Link | Time |",
              "|:---|:---:|:---|:---|",
              `| **Static CI** | ‚è≥ | [Running Checks...](${runUrl}) | ${timestamp} |`,
              "| **AI Review** | ‚è≥ | Pending | - |",
              "| **Infra Plan** | ‚è≥ | Pending | - |",
              "| **Infra Apply** | ‚è≠Ô∏è | - | - |",
              "| **Health Check** | ‚è≠Ô∏è | - | - |",
              "",
              "---",
              "",
              "### üõ†Ô∏è CI Validate ‚è≥ | [" + sha + "](" + runUrl + ") | " + timestamp,
              "",
              '‚è≥ Running checks...',
              "",
              "<!-- claude-review-placeholder -->",
              "",
              "---",
              "",
              "### üöÄ Atlantis Actions",
              "",
              "<!-- atlantis-actions -->",
              "| Action | Commit | Trigger | Status | Output | Time |",
              "|:-------|:-------|:--------|:------:|:-------|:-----|",
              "<!-- /atlantis-actions -->",
              "",
              "<!-- health-check-placeholder -->",
              "",
              "---",
              commandHelp,
              "",
              "---",
              "",
              "‚è≥ **Waiting for CI...**"
            ].join('\n');
            
            let commentId;
            if (existing) {
              // Preserve existing Atlantis action rows
              let body = skeleton;
              const actionsMatch = existing.body.match(/<!-- atlantis-actions -->([\s\S]*?)<!-- \/atlantis-actions -->/);
              if (actionsMatch && actionsMatch[1].trim()) {
                body = skeleton.replace(
                  /<!-- atlantis-actions -->\n| Action[\s\S]*?<!-- \/atlantis-actions -->/,
                  "<!-- atlantis-actions -->\n| Action | Commit | Trigger | Status | Output | Time |\n|:-------|:-------|:--------|:------:|:-------|:-----|" + actionsMatch[1] + "<!-- /atlantis-actions -->"
                );
              }
              
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
              commentId = existing.id;
            } else {
              const created = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: skeleton
              });
              commentId = created.data.id;
            }
            console.log("Created/updated skeleton for commit " + sha);
            return commentId.toString();

      # ============================================================
      # STEP 2: Run CI Checks
      # ============================================================
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Format Check
        id: fmt
        run: terraform fmt -check -recursive -diff
        continue-on-error: true

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: TFLint (L1)
        id: lint_l1
        working-directory: 1.bootstrap
        run: tflint --init && tflint --recursive --minimum-failure-severity=error
        continue-on-error: true

      - name: TFLint (L2)
        id: lint_l2
        working-directory: 2.platform
        run: tflint --init && tflint --recursive --minimum-failure-severity=error
        continue-on-error: true

      - name: TFLint (L3)
        id: lint_l3
        working-directory: 3.data
        run: tflint --init && tflint --recursive --minimum-failure-severity=error
        continue-on-error: true

      - name: TFLint (L4)
        id: lint_l4
        working-directory: 4.apps
        run: tflint --init && tflint --recursive --minimum-failure-severity=error
        continue-on-error: true

      - name: Pre-flight Check (Helm URLs)
        run: |
          chmod +x 0.tools/preflight-check.sh
          0.tools/preflight-check.sh

      - name: Validate (L1)
        id: validate_l1
        working-directory: 1.bootstrap
        run: terraform init -backend=false -input=false -no-color && terraform validate -no-color
        continue-on-error: true

      - name: Validate (L2)
        id: validate_l2
        working-directory: 2.platform
        run: terraform init -backend=false -input=false -no-color && terraform validate -no-color
        continue-on-error: true

      - name: Validate (L3)
        id: validate_l3
        working-directory: 3.data
        run: terraform init -backend=false -input=false -no-color && terraform validate -no-color
        continue-on-error: true

      - name: Validate (L4)
        id: validate_l4
        working-directory: 4.apps
        run: terraform init -backend=false -input=false -no-color && terraform validate -no-color
        continue-on-error: true

      # ========================================== 
      # STEP 3: Update comment with results
      # ========================================== 
      - name: Update comment with results
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fmt = '${{ steps.fmt.outcome }}' || 'skipped';
            const lint_l1 = '${{ steps.lint_l1.outcome }}' || 'skipped';
            const lint_l2 = '${{ steps.lint_l2.outcome }}' || 'skipped';
            const lint_l3 = '${{ steps.lint_l3.outcome }}' || 'skipped';
            const lint_l4 = '${{ steps.lint_l4.outcome }}' || 'skipped';
            const validate_l1 = '${{ steps.validate_l1.outcome }}' || 'skipped';
            const validate_l2 = '${{ steps.validate_l2.outcome }}' || 'skipped';
            const validate_l3 = '${{ steps.validate_l3.outcome }}' || 'skipped';
            const validate_l4 = '${{ steps.validate_l4.outcome }}' || 'skipped';
            
            const icon = (s) => s === 'success' ? '‚úÖ' : (s === 'skipped' ? '‚è≠Ô∏è' : '‚ùå');
            const allPass = [fmt, lint_l1, lint_l2, lint_l3, lint_l4, validate_l1, validate_l2, validate_l3, validate_l4]
              .every(s => s === 'success' || s === 'skipped');
            const sha = context.payload.pull_request.head.sha.substring(0, 7);
            const timestamp = new Date().toISOString().slice(11, 16) + ' UTC';
            const runUrl = "https://github.com/" + context.repo.owner + "/" + context.repo.repo + "/actions/runs/" + context.runId;
            const commentId = ${{ steps.skeleton.outputs.result }};
            const MARKER = "<!-- infra-flash-commit:" + sha + " -->";
            
            // Get existing comment
            const existingComment = await github.rest.issues.getComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId
            });
            
            // CI section: only show error link if failed
            let ciDetails = "";
            let statusIcon = icon(allPass);
            if (!allPass) {
              ciDetails = [
                '---',
                `### ‚ùå Static CI Failed`,
                `> Detailed logs and fix commands: [View Run Log](${runUrl})`,
                '---'
              ].join('\n');
            }
            
            // Check if TF files were changed
            const changedFiles = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100
            });
            const hasTfChanges = changedFiles.data.some(f => 
              /^[1-4]\.(bootstrap|platform|data|apps)\/.*\.tf$/.test(f.filename)
            );
            
            let nextStep;
            if (!allPass) {
              nextStep = 'üëâ **Recommended Next Step:** ‚ùå **CI failed.** Fix errors and push again.';
            } else if (hasTfChanges) {
              nextStep = 'üëâ **Recommended Next Step:** ‚è≥ **Waiting for Atlantis autoplan...** (Then comment `atlantis apply`)';
            } else {
              nextStep = 'üëâ **Recommended Next Step:** ‚úÖ **No Terraform changes.** Ready to merge!';
            }
            
            let body = existingComment.data.body;

            // 1. Update Status Table Row for CI
            body = body.replace(
              /\| \*\*Static CI\*\* \| .* \| .* \| .* \|/,
              `| **Static CI** | ${statusIcon} | [View Run](${runUrl}) | ${timestamp} |`
            );

            // 2. Update Details Section
            const ciHeader = "### üõ†Ô∏è CI Validate";
            const reviewPlaceholder = "<!-- copilot-review-placeholder -->";
            
            if (body.includes(ciHeader)) {
               // Replace from header until the next HR or placeholder
               const regex = /### üõ†Ô∏è CI Validate [\s\S]*?---\n/;
               body = body.replace(regex, ciDetails ? ciDetails + "\n" : "");
            } else if (ciDetails) {
               // Prepend before Review placeholder if failed
               body = body.replace(reviewPlaceholder, `${ciDetails}\n\n${reviewPlaceholder}`);
            }
            
            // Clean up double HRs that might occur during healing/replacement
            body = body.replace(/---\n\n---/g, '---\n');

            // 3. Update Next Step
            const nextStepPattern = /üëâ \*\*Recommended Next Step:\*\*.*|‚è≥ \*\*Waiting for CI\.\.\.\*\*/;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });
            console.log("Updated comment: CI " + (allPass ? 'PASS' : 'FAIL'));

      # ============================================================
      # Final Status
      # ============================================================
      - name: Check Results
        run: |
          FAILED=0
          [[ "${{ steps.fmt.outcome }}" != "success" ]] && echo "‚ùå Format check failed" && FAILED=1
          [[ "${{ steps.lint_l1.outcome }}" != "success" ]] && echo "‚ùå L1 lint failed" && FAILED=1
          [[ "${{ steps.lint_l2.outcome }}" != "success" ]] && echo "‚ùå L2 lint failed" && FAILED=1
          [[ "${{ steps.lint_l3.outcome }}" != "success" ]] && echo "‚ùå L3 lint failed" && FAILED=1
          [[ "${{ steps.lint_l4.outcome }}" != "success" ]] && echo "‚ùå L4 lint failed" && FAILED=1
          [[ "${{ steps.validate_l1.outcome }}" != "success" ]] && echo "‚ùå L1 validate failed" && FAILED=1
          [[ "${{ steps.validate_l2.outcome }}" != "success" ]] && echo "‚ùå L2 validate failed" && FAILED=1
          [[ "${{ steps.validate_l3.outcome }}" != "success" ]] && echo "‚ùå L3 validate failed" && FAILED=1
          [[ "${{ steps.validate_l4.outcome }}" != "success" ]] && echo "‚ùå L4 validate failed" && FAILED=1
          
          if [[ $FAILED -eq 1 ]]; then
            echo "::error::CI validation failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed"