##########################################################################
# DO NOT MODIFY
#
# THIS FILE SHOULD LIVE IN .github/workflows/terrateam.yml
#
# Looking for the Terrateam configuration file? .terrateam/config.yml.
#
# See https://terrateam.io/docs
##########################################################################
name: 'Terrateam Workflow'
on:
  workflow_dispatch:
    inputs:
      # The work-token and api-base-url are automatically passed in by the Terrateam backend
      work-token:
        description: 'Work Token'
        required: true
      api-base-url:
        description: 'API Base URL'
      environment:
        description: 'Environment in which to run the action'
        type: environment
      runs_on:
        description: 'runs-on configuration'
        type: string
        default: '"ubuntu-latest"'
jobs:
  terrateam:
    permissions:
      id-token: write
      contents: read
    runs-on: ${{ fromJSON(github.event.inputs.runs_on) }}
    timeout-minutes: 1440
    name: Terrateam Action
    environment: '${{ github.event.inputs.environment }}'
    steps:
      - uses: actions/checkout@v4
      
      # Restore Logic: Setup SSH and Fetch Kubeconfig (Critical for Helm Provider)
      - name: Setup SSH & Fetch Kubeconfig
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          CLUSTER_NAME: ${{ secrets.K3S_CLUSTER_NAME }}
        run: |
          set -euo pipefail
          
          # 1. Setup SSH
          mkdir -p ~/.ssh
          echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${VPS_SSH_PORT:-22}" "$VPS_HOST" >> ~/.ssh/known_hosts
          
          # 2. Fetch Kubeconfig
          echo "Fetching kubeconfig from VPS..."
          KUBECONFIG_PATH="${{ github.workspace }}/terraform/output/${CLUSTER_NAME}-kubeconfig.yaml"
          mkdir -p "$(dirname "$KUBECONFIG_PATH")"
          
          if ssh -i ~/.ssh/id_rsa -p "${VPS_SSH_PORT:-22}" -o StrictHostKeyChecking=no "root@$VPS_HOST" "sudo cat /etc/rancher/k3s/k3s.yaml" > "$KUBECONFIG_PATH"; then
             echo "Kubeconfig fetched."
             # Replace localhost with VPS IP
             sed -i "s/127.0.0.1/$VPS_HOST/g" "$KUBECONFIG_PATH"
             chmod 600 "$KUBECONFIG_PATH"
          else
             echo "Warning: Could not fetch kubeconfig. This is normal for first-time bootstrap."
             rm -f "$KUBECONFIG_PATH" || true
          fi

      - name: Run Terrateam Action
        id: terrateam
        uses: terrateamio/action@v1
        with:
          work-token: '${{ github.event.inputs.work-token }}'
          api-base-url: '${{ github.event.inputs.api-base-url }}'
        env:
          # Backend Params
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          
          # Terraform Variables (Explicit Mapping)
          TF_VAR_vps_host: ${{ secrets.VPS_HOST }}
          TF_VAR_ssh_private_key: ${{ secrets.VPS_SSH_KEY }}
          TF_VAR_ssh_port: ${{ secrets.VPS_SSH_PORT }}
          TF_VAR_cluster_name: ${{ secrets.K3S_CLUSTER_NAME }}
          TF_VAR_api_endpoint: ${{ secrets.K3S_API_ENDPOINT }}
          TF_VAR_k3s_channel: ${{ secrets.K3S_CHANNEL }}
          TF_VAR_k3s_version: ${{ secrets.K3S_VERSION }}
          TF_VAR_infisical_postgres_password: ${{ secrets.INFISICAL_POSTGRES_PASSWORD }}
          
          SECRETS_CONTEXT: ${{ toJson(secrets) }}
          VARIABLES_CONTEXT: ${{ toJson(vars) }}
