name: Format Atlantis Comments

on:
  issue_comment:
    types: [created]

jobs:
  format:
    # Only process Atlantis plan/apply comments on PRs
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'infra-flash[bot]' &&
      (contains(github.event.comment.body, 'Ran Plan') ||
       contains(github.event.comment.body, 'Ran Apply'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Format comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const commentId = context.payload.comment.id;
            const body = context.payload.comment.body;

            // Only format "Ran Plan" comments (not "Ran Apply")
            if (!body.includes('Ran Plan')) {
              console.log('Not a plan comment, skipping format');
              return;
            }

            // Extract components
            const lines = body.split('\n');
            const header = lines[0]; // "Ran Plan for project: ..."

            // Find the terraform diff section
            const diffStartIdx = lines.findIndex(l => l.includes('<details><summary>Show Output</summary>'));
            const diffEndIdx = lines.findIndex(l => l.includes('</details>'));

            if (diffStartIdx === -1 || diffEndIdx === -1) {
              console.log('Cannot find diff section, skipping format');
              return;
            }

            // Extract diff content (everything between ```diff and ```)
            const diffSection = lines.slice(diffStartIdx, diffEndIdx + 1).join('\n');

            // Extract plan summary (e.g., "Plan: 8 to add, 0 to change, 0 to destroy")
            const planSummaryMatch = body.match(/Plan: (\d+) to add, (\d+) to change, (\d+) to destroy/);
            const planSummary = planSummaryMatch ? planSummaryMatch[0] : '';

            // Extract action commands section (everything after </details>)
            const actionsSection = lines.slice(diffEndIdx + 1).join('\n');

            // Rebuild comment with better structure
            const formattedBody = [
              header,
              '',
              planSummary ? `**${planSummary}**` : '',
              '',
              diffSection,
              '',
              '<details><summary>ðŸ“‹ Available Actions</summary>',
              '',
              actionsSection.trim(),
              '',
              '</details>'
            ].filter(Boolean).join('\n');

            // Update comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: formattedBody
            });

            console.log('Comment formatted successfully');
