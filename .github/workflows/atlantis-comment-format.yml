name: Format Atlantis Comments

on:
  issue_comment:
    types: [created]

jobs:
  format:
    # Only process Atlantis plan/apply comments on PRs
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'infra-flash[bot]' &&
      (contains(github.event.comment.body, 'Ran Plan') ||
       contains(github.event.comment.body, 'Ran Apply'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Format comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const commentId = context.payload.comment.id;
            const body = context.payload.comment.body;
            const prNumber = context.payload.issue.number;

            const isPlan = body.includes('Ran Plan');
            const isApply = body.includes('Ran Apply');
            const stage = isPlan ? 'Plan' : 'Apply';

            // Find trigger comment
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            const atlantisTime = new Date(context.payload.comment.created_at);
            const triggerComment = comments
              .filter(c => new Date(c.created_at) < atlantisTime)
              .filter(c => (c.body || '').toLowerCase().includes(`atlantis ${stage.toLowerCase()}`))
              .pop();

            // Extract location info from header: "Ran Plan for project: `xxx` dir: `xxx` workspace: `xxx`"
            const projectMatch = body.match(/project: `([^`]+)`/);
            const dirMatch = body.match(/dir: `([^`]+)`/);
            const workspaceMatch = body.match(/workspace: `([^`]+)`/);

            const project = projectMatch ? projectMatch[1] : 'unknown';
            const dir = dirMatch ? dirMatch[1] : 'unknown';
            const workspace = workspaceMatch ? workspaceMatch[1] : 'default';

            // Check for errors
            const hasError = /\*\*(Plan|Apply) Error\*\*|exit status [1-9]|panic:|terraform:.*failed/i.test(body);
            const isSuccess = !hasError;

            // Extract plan summary
            const summaryMatch = body.match(/Plan: (\d+) to (add|import), (\d+) to change, (\d+) to destroy/);
            const planSummary = summaryMatch ? summaryMatch[0] : '';

            // Find output section
            const lines = body.split('\n');
            const diffStartIdx = lines.findIndex(l => l.includes('<details><summary>Show Output</summary>'));
            const diffEndIdx = lines.findIndex((l, i) => i > diffStartIdx && l.includes('</details>'));

            if (diffStartIdx === -1) {
              console.log('Cannot find output section, skipping format');
              return;
            }

            // Extract raw output content (without the details wrapper)
            const outputContent = lines.slice(diffStartIdx + 1, diffEndIdx).join('\n');

            // Build trigger reference
            const triggerRef = triggerComment
              ? `[@${triggerComment.user.login.replace('[bot]', '')}](${triggerComment.html_url})`
              : 'autoplan';

            // Build status header - most important info first
            const statusIcon = isSuccess ? '‚úÖ' : '‚ùå';
            const statusText = isSuccess ? 'Succeeded' : 'Failed';
            const header = `## ${statusIcon} ${stage} ${statusText}`;

            // Build next step guidance
            let nextStep;
            if (isPlan && isSuccess) {
              nextStep = `\`\`\`\natlantis apply -p ${project}\n\`\`\``;
            } else if (isPlan && !isSuccess) {
              nextStep = 'Fix errors below, then run `atlantis plan`';
            } else if (isApply && isSuccess) {
              nextStep = 'Ready to merge!';
            } else {
              nextStep = 'Fix errors below, then re-run `atlantis plan`';
            }

            // Rebuild comment with UX-focused structure:
            // 1. Status (most visible)
            // 2. Location info (structured)
            // 3. Next step (actionable, visible)
            // 4. Details (folded)
            const formattedBody = [
              header,
              '',
              '| | |',
              '|:---|:---|',
              `| **Project** | \`${project}\` |`,
              `| **Dir** | \`${dir}\` |`,
              `| **Workspace** | \`${workspace}\` |`,
              `| **Triggered by** | ${triggerRef} |`,
              '',
              planSummary ? `**${planSummary}**` : '',
              '',
              '### üí° Next Step',
              nextStep,
              '',
              '<details><summary>üìú Output</summary>',
              '',
              outputContent,
              '',
              '</details>'
            ].filter(Boolean).join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: formattedBody
            });

            console.log('Comment formatted');
