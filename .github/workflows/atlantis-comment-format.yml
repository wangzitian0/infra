name: Format Atlantis Comments

on:
  issue_comment:
    types: [created]

jobs:
  format:
    # Only process Atlantis plan/apply comments on PRs
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'infra-flash[bot]' &&
      (contains(github.event.comment.body, 'Ran Plan') ||
       contains(github.event.comment.body, 'Ran Apply'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ATLANTIS_GH_APP_ID }}
          private-key: ${{ secrets.ATLANTIS_GH_APP_KEY }}

      - name: Format comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const commentId = context.payload.comment.id;
            const body = context.payload.comment.body;
            const prNumber = context.payload.issue.number;

            const isPlan = body.includes('Ran Plan');
            const isApply = body.includes('Ran Apply');
            const stage = isPlan ? 'Plan' : 'Apply';

            // Find trigger comment
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            const atlantisTime = new Date(context.payload.comment.created_at);
            const triggerComment = comments
              .filter(c => new Date(c.created_at) < atlantisTime)
              .filter(c => (c.body || '').toLowerCase().includes(`atlantis ${stage.toLowerCase()}`))
              .pop();

            // Extract components
            const lines = body.split('\n');
            const header = lines[0]; // "Ran Plan for project: ..."

            // Extract plan summary
            const summaryMatch = body.match(/Plan: (\d+) to (add|import), (\d+) to change, (\d+) to destroy/);
            const planSummary = summaryMatch ? summaryMatch[0] : '';

            // Find diff section
            const diffStartIdx = lines.findIndex(l => l.includes('<details><summary>Show Output</summary>'));
            const diffEndIdx = lines.findIndex((l, i) => i > diffStartIdx && l.includes('</details>'));

            if (diffStartIdx === -1) {
              console.log('Cannot find diff section, skipping format');
              return;
            }

            const diffSection = lines.slice(diffStartIdx, diffEndIdx + 1).join('\n');

            // Build trigger reference
            let triggerRef = '';
            if (triggerComment) {
              const username = triggerComment.user.login.replace('[bot]', '');
              triggerRef = `**Triggered by:** [@${username}](${triggerComment.html_url})`;
            } else {
              triggerRef = '**Triggered by:** autoplan on push';
            }

            // Rebuild comment - compact format
            const formattedBody = [
              header,
              '',
              triggerRef,
              '',
              planSummary ? `**${planSummary}**` : '',
              '',
              diffSection,
              '',
              '<details><summary>ðŸ“‹ Actions</summary>',
              '',
              isPlan
                ? '```\natl apply -p ' + (body.match(/project: `([^`]+)`/) || ['', 'apps'])[1] + '\n```'
                : 'âœ… Apply complete',
              '',
              '</details>'
            ].filter(Boolean).join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: formattedBody
            });

            console.log('Comment formatted');
