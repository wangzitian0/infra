name: "Terraform Setup"
description: "Sets up Terraform with high-reliability guardrails"
inputs:
  terraform_version:
    description: "Terraform version to use (reads from .terraform-version if not set)"
    required: false
    default: ""
  secrets_json:
    description: "All GitHub Secrets in JSON format"
    required: true
  tf_state_key:
    description: "Terraform state file key in R2 bucket"
    required: false
    default: "terraform.tfstate"
  working_directory:
    description: "Working directory for Terraform operations"
    required: false
    default: "1.bootstrap"

runs:
  using: "composite"
  steps:
    - name: Determine Terraform Version
      id: tf_version
      shell: bash
      run: |
        if [ -n "${{ inputs.terraform_version }}" ]; then
          echo "version=${{ inputs.terraform_version }}" >> $GITHUB_OUTPUT
        elif [ -f ".terraform-version" ]; then
          echo "version=$(cat .terraform-version | tr -d '[:space:]')" >> $GITHUB_OUTPUT
        else
          echo "::error::No terraform version specified and .terraform-version not found"
          exit 1
        fi
        echo "Using Terraform version: $(cat $GITHUB_OUTPUT | grep version | cut -d= -f2)"

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ steps.tf_version.outputs.version }}
        terraform_wrapper: false

    - name: Load Secrets (Python Loader)
      shell: bash
      env:
        INPUT_SECRETS_JSON: ${{ inputs.secrets_json }}
      run: python3 0.tools/ci_load_secrets.py

    - name: Fail-Fast Env Check
      shell: bash
      run: |
        # Verify that critical variables are actually present in the shell environment
        CRITICAL="AWS_ACCESS_KEY_ID R2_BUCKET VPS_HOST TF_VAR_vault_address"
        FAILED=0
        for VAR in $CRITICAL; do
          if [ -z "${!VAR}" ]; then
            echo "::error::ç†”æ–­ï¼šå˜é‡ $VAR æ³¨å…¥å¤±è´¥ï¼å¯èƒ½æ˜¯ Composite Action ä½œç”¨åŸŸé—®é¢˜ã€‚"
            FAILED=1
          fi
        done
        if [ $FAILED -eq 1 ]; then exit 1; fi
        echo "âœ… çŽ¯å¢ƒæ£€æŸ¥é€šè¿‡ï¼šæ‰€æœ‰æ ¸å¿ƒå˜é‡å·²å°±ç»ªã€‚"

    - name: Install Terragrunt
      shell: bash
      run: |
        TERRAGRUNT_VERSION="0.96.1"
        if command -v terragrunt &> /dev/null; then
          echo "Terragrunt already installed: $(terragrunt --version)"
        else
          echo "Installing Terragrunt v${TERRAGRUNT_VERSION}..."
          wget -q -O /usr/local/bin/terragrunt \
            "https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64"
          chmod +x /usr/local/bin/terragrunt
          echo "âœ… Terragrunt installed: $(terragrunt --version)"
        fi

    - name: Setup SSH
      shell: bash
      run: |
        set -euo pipefail
        HOST="${VPS_HOST:-}"
        PORT="${VPS_SSH_PORT:-22}"
        KEY="${VPS_SSH_KEY:-}"
        if [ -n "$HOST" ] && [ -n "$KEY" ]; then
          mkdir -p ~/.ssh
          echo "$KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "$PORT" "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
        fi

    - name: Terraform/Terragrunt init
      working-directory: ${{ inputs.working_directory }}
      shell: bash
      env:
        STATE_KEY: ${{ inputs.tf_state_key }}
      run: |
        set -euo pipefail
        
        # Check if this layer uses Terragrunt (presence of terragrunt.hcl or symlink to one)
        if [ -f "terragrunt.hcl" ] || [ -L "terragrunt.hcl" ]; then
          echo "ðŸŒ¿ Detected Terragrunt project, using terragrunt init"
          # Terragrunt auto-generates backend.tf from root config
          TG_NON_INTERACTIVE=true terragrunt init
        else
          echo "ðŸ”§ Detected native Terraform project, using terraform init"
          # L1 bootstrap uses native Terraform with manual backend config
          terraform init -input=false \
            -backend-config="bucket=${R2_BUCKET}" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="endpoints={s3=\"https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com\"}"
        fi

    - name: Fetch kubeconfig
      shell: bash
      run: |
        set -euo pipefail
        HOST="${VPS_HOST:-}"
        PORT="${VPS_SSH_PORT:-22}"
        CLUSTER="${K3S_CLUSTER_NAME:-truealpha-k3s}"
        if [ -z "$HOST" ]; then exit 0; fi
        KUBECONFIG_PATH="${GITHUB_WORKSPACE}/1.bootstrap/output/${CLUSTER}-kubeconfig.yaml"
        mkdir -p "$(dirname "${KUBECONFIG_PATH}")"
        if ssh -i ~/.ssh/id_rsa -p "${PORT}" -o StrictHostKeyChecking=no "root@${HOST}" "sudo cat /etc/rancher/k3s/k3s.yaml" > "${KUBECONFIG_PATH}" 2>/dev/null; then
          sed -i "s/127.0.0.1/${HOST}/g" "${KUBECONFIG_PATH}"
          chmod 600 "${KUBECONFIG_PATH}"
          echo "KUBECONFIG_PATH=${KUBECONFIG_PATH}" >> "${GITHUB_ENV}"
          echo "TF_VAR_kubeconfig_path=${KUBECONFIG_PATH}" >> "${GITHUB_ENV}"
        fi
