name: "Terraform Setup"
description: "Sets up Terraform, loads secrets via Python, configures SSH, and fetches kubeconfig"
inputs:
  terraform_version:
    description: "Terraform version to use"
    required: true
    default: "1.6.6"
  secrets_json:
    description: "All GitHub Secrets in JSON format (from toJSON(secrets))"
    required: true
  tf_state_key:
    description: "Terraform state file key in R2 bucket"
    required: false
    default: "terraform.tfstate"
  working_directory:
    description: "Working directory for Terraform operations"
    required: false
    default: "1.bootstrap"

runs:
  using: "composite"
  steps:
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform_version }}
        terraform_wrapper: false

    - name: Load and Map Secrets (Python)
      shell: bash
      env:
        INPUT_SECRETS_JSON: ${{ inputs.secrets_json }}
      run: |
        python3 0.tools/ci_load_secrets.py

    - name: Setup SSH and Directory
      shell: bash
      run: |
        set -euo pipefail
        
        # Use safe substitution for optional variables to prevent set -u crashes
        HOST="${VPS_HOST:-}"
        PORT="${VPS_SSH_PORT:-22}"
        KEY="${VPS_SSH_KEY:-}"
        
        if [ -z "$HOST" ] || [ -z "$KEY" ]; then
          echo "::warning::VPS_HOST or VPS_SSH_KEY missing. Skipping SSH setup."
        else
          mkdir -p ~/.ssh
          echo "$KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "$PORT" "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
        fi
        
        mkdir -p "${{ inputs.working_directory }}"

    - name: Terraform init
      working-directory: ${{ inputs.working_directory }}
      shell: bash
      env:
        STATE_KEY: ${{ inputs.tf_state_key }}
      run: |
        set -euo pipefail
        # Backend config requires these. If Python script failed, they will be empty strings.
        terraform init -input=false \
          -backend-config="bucket=${R2_BUCKET}" \
          -backend-config="key=${STATE_KEY}" \
          -backend-config="endpoints={s3=\"https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com\"}"

    - name: Fetch kubeconfig
      shell: bash
      run: |
        set -euo pipefail
        
        HOST="${VPS_HOST:-}"
        PORT="${VPS_SSH_PORT:-22}"
        CLUSTER="${K3S_CLUSTER_NAME:-truealpha-k3s}"
        
        if [ -z "$HOST" ]; then
          echo "::warning::VPS_HOST missing. Cannot fetch kubeconfig."
          exit 0
        fi

        KUBECONFIG_PATH="${GITHUB_WORKSPACE}/1.bootstrap/output/${CLUSTER}-kubeconfig.yaml"
        mkdir -p "$(dirname "${KUBECONFIG_PATH}")"
        
        echo "Attempting to fetch kubeconfig from VPS..."
        if ssh -i ~/.ssh/id_rsa -p "${PORT}" -o StrictHostKeyChecking=no "root@${HOST}" "sudo cat /etc/rancher/k3s/k3s.yaml" > "${KUBECONFIG_PATH}" 2>/dev/null; then
          echo "Kubeconfig fetched successfully."
          sed -i "s/127.0.0.1/${HOST}/g" "${KUBECONFIG_PATH}"
          chmod 600 "${KUBECONFIG_PATH}"
          echo "KUBECONFIG_PATH=${KUBECONFIG_PATH}" >> "${GITHUB_ENV}"
          echo "TF_VAR_kubeconfig_path=${KUBECONFIG_PATH}" >> "${GITHUB_ENV}"
        else
          echo "Warning: Failed to fetch kubeconfig. This is expected if the cluster is not yet deployed."
          rm -f "${KUBECONFIG_PATH}"
        fi